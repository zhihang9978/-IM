# Keepalived配置示例
# 用途: 实现主备服务器自动故障转移
# 位置: /etc/keepalived/keepalived.conf

#===============================================================================
# 主服务器配置 (154.40.45.121)
#===============================================================================

# vrrp_script check_backend {
#     script "/opt/lanxin/bin/check_backend.sh"  # 健康检查脚本
#     interval 3                                  # 每3秒检查一次
#     weight -20                                  # 失败时降低20优先级
#     fall 2                                      # 连续失败2次判定为down
#     rise 2                                      # 连续成功2次判定为up
# }
# 
# vrrp_instance VI_1 {
#     state MASTER                                # 主服务器
#     interface eth0                              # 网卡名称（根据实际修改）
#     virtual_router_id 51                        # 虚拟路由ID（主备必须一致）
#     priority 100                                # 优先级（主服务器设置更高）
#     advert_int 1                                # 通告间隔
#     authentication {
#         auth_type PASS
#         auth_pass lanxin2025                    # 认证密码（主备必须一致）
#     }
#     virtual_ipaddress {
#         154.40.45.200/24                        # 虚拟IP地址
#     }
#     track_script {
#         check_backend                           # 调用健康检查脚本
#     }
# }

#===============================================================================
# 备份服务器配置 (154.40.45.98)
#===============================================================================

# vrrp_script check_backend {
#     script "/opt/lanxin/bin/check_backend.sh"
#     interval 3
#     weight -20
#     fall 2
#     rise 2
# }
# 
# vrrp_instance VI_1 {
#     state BACKUP                                # 备份服务器
#     interface eth0
#     virtual_router_id 51
#     priority 90                                 # 优先级比主服务器低
#     advert_int 1
#     authentication {
#         auth_type PASS
#         auth_pass lanxin2025
#     }
#     virtual_ipaddress {
#         154.40.45.200/24                        # 与主服务器相同的虚拟IP
#     }
#     track_script {
#         check_backend
#     }
# }

#===============================================================================
# 健康检查脚本 (/opt/lanxin/bin/check_backend.sh)
#===============================================================================

# #!/bin/bash
# # 检查后端服务是否正常运行
# 
# # 方法1: 检查端口
# nc -z localhost 8080
# if [ $? -eq 0 ]; then
#   exit 0  # 服务正常
# fi
# 
# # 方法2: HTTP健康检查
# curl -f http://localhost:8080/health > /dev/null 2>&1
# if [ $? -eq 0 ]; then
#   exit 0  # 服务正常
# else
#   exit 1  # 服务异常
# fi

#===============================================================================
# 使用说明
#===============================================================================

# 1. 在主服务器和备份服务器安装Keepalived
#    apt install keepalived -y
#
# 2. 复制对应的配置到 /etc/keepalived/keepalived.conf
#
# 3. 创建健康检查脚本
#    cp check_backend.sh /opt/lanxin/bin/
#    chmod +x /opt/lanxin/bin/check_backend.sh
#
# 4. 启动Keepalived
#    systemctl start keepalived
#    systemctl enable keepalived
#
# 5. 验证虚拟IP
#    ip addr show  # 应该能看到154.40.45.200
#
# 6. 测试故障转移
#    停止主服务器的后端服务，虚拟IP应该自动飘移到备份服务器

#===============================================================================
# 注意事项
#===============================================================================

# 1. 确保主备服务器网络互通
# 2. 确保防火墙允许VRRP协议（协议号112）
# 3. 虚拟IP必须在同一网段
# 4. 健康检查脚本必须可执行
# 5. 主备服务器时间同步（使用NTP）

