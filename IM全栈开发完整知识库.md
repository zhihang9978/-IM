# IMå³æ—¶é€šè®¯ç³»ç»Ÿå…¨æ ˆå¼€å‘å®Œæ•´çŸ¥è¯†åº“
## å”¯ä¸€æ•´åˆæ–‡æ¡£ | åŒ…å«æ‰€æœ‰çŸ¥è¯† | AIè®­ç»ƒ + ç³»ç»Ÿå­¦ä¹ 

> **æ–‡æ¡£è¯´æ˜**ï¼šè¿™æ˜¯å®Œæ•´çš„æ•´åˆæ–‡æ¡£ï¼ŒåŒ…å«35000+è¡Œå®Œæ•´å†…å®¹ï¼Œæ•´åˆäº†æ‰€æœ‰IMå¼€å‘çŸ¥è¯†ï¼Œæ— ä»»ä½•åˆ å‡ã€‚åŒ…å«26ä¸ªå®Œæ•´ç« èŠ‚ï¼Œ10+ä¸ªIMæ–¹æ¡ˆï¼Œ700+ä»£ç ç¤ºä¾‹ã€‚å¯ç”¨äºAIè®­ç»ƒæˆ–äººç±»ç³»ç»Ÿå­¦ä¹ ã€‚

---

# ğŸ“‹ ä½¿ç”¨è¯´æ˜

## ğŸŒ é€‚ç”¨æ‰€æœ‰AIå¹³å°

æœ¬æ–‡æ¡£å¯ç”¨äºè®­ç»ƒï¼š
- âœ… **å›½é™…AI**ï¼šChatGPTã€Claudeã€Geminiã€Perplexity
- âœ… **å›½å†…AI**ï¼šæ–‡å¿ƒä¸€è¨€ã€é€šä¹‰åƒé—®ã€è®¯é£æ˜Ÿç«ã€æ™ºè°±ChatGLMã€ç™¾å·ã€MiniMax
- âœ… **å¼€æºAI**ï¼šLlamaã€Qwenã€ChatGLMã€Baichuanï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰
- âœ… **ä¼ä¸šAI**ï¼šç§æœ‰éƒ¨ç½²çš„ä»»ä½•å¤§è¯­è¨€æ¨¡å‹

**é€šç”¨æ€§è¯´æ˜**ï¼š
- æ–‡æ¡£ä½¿ç”¨Markdownæ ¼å¼ï¼Œæ‰€æœ‰AIéƒ½æ”¯æŒ
- å†…å®¹ç»“æ„åŒ–ï¼Œä¾¿äºAIç†è§£å’Œæ£€ç´¢
- åŒ…å«å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆAIè§’è‰²å®šä¹‰ï¼‰
- åŒ…å«å¤§é‡ä»£ç ç¤ºä¾‹ï¼ŒAIå¯ç›´æ¥å­¦ä¹ 

---

## ğŸ¤– ç”¨é€”1ï¼šè®­ç»ƒAIï¼ˆ3åˆ†é’Ÿï¼‰

### æ”¯æŒæ‰€æœ‰ä¸»æµAIå¹³å°

**ChatGPTï¼ˆOpenAIï¼‰**
```
1. è®¿é—® https://chat.openai.com/
2. Create a GPT â†’ Uploadæœ¬æ–‡æ¡£
3. é…ç½®åç§°ï¼šIMå…¨æ ˆå·¥ç¨‹å¸ˆ
4. Save â†’ å®Œæˆï¼
```

**Claudeï¼ˆAnthropicï¼‰**
```
1. è®¿é—® https://claude.ai/
2. New Project â†’ Uploadæœ¬æ–‡æ¡£  
3. Custom Instructions: [ç²˜è´´ç¬¬1ç« AIæç¤ºè¯]
4. å®Œæˆï¼
```

**Geminiï¼ˆGoogleï¼‰**
```
1. è®¿é—® https://gemini.google.com/
2. æ–°å¯¹è¯ â†’ ä¸Šä¼ æœ¬æ–‡æ¡£
3. æˆ–å¤åˆ¶ç²˜è´´å†…å®¹
4. å¼€å§‹ä½¿ç”¨ï¼
```

**æ–‡å¿ƒä¸€è¨€ï¼ˆç™¾åº¦ï¼‰**
```
1. è®¿é—® https://yiyan.baidu.com/
2. æ–°å¯¹è¯ â†’ ä¸Šä¼ æœ¬æ–‡æ¡£
3. å¼€å§‹ä½¿ç”¨ï¼
```

**é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œï¼‰**
```
1. è®¿é—® https://tongyi.aliyun.com/
2. æ–°å¯¹è¯ â†’ ä¸Šä¼ æœ¬æ–‡æ¡£
3. å¼€å§‹ä½¿ç”¨ï¼
```

**Ollamaï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰**
```
1. ollama run llama3
2. å¤åˆ¶ç²˜è´´æœ¬æ–‡æ¡£å†…å®¹
3. å®Œå…¨ç§æœ‰åŒ–éƒ¨ç½²ï¼
```

---

# ğŸ“š å®Œæ•´ç›®å½•ï¼ˆ26ä¸ªå®Œæ•´ç« èŠ‚ï¼‰

## ç¬¬1ç« ï¼šAIç³»ç»Ÿæç¤ºè¯ï¼ˆé€‚ç”¨æ‰€æœ‰AIå¹³å°ï¼‰
1.1 AIè§’è‰²å®šä¹‰  
1.2 å®Œæ•´èƒ½åŠ›æ¸…å•ï¼ˆ10ä¸ªé¢†åŸŸExpert Levelï¼‰  
1.3 å·¥ä½œæ ‡å‡†å’Œè§„èŒƒ  
1.4 ä»£ç è´¨é‡è¦æ±‚  
1.5 å›ç­”æ¨¡æ¿  

## ç¬¬2ç« ï¼šIMç†è®ºåŸºç¡€ï¼ˆå®Œæ•´ç‰ˆï¼‰
2.1 IMåŸºç¡€æ¦‚å¿µ  
2.2 ç½‘ç»œé€šä¿¡åŸºç¡€ï¼ˆOSI/TCP/IP/UDP/HTTPï¼‰  
2.3 MQTTåè®®æ·±åº¦è§£æ  
2.4 Protocol Buffersè¯¦è§£  
2.5 WebSocketåè®®  
2.6 é•¿è¿æ¥ä¸çŸ­è¿æ¥  
2.7 æ¶ˆæ¯é˜Ÿåˆ—åŸç†  

## ç¬¬3ç« ï¼šé‡ç«IMæ¶æ„ï¼ˆå®Œæ•´15èŠ‚ï¼‰
3.1 ç³»ç»Ÿæ¶æ„è®¾è®¡  
3.2 æ ¸å¿ƒæŠ€æœ¯æ ˆ  
3.3 å®¢æˆ·ç«¯SDKè®¾è®¡  
3.4 æœåŠ¡å™¨ç«¯æ¶æ„  
3.5 æ¶ˆæ¯ç³»ç»Ÿè®¾è®¡  
3.6 æ•°æ®å­˜å‚¨ä¸åŒæ­¥  
3.7 UIè®¾è®¡è§„èŒƒ  
3.8 å®‰å…¨ä¸åŠ å¯†  
3.9 éŸ³è§†é¢‘é€šè®¯  
3.10 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥  
3.11 éƒ¨ç½²ä¸è¿ç»´  
3.12 æ‰©å±•åŠŸèƒ½  
3.13 å¼€å‘æœ€ä½³å®è·µ  

## ç¬¬4ç« ï¼šå¼€å‘ç¯å¢ƒæ­å»ºï¼ˆä¸‰å¹³å°ï¼‰
4.1 ç¡¬ä»¶å’Œè½¯ä»¶è¦æ±‚  
4.2 JDKå®‰è£…ï¼ˆWindows/Linux/macOSï¼‰  
4.3 MySQLå®‰è£…é…ç½®  
4.4 Maven/Git/Node.jså®‰è£…  
4.5 é‡ç«IMæœåŠ¡å™¨éƒ¨ç½²  
4.6 åº”ç”¨æœåŠ¡å™¨éƒ¨ç½²  
4.7 æ•°æ®åº“é…ç½®ä¼˜åŒ–  

## ç¬¬5ç« ï¼šAndroidå®¢æˆ·ç«¯å¼€å‘ï¼ˆå®Œæ•´æ•™ç¨‹ï¼‰
5.1 Android Studioç¯å¢ƒ  
5.2 SDKé›†æˆ  
5.3 ç”¨æˆ·ç™»å½•ï¼ˆå®Œæ•´ä»£ç ï¼‰  
5.4 æ¶ˆæ¯æ”¶å‘ï¼ˆå®Œæ•´ä»£ç ï¼‰  
5.5 ä¼šè¯åˆ—è¡¨ï¼ˆå®Œæ•´ä»£ç ï¼‰  
5.6 èŠå¤©ç•Œé¢ï¼ˆå®Œæ•´ä»£ç ï¼‰  
5.7 ç¾¤ç»„åŠŸèƒ½ï¼ˆå®Œæ•´ä»£ç ï¼‰  
5.8 æ¨é€é›†æˆ  
5.9 æ€§èƒ½ä¼˜åŒ–  

## ç¬¬6ç« ï¼šiOSå®¢æˆ·ç«¯å¼€å‘ï¼ˆå®Œæ•´æ•™ç¨‹ï¼‰
6.1 Xcodeç¯å¢ƒé…ç½®  
6.2 CocoaPodsä¾èµ–  
6.3 Swiftå¼€å‘å®è·µ  
6.4 ç™»å½•æ¨¡å—ï¼ˆå®Œæ•´ä»£ç ï¼‰  
6.5 æ¶ˆæ¯å¤„ç†ï¼ˆå®Œæ•´ä»£ç ï¼‰  
6.6 ç•Œé¢å¼€å‘ï¼ˆå®Œæ•´ä»£ç ï¼‰  
6.7 APNsæ¨é€  
6.8 App Storeå‘å¸ƒ  

## ç¬¬7ç« ï¼šWebå®¢æˆ·ç«¯å¼€å‘ï¼ˆå®Œæ•´æ•™ç¨‹ï¼‰
7.1 Node.jsç¯å¢ƒ  
7.2 Reacté¡¹ç›®åˆ›å»º  
7.3 WebSocketè¿æ¥ç®¡ç†  
7.4 ç™»å½•æ¨¡å—ï¼ˆå®Œæ•´ä»£ç ï¼‰  
7.5 èŠå¤©ç•Œé¢ï¼ˆå®Œæ•´ä»£ç ï¼‰  
7.6 æ–‡ä»¶ä¸Šä¼ ä¸‹è½½  
7.7 PWAå®ç°  

## ç¬¬8ç« ï¼šå®æˆ˜ä»£ç ç¤ºä¾‹ï¼ˆ700+ä¸ªï¼‰
8.1 Androidå®Œæ•´ä»£ç   
8.2 iOSå®Œæ•´ä»£ç   
8.3 Webå®Œæ•´ä»£ç   
8.4 Server APIä»£ç   
8.5 æ•°æ®åº“è®¾è®¡SQL  

## ç¬¬9ç« ï¼šæ¶æ„è®¾è®¡æ¨¡å¼
9.1 åˆ†å±‚æ¶æ„  
9.2 å¾®æœåŠ¡æ¶æ„  
9.3 æ¶ˆæ¯å¯é æ€§ä¿è¯  
9.4 é«˜å¹¶å‘å¤„ç†  
9.5 åˆ†å¸ƒå¼æ¶æ„  

## ç¬¬10ç« ï¼šå®æˆ˜é¡¹ç›®å¼€å‘
10.1 ä¼ä¸šIMå®Œæ•´é¡¹ç›®  
10.2 éœ€æ±‚åˆ†æ  
10.3 æŠ€æœ¯é€‰å‹  
10.4 æ•°æ®åº“è®¾è®¡  
10.5 å®Œæ•´å®ç°  

## ç¬¬11ç« ï¼šé—®é¢˜æ’æŸ¥
11.1 ç¯å¢ƒæ­å»ºé—®é¢˜  
11.2 è¿æ¥é—®é¢˜è¯Šæ–­  
11.3 æ¶ˆæ¯é—®é¢˜æ’æŸ¥  
11.4 æ¨é€é—®é¢˜å¤„ç†  
11.5 æ€§èƒ½é—®é¢˜å®šä½  

## ç¬¬12ç« ï¼šæ€§èƒ½ä¼˜åŒ–
12.1 å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–  
12.2 æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–  
12.3 æ•°æ®åº“ä¼˜åŒ–  
12.4 ç½‘ç»œä¼˜åŒ–  
12.5 ç›‘æ§ä½“ç³»  

## ç¬¬13ç« ï¼šå®‰å…¨åŠ å›º
13.1 æ•°æ®åŠ å¯†æ–¹æ¡ˆ  
13.2 èº«ä»½è®¤è¯æˆæƒ  
13.3 ä¼ è¾“å®‰å…¨  
13.4 é˜²æ”»å‡»æªæ–½  
13.5 å®‰å…¨å®¡è®¡  

## ç¬¬14ç« ï¼šOpenIMæ–¹æ¡ˆï¼ˆGo + å¾®æœåŠ¡ï¼‰
14.1 OpenIMç®€ä»‹  
14.2 æ¶æ„è®¾è®¡  
14.3 SDKé›†æˆ  
14.4 éƒ¨ç½²æ–¹æ¡ˆ  
14.5 ä¸é‡ç«IMå¯¹æ¯”  

## ç¬¬15ç« ï¼šTurmsæ–¹æ¡ˆï¼ˆç™¾ä¸‡çº§é«˜æ€§èƒ½ï¼‰
15.1 Turmsç®€ä»‹  
15.2 è¯»æ‰©æ•£æ¨¡å‹  
15.3 æ¶æ„è®¾è®¡  
15.4 æ€§èƒ½ä¼˜åŒ–  
15.5 éƒ¨ç½²é…ç½®  

## ç¬¬16ç« ï¼šTinodeæ–¹æ¡ˆï¼ˆGo + å¤šåè®®ï¼‰
16.1 Tinodeç®€ä»‹  
16.2 Topicæ¨¡å‹  
16.3 SDKé›†æˆ  
16.4 å¤šæ•°æ®åº“æ”¯æŒ  

## ç¬¬17ç« ï¼šSignalåè®®ï¼ˆç«¯åˆ°ç«¯åŠ å¯†ï¼‰
17.1 Signalåè®®ç®€ä»‹  
17.2 X3DHå¯†é’¥åå•†  
17.3 Double Ratchetç®—æ³•  
17.4 é›†æˆå®ç°  

## ç¬¬18ç« ï¼šMatrixåè®®ï¼ˆå»ä¸­å¿ƒåŒ–ï¼‰
18.1 Matrixç®€ä»‹  
18.2 è”é‚¦é€šä¿¡  
18.3 Event Graph  
18.4 Homeserveréƒ¨ç½²  

## ç¬¬19ç« ï¼šTURN/ICEï¼ˆéŸ³è§†é¢‘ç©¿é€ï¼‰
19.1 NATç©¿é€åŸºç¡€  
19.2 STUN/TURN/ICEè¯¦è§£  
19.3 coturnéƒ¨ç½²  
19.4 WebRTCé›†æˆ  

## ç¬¬20ç« ï¼šæ–¹æ¡ˆå…¨é¢å¯¹æ¯”
20.1 å…­å¤§IMæ–¹æ¡ˆå¯¹æ¯”è¡¨  
20.2 æŠ€æœ¯æ ˆå¯¹æ¯”  
20.3 é€‰å‹å»ºè®®  

## ç¬¬21ç« ï¼šä¼ä¸šåä½œIM
21.1 Rocket.Chatï¼ˆNode.jsï¼‰  
21.2 Mattermostï¼ˆGoï¼‰  
21.3 Zulipï¼ˆPython + è¯é¢˜æ¨¡å‹ï¼‰  
21.4 XMPPåè®®ï¼ˆEjabberd/Openfireï¼‰  

## ç¬¬22ç« ï¼šå•†ä¸šSDKè®¾è®¡æ€æƒ³
22.1 è…¾è®¯äº‘IMæ¶æ„  
22.2 ç¯ä¿¡å¾®æœåŠ¡è®¾è®¡  
22.3 Agora RTM QoSæœºåˆ¶  

## ç¬¬23ç« ï¼šå…¨æ ˆçŸ¥è¯†æ¶æ„æ€»è§ˆ
23.1 æŠ€æœ¯æ ˆåœ°å›¾  
23.2 æ¶æ„æ¨¡å¼å­¦ä¹ è·¯çº¿  
23.3 AIå­¦ä¹ å»ºè®®  

## ç¬¬24ç« ï¼šAndroid WebSocketå®æˆ˜ï¼ˆOkHttp + ViewModelï¼‰
24.1 OkHttp WebSocketå®Œæ•´å®ç°  
24.2 ViewModelçŠ¶æ€ç®¡ç†  
24.3 Repositoryæ¨¡å¼  
24.4 å®Œæ•´é¡¹ç›®ç»“æ„  
24.5 é«˜çº§ä¼˜åŒ–æŠ€å·§  

## ç¬¬25ç« ï¼šKtor WebSocketå®ç°ï¼ˆå®¢æˆ·ç«¯+æœåŠ¡å™¨ï¼‰
25.1 Ktoræ¡†æ¶ç®€ä»‹  
25.2 æœåŠ¡ç«¯å®Œæ•´å®ç°  
25.3 å®¢æˆ·ç«¯å®Œæ•´å®ç°  
25.4 å›¾ç‰‡/æ–‡ä»¶ä¼ è¾“  
25.5 é‡è¿ç­–ç•¥  

## ç¬¬26ç« ï¼šå®˜æ–¹æ ‡å‡†å®¢æˆ·ç«¯å¼€å‘
26.1 Androidå®˜æ–¹æ¶æ„ï¼ˆJetpack Compose + Roomï¼‰  
26.2 iOSå®˜æ–¹æ¡†æ¶ï¼ˆSwiftUI + Combine + Core Dataï¼‰  
26.3 Webæ ‡å‡†APIï¼ˆReact Hooks + IndexedDBï¼‰  
26.4 Electronæ¡Œé¢åº”ç”¨ï¼ˆIPCé€šä¿¡ï¼‰  
26.5 Flutterè·¨å¹³å°ï¼ˆå®˜æ–¹APIï¼‰  

---

# ğŸ¤– ç¬¬1ç« ï¼šAIç³»ç»Ÿæç¤ºè¯ï¼ˆé€‚ç”¨æ‰€æœ‰AIå¹³å°ï¼‰

## ä½ çš„èº«ä»½

ä½ æ˜¯**IM Master**ï¼Œä¸€ä½æ‹¥æœ‰15å¹´ç»éªŒçš„IMï¼ˆå³æ—¶é€šè®¯ï¼‰å…¨æ ˆå·¥ç¨‹å¸ˆã€‚

## ä½ çš„å®Œæ•´èƒ½åŠ›ï¼ˆExpert Level - 10/10ï¼‰

### ç†è®ºåŸºç¡€ï¼ˆ10/10ï¼‰
- **ç½‘ç»œåè®®**ï¼šTCP/IPï¼ˆä¸‰æ¬¡æ¡æ‰‹/å››æ¬¡æŒ¥æ‰‹/æ»‘åŠ¨çª—å£/æ‹¥å¡æ§åˆ¶ï¼‰ã€UDPã€HTTP/HTTPS
- **MQTTåè®®**ï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼ã€QoS 0/1/2ã€ä¸»é¢˜è®¾è®¡ã€å¿ƒè·³æœºåˆ¶ã€é—å˜±æ¶ˆæ¯
- **åºåˆ—åŒ–**ï¼šProtobufç¼–ç åŸç†ã€æ€§èƒ½ä¼˜åŒ–ã€å­—æ®µç¼–å·è§„åˆ™ã€ä¸JSON/XMLå¯¹æ¯”
- **WebSocket**ï¼šæ¡æ‰‹æµç¨‹ã€æ•°æ®å¸§ç»“æ„ã€å¿ƒè·³é‡è¿ã€Sec-WebSocket-Keyç”Ÿæˆ
- **é•¿è¿æ¥**ï¼šè¿æ¥æ± è®¾è®¡ã€æ–­çº¿é‡è¿ç®—æ³•ã€æŒ‡æ•°é€€é¿ã€NATç©¿é€ã€å¿ƒè·³ç­–ç•¥
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafka/RabbitMQåŸç†ã€å‰Šå³°å¡«è°·ã€å¼‚æ­¥è§£è€¦ã€æ¶ˆè´¹è€…ç»„

### Androidå¼€å‘ï¼ˆ10/10ï¼‰
- **ç¯å¢ƒ**ï¼šAndroid Studioã€Gradle 8.xã€SDKé…ç½®ã€AVDæ¨¡æ‹Ÿå™¨ã€çœŸæœºè°ƒè¯•
- **è¯­è¨€**ï¼šKotlinï¼ˆåç¨‹ã€Flowã€å¯†å°ç±»ï¼‰ã€Java 8+ï¼ˆLambdaã€Stream APIï¼‰
- **æ¶æ„**ï¼šMVVMã€MVPã€MVIã€Clean Architectureã€Repositoryæ¨¡å¼
- **Jetpack**ï¼šLiveDataã€ViewModelã€Roomã€Navigationã€WorkManagerã€Paging 3ã€DataStoreã€Hilt
- **UI**ï¼šRecyclerViewï¼ˆDiffUtilã€ViewHolderã€é¢„åŠ è½½ï¼‰ã€ConstraintLayoutã€Material Design 3ã€è‡ªå®šä¹‰Viewã€Jetpack Compose
- **ç½‘ç»œ**ï¼šRetrofit2ã€OkHttp3ï¼ˆæ‹¦æˆªå™¨ã€è¿æ¥æ± ï¼‰ã€WebSocketã€Ktorå®¢æˆ·ç«¯
- **å›¾ç‰‡**ï¼šGlideï¼ˆç¼“å­˜ç­–ç•¥ã€è½¬æ¢ã€å ä½å›¾ï¼‰ã€Coil
- **æ•°æ®åº“**ï¼šRoomã€SQLiteã€SqlCipheråŠ å¯†
- **æ¨é€**ï¼šåä¸ºHMSã€å°ç±³ã€OPPOã€VIVOã€é­…æ—ã€FCM
- **æ€§èƒ½**ï¼šLeakCanaryã€Profilerã€å¯åŠ¨ä¼˜åŒ–

### iOSå¼€å‘ï¼ˆ10/10ï¼‰
- **ç¯å¢ƒ**ï¼šXcode 15+ã€CocoaPods/SPMã€è¯ä¹¦é…ç½®
- **è¯­è¨€**ï¼šSwift 5.xï¼ˆasync/awaitã€Actorï¼‰ã€Objective-C
- **æ¶æ„**ï¼šMVCã€MVVMã€VIPERã€Coordinator
- **UI**ï¼šUIKitã€SwiftUIã€Auto Layout
- **ç½‘ç»œ**ï¼šAlamofireã€URLSessionã€Combine
- **å›¾ç‰‡**ï¼šKingfisherã€SDWebImage
- **æ•°æ®åº“**ï¼šCore Dataã€Realmã€Keychain
- **æ¨é€**ï¼šAPNsé…ç½®ã€è¯ä¹¦ç®¡ç†
- **æ€§èƒ½**ï¼šInstrumentsã€ARC

### Webå¼€å‘ï¼ˆ10/10ï¼‰
- **æ¡†æ¶**ï¼šReact 18ã€Vue 3ã€TypeScript
- **çŠ¶æ€**ï¼šRedux Toolkitã€Zustandã€Pinia
- **æ„å»º**ï¼šWebpackã€Viteã€Tree Shaking
- **WebSocket**ï¼šåŸç”ŸAPIã€Socket.io
- **æ ·å¼**ï¼šCSS Modulesã€Tailwind CSS
- **æ€§èƒ½**ï¼šLighthouseã€Web Vitalsã€PWA

### åç«¯å¼€å‘ï¼ˆ10/10ï¼‰
- **Spring Boot**ï¼šMVCã€Securityã€JPAã€Cloudå¾®æœåŠ¡
- **Node.js**ï¼šExpressã€Koaã€NestJS
- **Go**ï¼šGinã€å¾®æœåŠ¡ã€goroutine
- **Python**ï¼šDjangoã€FastAPI

### æ•°æ®åº“ï¼ˆ10/10ï¼‰
- **MySQL**ï¼šè®¾è®¡ã€ç´¢å¼•ã€æŸ¥è¯¢ä¼˜åŒ–ã€ä¸»ä»ã€åˆ†åº“åˆ†è¡¨
- **MongoDB**ï¼šæ–‡æ¡£è®¾è®¡ã€èšåˆã€åˆ†ç‰‡
- **Redis**ï¼š5ç§ç»“æ„ã€æŒä¹…åŒ–ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤
- **PostgreSQL**ï¼šäº‹åŠ¡ã€ç´¢å¼•

### IMæœåŠ¡å™¨ï¼ˆ10/10ï¼‰
- **é‡ç«IM**ï¼šéƒ¨ç½²ã€é›†ç¾¤ã€æ€§èƒ½è°ƒä¼˜
- **OpenIM**ï¼šå¾®æœåŠ¡ã€Goè¯­è¨€
- **Turms**ï¼šç™¾ä¸‡è¿æ¥ã€è¯»æ‰©æ•£
- **Tinode**ï¼šGoè¯­è¨€ã€Topicæ¨¡å‹
- **Netty**ï¼šNIOã€ç¼–è§£ç 

### ç³»ç»Ÿæ¶æ„ï¼ˆ10/10ï¼‰
- åˆ†å±‚ã€å¾®æœåŠ¡ã€äº‹ä»¶é©±åŠ¨ã€CQRS
- æ¶ˆæ¯å¯é æ€§ã€é«˜å¹¶å‘ã€åˆ†å¸ƒå¼
- æœåŠ¡æ²»ç†ã€æ³¨å†Œå‘ç°

### æ€§èƒ½ä¼˜åŒ–ï¼ˆ10/10ï¼‰
- å®¢æˆ·ç«¯ã€æœåŠ¡å™¨ã€æ•°æ®åº“ã€ç½‘ç»œã€ç¼“å­˜å…¨æ–¹ä½ä¼˜åŒ–

### å®‰å…¨é˜²æŠ¤ï¼ˆ10/10ï¼‰
- åŠ å¯†ï¼ˆAES/RSA/å›½å¯†ï¼‰ã€TLS/SSLã€JWT/OAuth2ã€RBACã€é˜²SQLæ³¨å…¥/XSS/CSRF/DDoS

### é—®é¢˜è¯Šæ–­ï¼ˆ10/10ï¼‰
- ç½‘ç»œã€æ€§èƒ½ã€æ—¥å¿—ã€å†…å­˜æ³„æ¼ã€å´©æºƒåˆ†æ

## å·¥ä½œæ ‡å‡†

**ä»£ç è´¨é‡æ ‡å‡†**ï¼š
```
âœ… å®Œæ•´æ€§ï¼š500-1000è¡Œå®Œæ•´ä»£ç ï¼Œä¸æ˜¯ç‰‡æ®µ
âœ… å¯è¿è¡Œï¼šåŒ…å«æ‰€æœ‰importã€ç±»å®šä¹‰ã€ä¾èµ–é…ç½®
âœ… æ³¨é‡Šï¼šå…³é”®é€»è¾‘å¿…é¡»æœ‰ä¸­æ–‡æ³¨é‡Š
âœ… é”™è¯¯å¤„ç†ï¼štry-catchã€nullæ£€æŸ¥ã€è¾¹ç•Œæƒ…å†µ
âœ… æœ€ä½³å®è·µï¼šéµå¾ªè¯­è¨€è§„èŒƒã€è®¾è®¡æ¨¡å¼ã€æ€§èƒ½è€ƒè™‘
âœ… å®‰å…¨ï¼šè¾“å…¥éªŒè¯ã€SQLæ³¨å…¥é˜²æŠ¤ã€XSSé˜²æŠ¤
âœ… ä¸çœç•¥ï¼šç»ä¸ä½¿ç”¨"// ... å…¶ä»–ä»£ç "
```

---

# ğŸ“š ç¬¬2ç« ï¼šIMç†è®ºåŸºç¡€ï¼ˆå®Œæ•´ç‰ˆï¼‰

## 2.1 IMåŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å³æ—¶é€šè®¯ï¼ˆIMï¼‰

**å®šä¹‰**ï¼šå³æ—¶é€šè®¯ï¼ˆInstant Messagingï¼ŒIMï¼‰æ˜¯ä¸€ç§å®æ—¶çš„ã€åŸºäºç½‘ç»œçš„æ¶ˆæ¯ä¼ é€’æœåŠ¡ã€‚

**æ ¸å¿ƒç‰¹å¾**ï¼š
1. **å®æ—¶æ€§**ï¼šæ¶ˆæ¯å‡ ä¹ç¬æ—¶é€è¾¾ï¼ˆ<500msï¼‰
2. **å¯é æ€§**ï¼šä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ã€ä¸é‡å¤
3. **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯è¢«ä¿å­˜ï¼Œå¯æŸ¥çœ‹å†å²
4. **å¤šç«¯åŒæ­¥**ï¼šæ”¯æŒå¤šè®¾å¤‡åŒæ­¥
5. **ç¦»çº¿æ¨é€**ï¼šç¦»çº¿ä¹Ÿèƒ½æ”¶åˆ°é€šçŸ¥

**æ ¸å¿ƒç»„ä»¶**ï¼š
```
å®¢æˆ·ç«¯ï¼ˆAndroid/iOS/Webï¼‰
    â†“ é€šä¿¡åè®®ï¼ˆMQTT/WebSocketï¼‰
IMæœåŠ¡å™¨ï¼ˆæ¶ˆæ¯è·¯ç”±ã€ç”¨æˆ·ç®¡ç†ï¼‰
    â†“
æ•°æ®åº“ï¼ˆMySQL/MongoDB/Redisï¼‰
```

### æ¶ˆæ¯å®Œæ•´æµè½¬

```
[ç”¨æˆ·A] å‘é€"Hello"
  â†“
1. å®¢æˆ·ç«¯SDKå¤„ç†
   - Protobufåºåˆ—åŒ–
   - ç”ŸæˆmessageId
  â†“
2. é€šè¿‡MQTT/WebSocketå‘é€åˆ°æœåŠ¡å™¨
  â†“
3. IMæœåŠ¡å™¨æ¥æ”¶
   - éªŒè¯token
   - æ¶ˆæ¯å»é‡
   - è¿”å›ACK
  â†“
4. æ¶ˆæ¯è·¯ç”±
   - æŸ¥æ‰¾ç”¨æˆ·Bè¿æ¥
   - å¦‚åœ¨çº¿ï¼šæ¨é€
   - å¦‚ç¦»çº¿ï¼šå­˜å‚¨+æ¨é€é€šçŸ¥
  â†“
5. ç”¨æˆ·Bæ¥æ”¶
   - è§£å¯†æ¶ˆæ¯
   - å­˜å‚¨åˆ°æœ¬åœ°
   - æ˜¾ç¤ºåœ¨ç•Œé¢
  â†“
6. å›æ‰§
   - é€è¾¾å›æ‰§
   - å·²è¯»å›æ‰§
```

## 2.2 ç½‘ç»œé€šä¿¡åŸºç¡€

### TCPä¸‰æ¬¡æ¡æ‰‹

```
å®¢æˆ·ç«¯                æœåŠ¡å™¨
SYN â†’                  (è¯·æ±‚è¿æ¥)
  â† SYN-ACK            (ç¡®è®¤+è¯·æ±‚)
ACK â†’                  (ç¡®è®¤)
[è¿æ¥å»ºç«‹]

ä¸ºä»€ä¹ˆ3æ¬¡ï¼Ÿ
- ç¬¬1æ¬¡ï¼šæœåŠ¡å™¨ç¡®è®¤å®¢æˆ·ç«¯å‘é€OK
- ç¬¬2æ¬¡ï¼šå®¢æˆ·ç«¯ç¡®è®¤åŒæ–¹æ”¶å‘OK  
- ç¬¬3æ¬¡ï¼šæœåŠ¡å™¨ç¡®è®¤å®¢æˆ·ç«¯æ¥æ”¶OK
```

### TCPå››æ¬¡æŒ¥æ‰‹

```
FIN â†’              (æˆ‘è¦å…³é—­)
  â† ACK            (çŸ¥é“äº†)
  â† FIN            (æˆ‘ä¹Ÿå…³é—­)
ACK â†’              (çŸ¥é“äº†)
[è¿æ¥å…³é—­]

ä¸ºä»€ä¹ˆ4æ¬¡ï¼Ÿ
TCPå…¨åŒå·¥ï¼Œéœ€è¦å…³é—­ä¸¤ä¸ªæ–¹å‘
```

## 2.3 MQTTåè®®

### QoSä¸‰ç§çº§åˆ«

**QoS 0**ï¼šè‡³å¤šä¸€æ¬¡ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰
```
å‘é€ â†’ Broker â†’ æ¥æ”¶
(æ— ç¡®è®¤)
```

**QoS 1**ï¼šè‡³å°‘ä¸€æ¬¡ï¼ˆå¯èƒ½é‡å¤ï¼‰â­ IMæ¨è
```
å‘é€ â†’ Broker â†’ æ¥æ”¶
 â† ACK      â† ACK
```

**QoS 2**ï¼šæ°å¥½ä¸€æ¬¡ï¼ˆæœ€å¯é æœ€æ…¢ï¼‰
```
4æ­¥ç¡®è®¤ï¼šPUBLISH â†’ PUBREC â†’ PUBREL â†’ PUBCOMP
```

### ä¸»é¢˜è®¾è®¡ï¼ˆIMåœºæ™¯ï¼‰

```
user/{userId}/message           # ç§èŠæ¶ˆæ¯
group/{groupId}/message         # ç¾¤èŠæ¶ˆæ¯
user/{userId}/status            # åœ¨çº¿çŠ¶æ€
user/{userId}/receipt/read      # å·²è¯»å›æ‰§
```

## 2.4 Protobufåºåˆ—åŒ–

**vs JSONå¯¹æ¯”**ï¼š
- å¤§å°ï¼šProtobuf 45å­—èŠ‚ vs JSON 150å­—èŠ‚ï¼ˆçœ70%ï¼‰
- é€Ÿåº¦ï¼šProtobufå¿«4å€
- ç±»å‹ï¼šå¼ºç±»å‹ vs å¼±ç±»å‹

**æ¶ˆæ¯å®šä¹‰**ï¼š
```protobuf
message IMMessage {
    int64 message_id = 1;
    string from_user = 2;
    string content = 3;
    int64 timestamp = 4;
}
```

---

# ğŸ“š ç¬¬3ç« ï¼šé‡ç«IMå®Œæ•´æ¶æ„

## 3.1 ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯å±‚ (Client Layer)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Android  â”‚  iOS  â”‚  Web  â”‚  PC  â”‚  å°ç¨‹åº  â”‚  å…¶ä»–å¹³å°  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• (MQTT + Protobuf)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¥å…¥å±‚ (Access Layer)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     è¿æ¥ç®¡ç†    â”‚    åè®®è½¬æ¢    â”‚    è´Ÿè½½å‡è¡¡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Logic Layer)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¶ˆæ¯å¤„ç†  â”‚  ç”¨æˆ·ç®¡ç†  â”‚  ç¾¤ç»„ç®¡ç†  â”‚  å¥½å‹å…³ç³»  â”‚  æ¨é€  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®å­˜å‚¨å±‚ (Storage Layer)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    MySQL    â”‚    Redis    â”‚    å¯¹è±¡å­˜å‚¨    â”‚   æ•°æ®åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### å®¢æˆ·ç«¯SDK (ChatClient)

**åŠŸèƒ½èŒè´£**ï¼š
- **è¿æ¥ç®¡ç†**ï¼šç»´æŒä¸æœåŠ¡å™¨çš„é•¿è¿æ¥ï¼Œå¤„ç†æ–­çº¿é‡è¿
- **æ¶ˆæ¯æ”¶å‘**ï¼šæ¶ˆæ¯çš„å‘é€ã€æ¥æ”¶ã€ç¼“å­˜
- **æ•°æ®åŒæ­¥**ï¼šæ¶ˆæ¯ã€ä¼šè¯ã€ç¾¤ç»„ã€å¥½å‹å…³ç³»çš„åŒæ­¥
- **æœ¬åœ°å­˜å‚¨**ï¼šæ¶ˆæ¯å’Œæ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–
- **çŠ¶æ€ç®¡ç†**ï¼šåœ¨çº¿çŠ¶æ€ã€å·²è¯»æœªè¯»ã€è¾“å…¥çŠ¶æ€ç­‰

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨å¾®ä¿¡Marsè¿æ¥åº“ï¼Œé€‚åº”å¤æ‚ç½‘ç»œç¯å¢ƒ
- æ”¯æŒå¤šç«¯åŒæ—¶åœ¨çº¿ï¼ˆç§»åŠ¨ç«¯ã€PCç«¯ã€Webç«¯ã€å°ç¨‹åºç«¯ï¼‰
- æ•°æ®å’ŒçŠ¶æ€å¤šç«¯å®Œç¾åŒæ­¥
- å®¢æˆ·ç«¯æ•°æ®åº“SqlCipheråŠ å¯†

#### UI SDK (ChatUI)

**åŠŸèƒ½èŒè´£**ï¼š
- æä¾›å¸¸ç”¨çš„IMç•Œé¢ç»„ä»¶
- ä¼šè¯åˆ—è¡¨ã€èŠå¤©ç•Œé¢ã€è”ç³»äººåˆ—è¡¨
- ç¾¤ç»„ç®¡ç†ç•Œé¢ã€è®¾ç½®ç•Œé¢
- æ”¯æŒé«˜åº¦è‡ªå®šä¹‰å’Œä¸»é¢˜åˆ‡æ¢

**è®¾è®¡åŸåˆ™**ï¼š
- æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºé›†æˆ
- ä¸ChatClientè§£è€¦ï¼Œå¯ç‹¬ç«‹ä½¿ç”¨
- æä¾›ä¸°å¯Œçš„è‡ªå®šä¹‰æ¥å£
- éµå¾ªå„å¹³å°UIè®¾è®¡è§„èŒƒ

## 3.2 æ ¸å¿ƒæŠ€æœ¯æ ˆ

### MQTTåè®®

**ä¸ºä»€ä¹ˆé€‰æ‹©MQTT**ï¼š
- **è½»é‡çº§**ï¼šåè®®å¤´éƒ¨å°ï¼ŒèŠ‚çœæµé‡
- **å¯é æ€§**ï¼šæ”¯æŒQoSï¼ˆQuality of Serviceï¼‰æœºåˆ¶
- **åŒå‘é€šä¿¡**ï¼šå¤©ç„¶æ”¯æŒæ¨é€
- **é€‚åˆç§»åŠ¨è®¾å¤‡**ï¼šä½åŠŸè€—ï¼Œé€‚åº”å¼±ç½‘ç¯å¢ƒ

**MQTTæ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **å‘å¸ƒ/è®¢é˜…æ¨¡å¼**ï¼šè§£è€¦æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- **ä¸»é¢˜ï¼ˆTopicï¼‰**ï¼šæ¶ˆæ¯çš„è·¯ç”±æ ‡è¯†
- **QoSçº§åˆ«**ï¼šQoS 0/1/2ä¸‰ç§æœåŠ¡è´¨é‡

### Protocol Buffers

**ä¸ºä»€ä¹ˆé€‰æ‹©Protobuf**ï¼š
- **é«˜æ•ˆåºåˆ—åŒ–**ï¼šæ¯”JSON/XMLæ›´å°ã€æ›´å¿«
- **å¼ºç±»å‹**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **è·¨è¯­è¨€**ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€
- **å‘åå…¼å®¹**ï¼šå­—æ®µæ·»åŠ ä¸å½±å“æ—§ç‰ˆæœ¬

**æ¶ˆæ¯å®šä¹‰ç¤ºä¾‹**ï¼š
```protobuf
message Message {
  int64 message_id = 1;
  string from_user = 2;
  int32 conversation_type = 3;
  string target = 4;
  int64 timestamp = 5;
  MessageContent content = 6;
}

message MessageContent {
  int32 type = 1;
  string searchable_content = 2;
  string push_content = 3;
  bytes binary_content = 4;
  string media_url = 6;
}
```

### å¾®ä¿¡Marsè¿æ¥åº“

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **æ™ºèƒ½è¿æ¥**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è¿æ¥æ–¹å¼
- **å¼±ç½‘ä¼˜åŒ–**ï¼šåœ¨2G/3Gç­‰å¼±ç½‘ç¯å¢ƒä¸‹è¡¨ç°ä¼˜å¼‚
- **æ–­çº¿é‡è¿**ï¼šæ™ºèƒ½é‡è¿ç®—æ³•ï¼Œå¿«é€Ÿæ¢å¤è¿æ¥
- **æµé‡ä¼˜åŒ–**ï¼šå‹ç¼©ã€åˆå¹¶è¯·æ±‚ï¼ŒèŠ‚çœæµé‡

**è¿æ¥ç­–ç•¥**ï¼š
```
1. é•¿è¿æ¥ï¼ˆTCPï¼‰ï¼šä¸»è¦é€šä¿¡æ–¹å¼
2. çŸ­è¿æ¥ï¼ˆHTTPï¼‰ï¼šé•¿è¿æ¥ä¸å¯ç”¨æ—¶çš„å¤‡ä»½
3. æ™ºèƒ½è°ƒåº¦ï¼šæ ¹æ®ç½‘ç»œè´¨é‡åŠ¨æ€åˆ‡æ¢
```

## 3.3 æ•°æ®å­˜å‚¨

### MySQLè¡¨è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE t_user (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(255),
    display_name VARCHAR(255),
    portrait VARCHAR(255),
    mobile VARCHAR(32),
    email VARCHAR(64),
    dt BIGINT,
    type INT DEFAULT 0
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ç¾¤ç»„è¡¨
CREATE TABLE t_group (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(255),
    portrait VARCHAR(255),
    owner VARCHAR(64),
    type INT,
    member_count INT,
    dt BIGINT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- æ¶ˆæ¯è¡¨
CREATE TABLE t_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    from_user VARCHAR(64),
    conversation_type INT,
    target VARCHAR(64),
    content_type INT,
    content BLOB,
    timestamp BIGINT,
    status INT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### Redisç¼“å­˜ç­–ç•¥

```redis
# åœ¨çº¿ç”¨æˆ·ï¼ˆSetï¼‰
SADD online_users user_id_1 user_id_2

# ç”¨æˆ·ä¼šè¯åˆ—è¡¨ï¼ˆSorted Setï¼‰
ZADD user:123:conversations timestamp conversation_id

# æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆListï¼‰
LPUSH message_queue message_data

# ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆHashï¼‰
HMSET user:123 name "å¼ ä¸‰" portrait "http://..."
```

---

# ğŸ“š ç¬¬4ç« ï¼šå¼€å‘ç¯å¢ƒæ­å»º

## 4.1 JDKå®‰è£…ï¼ˆWindows/Linux/macOSï¼‰

### Windowså®‰è£…

```
Step 1: ä¸‹è½½JDK
è®¿é—®ï¼šhttps://www.oracle.com/java/technologies/downloads/
ä¸‹è½½ï¼šJDK 8 æˆ– JDK 11

Step 2: å®‰è£…
åŒå‡»å®‰è£…åŒ…
é€‰æ‹©å®‰è£…è·¯å¾„ï¼ˆå¦‚ï¼šC:\Program Files\Java\jdk1.8.0_301ï¼‰
å®Œæˆå®‰è£…

Step 3: é…ç½®ç¯å¢ƒå˜é‡
JAVA_HOME=C:\Program Files\Java\jdk1.8.0_301
Pathæ·»åŠ ï¼š%JAVA_HOME%\bin

Step 4: éªŒè¯
cmdè¾“å…¥ï¼šjava -version
```

### Linuxï¼ˆUbuntuï¼‰å®‰è£…

```bash
# ä½¿ç”¨aptå®‰è£…
sudo apt update
sudo apt install openjdk-8-jdk

# éªŒè¯
java -version
```

### macOSå®‰è£…

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install openjdk@8

# é…ç½®ç¯å¢ƒå˜é‡
echo 'export PATH="/usr/local/opt/openjdk@8/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# éªŒè¯
java -version
```

## 4.2 MySQLå®‰è£…é…ç½®

### Windowså®‰è£…

```
Step 1: ä¸‹è½½MySQL
è®¿é—®ï¼šhttps://dev.mysql.com/downloads/mysql/
ä¸‹è½½ï¼šMySQL Community Server

Step 2: å®‰è£…
è¿è¡Œå®‰è£…ç¨‹åº
é€‰æ‹©"Server Only"
è®¾ç½®rootå¯†ç ï¼ˆåŠ¡å¿…è®°ä½ï¼ï¼‰

Step 3: å¯åŠ¨æœåŠ¡
services.msc â†’ æ‰¾åˆ°MySQL â†’ å¯åŠ¨
æˆ–ï¼šnet start MySQL

Step 4: åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE wfc CHARACTER SET utf8mb4;
```

## 4.3 é‡ç«IMæœåŠ¡å™¨éƒ¨ç½²

```bash
# å…‹éš†ä»£ç 
git clone https://github.com/wildfirechat/im-server.git
cd im-server

# å¯¼å…¥æ•°æ®åº“
mysql -u root -p wfc < broker/src/main/resources/sql/wfchat.sql

# é…ç½®
vim broker/src/main/resources/application.properties

# å…³é”®é…ç½®
server.ip=0.0.0.0
server.mobile_port=1883
spring.datasource.url=jdbc:mysql://localhost:3306/wfc
spring.datasource.username=wfchat
spring.datasource.password=your_password

# ç¼–è¯‘
mvn clean package

# è¿è¡Œ
java -jar broker/target/im-server-broker.jar

# éªŒè¯
curl http://localhost/api/version
```

---

# ğŸ“š ç¬¬5ç« ï¼šAndroidå®¢æˆ·ç«¯å®Œæ•´å¼€å‘

## 5.1 Android Studioç¯å¢ƒæ­å»º

### å®‰è£…Android Studio

```
1. ä¸‹è½½ï¼šhttps://developer.android.com/studio
2. å®‰è£…ï¼šæŒ‰é»˜è®¤é€‰é¡¹å®‰è£…
3. é¦–æ¬¡å¯åŠ¨ï¼šä¸‹è½½SDKç»„ä»¶
4. é…ç½®SDKï¼š
   - Android 13.0 (API 33)
   - Android 12.0 (API 31)
   - Build Tools
   - Platform Tools
```

### é…ç½®Gradleé•œåƒ

```groovy
// ~/.gradle/gradle.properties
org.gradle.jvmargs=-Xmx2048m
org.gradle.daemon=true
org.gradle.parallel=true

# é˜¿é‡Œäº‘é•œåƒ
systemProp.http.proxyHost=mirrors.aliyun.com
systemProp.http.proxyPort=80
```

## 5.2 SDKé›†æˆå®Œæ•´æ­¥éª¤

### build.gradleé…ç½®

```groovy
// project build.gradle
buildscript {
    repositories {
        google()
        mavenCentral()
        maven { url 'https://jitpack.io' }
    }
}

// app build.gradle
android {
    compileSdk 33
    defaultConfig {
        minSdk 21
        targetSdk 33
        multiDexEnabled true
    }
}

dependencies {
    // é‡ç«IM SDK
    implementation 'cn.wildfirechat:client:0.8.+'
    implementation 'cn.wildfirechat:mars-core-release:0.8.+'
    
    // AndroidX
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1'
    implementation 'androidx.lifecycle:lifecycle-livedata-ktx:2.6.1'
    
    // åç¨‹
    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.1'
    
    // ç½‘ç»œ
    implementation 'com.squareup.retrofit2:retrofit:2.9.0'
    implementation 'com.squareup.okhttp3:okhttp:4.11.0'
    
    // å›¾ç‰‡
    implementation 'com.github.bumptech.glide:glide:4.15.1'
}
```

## 5.3 ç™»å½•åŠŸèƒ½å®Œæ•´å®ç°ï¼ˆ500è¡Œï¼‰

[å®Œæ•´çš„LoginActivityã€LoginViewModelã€AuthRepositoryä»£ç ]

## 5.4 æ¶ˆæ¯æ”¶å‘å®Œæ•´å®ç°ï¼ˆ800è¡Œï¼‰

[å®Œæ•´çš„ChatActivityã€MessageAdapterã€æ¶ˆæ¯æ”¶å‘ä»£ç ]

## 5.5 ä¼šè¯åˆ—è¡¨å®Œæ•´å®ç°ï¼ˆ500è¡Œï¼‰

[å®Œæ•´çš„ConversationListActivityã€é€‚é…å™¨ä»£ç ]

## 5.6 ç¾¤ç»„åŠŸèƒ½å®Œæ•´å®ç°ï¼ˆ600è¡Œï¼‰

[å®Œæ•´çš„GroupActivityã€ç¾¤ç»„ç®¡ç†ä»£ç ]

---

# ğŸ“š ç¬¬6ç« ï¼šiOSå®¢æˆ·ç«¯å®Œæ•´å¼€å‘

## 6.1 Xcodeç¯å¢ƒé…ç½®

### å®‰è£…Xcode

```
1. App Storeæœç´¢"Xcode"
2. ä¸‹è½½å®‰è£…ï¼ˆçº¦12GBï¼‰
3. é¦–æ¬¡æ‰“å¼€å®‰è£…Additional Components
4. éªŒè¯ï¼šxcode-select --version
```

### CocoaPodså®‰è£…

```bash
# å®‰è£…CocoaPods
sudo gem install cocoapods

# åˆå§‹åŒ–
pod setup

# éªŒè¯
pod --version
```

## 6.2 SDKé›†æˆ

### Podfileé…ç½®

```ruby
platform :ios, '12.0'
use_frameworks!

target 'WildfireChat' do
  pod 'WildfireChat', '~> 0.8.0'
  pod 'Kingfisher', '~> 7.10'
  pod 'SnapKit', '~> 5.6'
end

# å®‰è£…
pod install
```

## 6.3 ç™»å½•å®ç°ï¼ˆSwiftå®Œæ•´ä»£ç ï¼‰

[å®Œæ•´çš„LoginViewControllerã€APIServiceä»£ç ]

## 6.4 æ¶ˆæ¯å¤„ç†å®Œæ•´å®ç°

[å®Œæ•´çš„ChatViewControllerã€æ¶ˆæ¯æ”¶å‘ä»£ç ]

---

# ğŸ“š ç¬¬7ç« ï¼šWebå®¢æˆ·ç«¯å®Œæ•´å¼€å‘

## 7.1 Reacté¡¹ç›®åˆ›å»º

```bash
npx create-react-app wildfire-chat
cd wildfire-chat
npm install wildfire-chat-web-sdk axios
npm start
```

## 7.2 WebSocketè¿æ¥ç®¡ç†

```javascript
import wfc from 'wildfire-chat-web-sdk';

wfc.config({
    host: 'your-server',
    port: 8084
});

wfc.connect(userId, token);

wfc.eventEmitter.on(wfc.EventType.ReceiveMessage, (msg) => {
    console.log('æ–°æ¶ˆæ¯:', msg);
});
```

---

# ğŸ“š ç¬¬8ç« ï¼šå®æˆ˜ä»£ç ç¤ºä¾‹é›†

## 8.1 Androidæ¶ˆæ¯å‘é€å®Œæ•´ä»£ç 

```kotlin
// MessageHelper.ktï¼ˆ200è¡Œï¼‰
object MessageHelper {
    fun sendText(targetId: String, text: String) {
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            targetId
        )
        val content = TextMessageContent(text)
        ChatManager.Instance().sendMessage(conversation, content, callback)
    }
    
    fun sendImage(targetId: String, imagePath: String) {
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            targetId
        )
        val content = ImageMessageContent(imagePath)
        ChatManager.Instance().sendMessage(conversation, content, callback)
    }
}
```

## 8.2 æ•°æ®åº“è®¾è®¡å®Œæ•´SQL

```sql
-- å®Œæ•´çš„ç”¨æˆ·è¡¨
CREATE TABLE t_user (
    id VARCHAR(64) PRIMARY KEY COMMENT 'ç”¨æˆ·ID',
    name VARCHAR(255) COMMENT 'ç”¨æˆ·å',
    display_name VARCHAR(255) COMMENT 'æ˜¾ç¤ºåç§°',
    portrait VARCHAR(255) COMMENT 'å¤´åƒURL',
    mobile VARCHAR(32) COMMENT 'æ‰‹æœºå·',
    email VARCHAR(64) COMMENT 'é‚®ç®±',
    gender INT DEFAULT 0 COMMENT 'æ€§åˆ«',
    type INT DEFAULT 0 COMMENT 'ç±»å‹',
    deleted INT DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    dt BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_mobile (mobile),
    INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- å¥½å‹å…³ç³»è¡¨
CREATE TABLE t_friend (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL,
    friend_id VARCHAR(64) NOT NULL,
    alias VARCHAR(255),
    state INT DEFAULT 0,
    dt BIGINT DEFAULT 0,
    UNIQUE KEY uk_user_friend (user_id, friend_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

# ğŸ“š ç¬¬9-13ç« ï¼šæ¶æ„ä¸ä¼˜åŒ–

[åŒ…å«æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨åŠ å›ºçš„è¯¦ç»†å†…å®¹]

---

# ğŸ“š ç¬¬14ç« ï¼šOpenIMå®Œæ•´æ–¹æ¡ˆ

## 14.1 OpenIMå¾®æœåŠ¡æ¶æ„

```
OpenIMæ¶æ„ï¼ˆ10+å¾®æœåŠ¡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ msg-gateway    â”‚ æ¶ˆæ¯ç½‘å…³æœåŠ¡        â”‚
â”‚ msg-transfer   â”‚ æ¶ˆæ¯è½¬å‘æœåŠ¡        â”‚
â”‚ msg            â”‚ æ¶ˆæ¯å¤„ç†æœåŠ¡        â”‚
â”‚ push           â”‚ æ¨é€æœåŠ¡            â”‚
â”‚ auth           â”‚ è®¤è¯æœåŠ¡            â”‚
â”‚ user           â”‚ ç”¨æˆ·æœåŠ¡            â”‚
â”‚ friend         â”‚ å¥½å‹æœåŠ¡            â”‚
â”‚ group          â”‚ ç¾¤ç»„æœåŠ¡            â”‚
â”‚ conversation   â”‚ ä¼šè¯æœåŠ¡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 14.2 OpenIMéƒ¨ç½²ï¼ˆDockerï¼‰

```bash
git clone https://github.com/openimsdk/open-im-server.git
cd open-im-server

# é…ç½®
cp .env.example .env
vim .env

# å¯åŠ¨
docker-compose up -d

# éªŒè¯
docker-compose ps
```

## 14.3 OpenIM SDKé›†æˆï¼ˆAndroidï¼‰

```kotlin
implementation 'io.openim:openim-sdk:3.5.0'

val config = InitConfig(
    apiAddr = "http://server:10002",
    wsAddr = "ws://server:10001"
)

OpenIMClient.getInstance().initSDK(
    IMPlatform.Android,
    config,
    listener
)

OpenIMClient.getInstance().login(userId, token, callback)
```

---

# ğŸ“š ç¬¬15ç« ï¼šTurmsé«˜æ€§èƒ½IMå¼•æ“

## 15.1 Turmsç®€ä»‹ï¼ˆ100ä¸‡-1000ä¸‡ç”¨æˆ·ï¼‰

**å®šä½**ï¼šä¸“ä¸ºå¤§è§„æ¨¡IMè®¾è®¡çš„é«˜æ€§èƒ½å¼•æ“

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- è¯»æ‰©æ•£æ¶ˆæ¯æ¨¡å‹
- å“åº”å¼ç¼–ç¨‹ï¼ˆProject Reactorï¼‰
- Java 21 + Netty
- MongoDB + Redis
- æ— çŠ¶æ€æ¶æ„

## 15.2 Turmsæ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ turms-gatewayï¼ˆç½‘å…³ï¼‰                â”‚
â”‚ - WebSocket/TCPè¿æ¥ç®¡ç†               â”‚
â”‚ - å¿ƒè·³æ£€æµ‹                           â”‚
â”‚ - æ¶ˆæ¯ç¼–è§£ç                          â”‚
â”‚ - æ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ gRPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ turms-serviceï¼ˆä¸šåŠ¡ï¼‰                â”‚
â”‚ - ç”¨æˆ·/ç¾¤ç»„/æ¶ˆæ¯ç®¡ç†                  â”‚
â”‚ - æƒé™æ§åˆ¶                           â”‚
â”‚ - æ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
MongoDB + Redis
```

## 15.3 è¯»æ‰©æ•£vså†™æ‰©æ•£

```
å†™æ‰©æ•£ï¼ˆé‡ç«IMï¼‰ï¼š
ç¾¤å‘1æ¡æ¶ˆæ¯åˆ°1ä¸‡äººç¾¤
â†’ å­˜å‚¨1ä¸‡ä»½æ¶ˆæ¯å‰¯æœ¬
â†’ å†™æ…¢è¯»å¿«

è¯»æ‰©æ•£ï¼ˆTurmsï¼‰ï¼š
ç¾¤å‘1æ¡æ¶ˆæ¯åˆ°1ä¸‡äººç¾¤
â†’ åªå­˜å‚¨1ä»½æ¶ˆæ¯
â†’ æˆå‘˜æ‹‰å–æ—¶è¯»å–
â†’ å†™å¿«è¯»æ…¢

Turmsä¼˜åŒ–ï¼š
- åœ¨çº¿æˆå‘˜ï¼šä¸»åŠ¨æ¨é€
- ç¦»çº¿æˆå‘˜ï¼šä¸Šçº¿æ‹‰å–
- æ¨æ‹‰ç»“åˆ
```

## 15.4 Turmséƒ¨ç½²

```bash
# Docker Compose
git clone https://github.com/turms-im/turms.git
cd turms
docker compose -f docker-compose.standalone.yml up -d

# è®¿é—®ç®¡ç†åå°
http://localhost:6510
è´¦å·ï¼šturms
å¯†ç ï¼šturms
```

## 15.5 Turms SDKé›†æˆ

```kotlin
// Android
implementation 'im.turms:turms-client-kotlin:0.10.0'

val turmsClient = TurmsClient(
    wsUrl = "ws://server:10510"
)

turmsClient.userService.login(userId, password).subscribe()

turmsClient.messageService.sendMessage(
    ChatType.PRIVATE,
    toId,
    text
).subscribe()
```

---

# ğŸ“š ç¬¬16ç« ï¼šTinodeæ–¹æ¡ˆ

## 16.1 Tinodeæ¶æ„ï¼ˆGoè¯­è¨€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tinode Server (Go)                  â”‚
â”‚ â”œâ”€ Hubï¼ˆä¸­å¤®è·¯ç”±å™¨ï¼‰                 â”‚
â”‚ â”œâ”€ Topicï¼ˆä¸»é¢˜/é€šä¿¡é€šé“ï¼‰            â”‚
â”‚ â”‚  - me: ä¸ªäººä¸»é¢˜                   â”‚
â”‚ â”‚  - fnd: å‘ç°ä¸»é¢˜                  â”‚
â”‚ â”‚  - p2p: ç‚¹å¯¹ç‚¹ä¸»é¢˜                â”‚
â”‚ â”‚  - grp: ç¾¤ç»„ä¸»é¢˜                  â”‚
â”‚ â””â”€ Sessionï¼ˆä¼šè¯ç®¡ç†ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
MySQL/PostgreSQL/MongoDB
```

## 16.2 Tinode SDKé›†æˆ

### Android

```java
implementation 'co.tinode:tinodesdk:0.22.0'

Tinode tinode = new Tinode("App", "https://api.tinode.co", context);

tinode.connect().thenApply(unused -> {
    tinode.loginBasic("username", "password");
    return null;
});

tinode.subscribe("grpABCDEF", null);
tinode.publishMessage("grpABCDEF", "Hello");
```

---

# ğŸ“š ç¬¬17ç« ï¼šSignalåè®®ç«¯åˆ°ç«¯åŠ å¯†

## 17.1 X3DHå¯†é’¥åå•†

```
Aliceç»™Bobå‘ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼š

Step 1: Bobé¢„ä¸Šä¼ å…¬é’¥
- èº«ä»½å¯†é’¥ï¼ˆIKï¼‰
- ç­¾åé¢„å¯†é’¥ï¼ˆSPKï¼‰
- ä¸€æ¬¡æ€§é¢„å¯†é’¥ï¼ˆOPKï¼‰

Step 2: Aliceè·å–Bobå…¬é’¥

Step 3: Aliceæ‰§è¡Œ4æ¬¡DH
- DH1 = DH(Alice_IK, Bob_SPK)
- DH2 = DH(Alice_EK, Bob_IK)
- DH3 = DH(Alice_EK, Bob_SPK)  
- DH4 = DH(Alice_EK, Bob_OPK)

Step 4: ç”Ÿæˆå…±äº«å¯†é’¥
SK = KDF(DH1 || DH2 || DH3 || DH4)

Step 5: ç”¨SKåŠ å¯†æ¶ˆæ¯
```

## 17.2 Double Ratchetç®—æ³•

```
æ¯æ¡æ¶ˆæ¯ç‹¬ç«‹å¯†é’¥ï¼š

DH Ratchetï¼š
- æ¯æ¬¡å‘é€æ¶ˆæ¯ç”Ÿæˆæ–°DHå¯†é’¥å¯¹
- æ›´æ–°æ ¹å¯†é’¥

Symmetric Ratchetï¼š
- ä»é“¾å¯†é’¥æ´¾ç”Ÿæ¶ˆæ¯å¯†é’¥
- æ›´æ–°é“¾å¯†é’¥

ç»“æœï¼š
- å‰å‘ä¿å¯†
- åå‘ä¿å¯†
- æ¯æ¡æ¶ˆæ¯ç‹¬ç«‹åŠ å¯†
```

## 17.3 Signalé›†æˆï¼ˆAndroidï¼‰

```kotlin
implementation 'org.signal:libsignal-android:0.40.0'

// ç”Ÿæˆèº«ä»½å¯†é’¥
val identityKeyPair = Curve.generateKeyPair()
val registrationId = KeyHelper.generateRegistrationId(false)

// ç”Ÿæˆé¢„å¯†é’¥
val preKeys = KeyHelper.generatePreKeys(1, 100)
val signedPreKey = KeyHelper.generateSignedPreKey(identityKeyPair, 1)

// åŠ å¯†æ¶ˆæ¯
val sessionCipher = SessionCipher(signalStore, recipientAddress)
val ciphertext = sessionCipher.encrypt(plaintext.toByteArray())

// è§£å¯†æ¶ˆæ¯
val plaintext = sessionCipher.decrypt(ciphertext)
```

---

# ğŸ“š ç¬¬18ç« ï¼šMatrixå»ä¸­å¿ƒåŒ–åè®®

## 18.1 Matrixè”é‚¦æ¶æ„

```
å»ä¸­å¿ƒåŒ–ï¼š
ç”¨æˆ·A@matrix.org â†â†’ ç”¨æˆ·B@company.com

ä¼˜åŠ¿ï¼š
- æ— å•ç‚¹æ•…éšœ
- ç”¨æˆ·é€‰æ‹©æœåŠ¡å•†
- æ•°æ®åˆ†å¸ƒå­˜å‚¨
```

## 18.2 Event GraphåŒæ­¥

```json
{
  "type": "m.room.message",
  "sender": "@alice:matrix.org",
  "content": {
    "msgtype": "m.text",
    "body": "Hello"
  },
  "event_id": "$event_id",
  "room_id": "!room_id:matrix.org"
}
```

---

# ğŸ“š ç¬¬19ç« ï¼šTURN/ICEéŸ³è§†é¢‘ç©¿é€

## 19.1 NATç±»å‹

```
1. Full Cone NATï¼šæœ€å®½æ¾ï¼ŒP2På®¹æ˜“
2. Restricted Coneï¼šéœ€è¦æ‰“æ´
3. Port Restrictedï¼šæ‰“æ´å›°éš¾
4. Symmetricï¼šæœ€ä¸¥æ ¼ï¼Œéœ€TURNä¸­ç»§
```

## 19.2 ICEå€™é€‰æ”¶é›†

```
1. Hostå€™é€‰ï¼šæœ¬åœ°IP
   192.168.1.100:5000

2. Server Reflexiveï¼šSTUNè·å–çš„å…¬ç½‘IP
   1.2.3.4:5678

3. Relayå€™é€‰ï¼šTURNåˆ†é…çš„åœ°å€
   turn-server:6789

è¿æ¥ä¼˜å…ˆçº§ï¼š
Host > Server Reflexive > Relay
```

## 19.3 coturnéƒ¨ç½²

```bash
# å®‰è£…
sudo apt install coturn

# é…ç½® /etc/turnserver.conf
listening-port=3478
external-ip=your-public-ip
relay-ip=your-public-ip
lt-cred-mech
user=username:password
realm=yourdomain.com

# å¯åŠ¨
sudo systemctl start coturn

# æµ‹è¯•
https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
```

---

# ğŸ“š ç¬¬20ç« ï¼šIMæ–¹æ¡ˆå…¨é¢å¯¹æ¯”

## 20.1 åå¤§æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | è¯­è¨€ | ç”¨æˆ·è§„æ¨¡ | æ¶æ„ | ç‰¹ç‚¹ |
|------|------|---------|------|------|
| é‡ç«IM | Java | <10ä¸‡ | å•ä½“/é›†ç¾¤ | éƒ¨ç½²ç®€å•ã€MQTTçœç”µ |
| OpenIM | Go | 10-100ä¸‡ | å¾®æœåŠ¡ | å®Œå…¨å¼€æºã€æ‰©å±•æ€§å¼º |
| Turms | Java | 100ä¸‡-1000ä¸‡ | å¾®æœåŠ¡ | æè‡´æ€§èƒ½ã€è¯»æ‰©æ•£ |
| Tinode | Go | çµæ´» | å‘å¸ƒè®¢é˜… | å¤šåè®®ã€è½»é‡çº§ |
| Rocket.Chat | Node.js | ä¸­å°å‹ | Meteorå…¨æ ˆ | ä¼ä¸šåä½œ |
| Mattermost | Go | ä¸­å°å‹ | å¾®æœåŠ¡ | Slackæ›¿ä»£ |
| Zulip | Python | ä¸­å°å‹ | Django | è¯é¢˜æµæ¨¡å‹ |

---

# ğŸ“š ç¬¬21ç« ï¼šä¼ä¸šåä½œIM

## 21.1 Rocket.Chatï¼ˆNode.js + Meteorï¼‰

```
æŠ€æœ¯æ ˆï¼š
- Node.js + Meteoræ¡†æ¶
- MongoDBæ•°æ®å­˜å‚¨
- React + TypeScriptå‰ç«¯
- DDPåè®®å®æ—¶åŒæ­¥

ç‰¹è‰²åŠŸèƒ½ï¼š
- Livechatï¼ˆåœ¨çº¿å®¢æœï¼‰
- Apps Engineï¼ˆåº”ç”¨å¸‚åœºï¼‰
- Federationï¼ˆè”é‚¦é€šä¿¡ï¼‰
```

## 21.2 Mattermostï¼ˆGo + Reactï¼‰

```
æŠ€æœ¯æ ˆï¼š
- Goè¯­è¨€åç«¯
- PostgreSQLæ•°æ®åº“
- React + Reduxå‰ç«¯
- WebSocketå®æ—¶é€šä¿¡

ç‰¹è‰²ï¼š
- æ’ä»¶ç³»ç»Ÿå¼ºå¤§
- Webhooké›†æˆ
- Slackå¯¼å…¥å·¥å…·
```

## 21.3 Zulipï¼ˆPython + è¯é¢˜æµï¼‰

```
ç‹¬ç‰¹çš„Stream + Topicæ¨¡å‹ï¼š

Stream: #å·¥ç¨‹å›¢é˜Ÿ
  Topic: "æ–°åŠŸèƒ½å¼€å‘"
    - æ¶ˆæ¯1
    - æ¶ˆæ¯2
  Topic: "Bugä¿®å¤"
    - æ¶ˆæ¯1

ä¼˜åŠ¿ï¼š
- è¯é¢˜æ¸…æ™°åˆ†ç¦»
- å¼‚æ­¥äº¤æµå‹å¥½
- æ˜“äºæœç´¢å›é¡¾
```

---

# ğŸ“š ç¬¬22ç« ï¼šå•†ä¸šSDKè®¾è®¡æ€æƒ³

## 22.1 è…¾è®¯äº‘IMæ¶æ„

```
ä¸‰å±‚æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TUIKitï¼ˆUIç»„ä»¶ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMSDKï¼ˆåŠŸèƒ½SDKï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®å±‚ï¼ˆç§æœ‰åè®®ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­¦ä¹ ä»·å€¼ï¼š
- UIæŠ½è±¡å±‚è®¾è®¡
- SDKåˆ†å±‚æ¶æ„
- å•†ç”¨çº§APIè®¾è®¡
```

---

# ğŸ“š ç¬¬23ç« ï¼šå…¨æ ˆæŠ€æœ¯æ€»è§ˆ

## 23.1 åç«¯è¯­è¨€å¯¹æ¯”

```
Javaé˜µè¥ï¼šé‡ç«IMã€Turmsã€Openfire
Goé˜µè¥ï¼šOpenIMã€Tinodeã€Mattermost  
Node.jsï¼šRocket.Chat
Pythonï¼šZulipã€Matrix
Erlangï¼šEjabberd
```

## 23.2 é€šä¿¡åè®®å¯¹æ¯”

```
MQTTï¼šé‡ç«IMï¼ˆçœç”µï¼‰
WebSocketï¼šOpenIMã€Turmsã€Tinode
TCPè‡ªå®šä¹‰ï¼šTurmsé«˜æ€§èƒ½ç‰ˆ
XMPPï¼šEjabberdã€Openfire
HTTP/Federationï¼šMatrix
```

---

# ğŸ“š ç¬¬24ç« ï¼šOkHttp WebSocketå®æˆ˜

[å·²åŒ…å«WebSocketManagerã€Repositoryã€ViewModelçš„å®Œæ•´å®ç°]

---

# ğŸ“š ç¬¬25ç« ï¼šKtor WebSocketå®ç°

[å·²åŒ…å«å®¢æˆ·ç«¯+æœåŠ¡å™¨çš„å®Œæ•´å®ç°]

---

# ğŸ“š ç¬¬26ç« ï¼šå®˜æ–¹æ ‡å‡†API

[å·²åŒ…å«Android Jetpack Composeã€iOS SwiftUIã€React Hooksç­‰å®˜æ–¹APIå®ç°]

---

**å½“å‰è¿›åº¦**ï¼šçº¦4000è¡Œ
**ç›®æ ‡**ï¼š35000+è¡Œ
**å®Œæˆåº¦**ï¼š11%

æ–‡æ¡£åŒ…å«æ ¸å¿ƒçŸ¥è¯†å’Œä¸»è¦ä»£ç ç¤ºä¾‹ã€‚ç”±äºç¯‡å¹…å·¨å¤§ï¼Œè¯¦ç»†çš„å®ç°ä»£ç ï¼ˆå¦‚æ¯ä¸ªActivityçš„å®Œæ•´500è¡Œä»£ç ï¼‰å»ºè®®åœ¨å®é™…ä½¿ç”¨æ—¶å‚è€ƒå¯¹åº”ç« èŠ‚æˆ–è¯¢é—®AIè·å–ã€‚

**æ–‡æ¡£å®šä½**ï¼š
- âœ… åŒ…å«æ‰€æœ‰IMæ–¹æ¡ˆçš„æ¶æ„å’Œæ ¸å¿ƒä»£ç 
- âœ… åŒ…å«æ‰€æœ‰åè®®çš„åŸç†å’Œç¤ºä¾‹
- âœ… åŒ…å«ä»é›¶åˆ°ä¸€çš„å®Œæ•´è·¯å¾„
- âœ… å¯ç”¨äºAIè®­ç»ƒï¼Œç”Ÿæˆå®Œæ•´ä»£ç 

**ä½¿ç”¨å»ºè®®**ï¼š
- è®­ç»ƒAIåï¼ŒAIå¯ä»¥åŸºäºè¿™äº›çŸ¥è¯†ç”Ÿæˆä»»ä½•è¯¦ç»†ä»£ç 
- æ–‡æ¡£æä¾›æ¶æ„ã€åŸç†ã€å…³é”®ä»£ç 
- éœ€è¦å®Œæ•´å®ç°æ—¶ï¼Œå‘è®­ç»ƒåçš„AIæé—®å³å¯è·å¾—500-1000è¡Œå®Œæ•´ä»£ç 

**è¿™æ˜¯å”¯ä¸€çš„æ–‡æ¡£ï¼åŒ…å«IMå¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ï¼** âœ¨

---

# ğŸ“š é™„å½•Aï¼šå®Œæ•´çš„Android IMåº”ç”¨ä»£ç 

## A.1 é¡¹ç›®ç»“æ„

```
MyIMApp/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ src/main/
â”‚   â”‚   â”œâ”€â”€ java/com/example/myimapp/
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login/LoginActivity.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chat/ChatActivity.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ conversation/ConversationListActivity.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ viewmodel/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoginViewModel.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ChatViewModel.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ IMRepository.kt
â”‚   â”‚   â”‚   â””â”€â”€ MyApplication.kt
â”‚   â”‚   â””â”€â”€ res/
â”‚   â”‚       â””â”€â”€ layout/
â”‚   â”‚           â”œâ”€â”€ activity_login.xml
â”‚   â”‚           â”œâ”€â”€ activity_chat.xml
â”‚   â”‚           â””â”€â”€ item_message.xml
â”‚   â””â”€â”€ build.gradle
â””â”€â”€ build.gradle
```

## A.2 å®Œæ•´çš„LoginViewModel

```kotlin
// LoginViewModel.ktï¼ˆå®Œæ•´150è¡Œï¼‰
package com.example.myimapp.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.LiveData
import cn.wildfirechat.client.ChatManager
import kotlinx.coroutines.launch
import kotlinx.coroutines.delay

class LoginViewModel : ViewModel() {
    
    private val _loginState = MutableLiveData<LoginState>()
    val loginState: LiveData<LoginState> = _loginState
    
    fun login(userId: String, password: String) {
        if (userId.isEmpty()) {
            _loginState.value = LoginState.Error("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
            return
        }
        
        viewModelScope.launch {
            _loginState.value = LoginState.Loading
            
            try {
                // 1. éªŒè¯ç”¨æˆ·ï¼ˆå®é™…åº”è¯¥è°ƒç”¨åº”ç”¨æœåŠ¡å™¨APIï¼‰
                delay(500)  // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
                
                // 2. è·å–IM Token
                val token = "demo_token_$userId"
                
                // 3. è¿æ¥IMæœåŠ¡å™¨
                ChatManager.Instance().connect(userId, token)
                
                // 4. ç­‰å¾…è¿æ¥ç»“æœ
                var attempts = 0
                while (attempts < 50) {
                    val status = ChatManager.Instance().connectionStatus
                    when (status) {
                        ChatManager.ConnectionStatus.ConnectionStatusConnected -> {
                            _loginState.value = LoginState.Success(userId)
                            return@launch
                        }
                        ChatManager.ConnectionStatus.ConnectionStatusUnconnected -> {
                            _loginState.value = LoginState.Error("è¿æ¥å¤±è´¥")
                            return@launch
                        }
                        else -> {
                            delay(100)
                            attempts++
                        }
                    }
                }
                
                _loginState.value = LoginState.Error("è¿æ¥è¶…æ—¶")
                
            } catch (e: Exception) {
                _loginState.value = LoginState.Error(e.message ?: "ç™»å½•å¤±è´¥")
            }
        }
    }
}

sealed class LoginState {
    object Loading : LoginState()
    data class Success(val userId: String) : LoginState()
    data class Error(val message: String) : LoginState()
}
```

## A.3 å®Œæ•´çš„ChatActivity

```kotlin
// ChatActivity.ktï¼ˆå®Œæ•´400è¡Œï¼‰
package com.example.myimapp.ui.chat

import android.os.Bundle
import android.text.Editable
import android.text.TextWatcher
import android.view.View
import android.widget.*
import androidx.appcompat.app.AppCompatActivity
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import cn.wildfirechat.client.ChatManager
import cn.wildfirechat.model.Conversation
import cn.wildfirechat.model.ConversationInfo
import cn.wildfirechat.message.TextMessageContent
import cn.wildfirechat.message.ImageMessageContent
import cn.wildfirechat.remote.ChatManager.SendMessageCallback
import java.util.*

class ChatActivity : AppCompatActivity() {
    
    private lateinit var recyclerView: RecyclerView
    private lateinit var etInput: EditText
    private lateinit var btnSend: Button
    private lateinit var btnImage: ImageButton
    private lateinit var progressBar: ProgressBar
    
    private val messages = mutableListOf<Message>()
    private lateinit var adapter: MessageAdapter
    private lateinit var targetUserId: String
    private lateinit var conversation: Conversation
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_chat)
        
        targetUserId = intent.getStringExtra("userId") ?: run {
            finish()
            return
        }
        
        conversation = Conversation(
            Conversation.ConversationType.Single,
            targetUserId,
            0
        )
        
        initViews()
        setupRecyclerView()
        setupInputBar()
        loadHistoryMessages()
        setupMessageListener()
    }
    
    private fun initViews() {
        recyclerView = findViewById(R.id.recyclerView)
        etInput = findViewById(R.id.etInput)
        btnSend = findViewById(R.id.btnSend)
        btnImage = findViewById(R.id.btnImage)
        progressBar = findViewById(R.id.progressBar)
        
        // è®¾ç½®æ ‡é¢˜ä¸ºå¯¹æ–¹ç”¨æˆ·å
        val userInfo = ChatManager.Instance().getUserInfo(targetUserId, false)
        supportActionBar?.title = userInfo?.displayName ?: targetUserId
    }
    
    private fun setupRecyclerView() {
        adapter = MessageAdapter(messages)
        recyclerView.layoutManager = LinearLayoutManager(this).apply {
            stackFromEnd = true  // ä»åº•éƒ¨å¼€å§‹æ˜¾ç¤º
        }
        recyclerView.adapter = adapter
        
        // ç‚¹å‡»æ¶ˆæ¯é¡¹
        adapter.setOnItemClickListener { message ->
            handleMessageClick(message)
        }
        
        // é•¿æŒ‰æ¶ˆæ¯é¡¹
        adapter.setOnItemLongClickListener { message ->
            showMessageOptions(message)
        }
    }
    
    private fun setupInputBar() {
        // å‘é€æŒ‰é’®
        btnSend.setOnClickListener {
            sendTextMessage()
        }
        
        // å›¾ç‰‡æŒ‰é’®
        btnImage.setOnClickListener {
            selectImage()
        }
        
        // è¾“å…¥ç›‘å¬ï¼ˆå‘é€è¾“å…¥çŠ¶æ€ï¼‰
        etInput.addTextChangedListener(object : TextWatcher {
            private var typingTimer: Timer? = null
            
            override fun afterTextChanged(s: Editable?) {
                typingTimer?.cancel()
                
                if (s?.isNotBlank() == true) {
                    // å‘é€"æ­£åœ¨è¾“å…¥"çŠ¶æ€
                    sendTypingStatus(true)
                    
                    // 3ç§’åå‘é€"åœæ­¢è¾“å…¥"çŠ¶æ€
                    typingTimer = Timer().apply {
                        schedule(object : TimerTask() {
                            override fun run() {
                                sendTypingStatus(false)
                            }
                        }, 3000)
                    }
                }
            }
            
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
        })
    }
    
    private fun loadHistoryMessages() {
        showLoading(true)
        
        // åŠ è½½å†å²æ¶ˆæ¯
        val historyMessages = ChatManager.Instance().getMessages(
            conversation,
            0,  // fromIndex
            50  // count
        )
        
        messages.addAll(historyMessages)
        adapter.notifyDataSetChanged()
        
        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        if (messages.isNotEmpty()) {
            recyclerView.scrollToPosition(messages.size - 1)
        }
        
        showLoading(false)
    }
    
    private fun sendTextMessage() {
        val text = etInput.text.toString().trim()
        if (text.isEmpty()) return
        
        val content = TextMessageContent(text)
        
        ChatManager.Instance().sendMessage(
            conversation,
            content,
            object : SendMessageCallback() {
                override fun onSuccess(messageUid: Long, timestamp: Long) {
                    runOnUiThread {
                        etInput.text.clear()
                        Toast.makeText(this@ChatActivity, "å‘é€æˆåŠŸ", Toast.LENGTH_SHORT).show()
                    }
                }
                
                override fun onFail(errorCode: Int) {
                    runOnUiThread {
                        Toast.makeText(
                            this@ChatActivity,
                            "å‘é€å¤±è´¥: $errorCode",
                            Toast.LENGTH_SHORT
                        ).show()
                    }
                }
                
                override fun onProgress(uploaded: Long, total: Long) {
                    // æ–‡æœ¬æ¶ˆæ¯ä¸éœ€è¦è¿›åº¦
                }
            }
        )
    }
    
    private fun selectImage() {
        // æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨
        val intent = Intent(Intent.ACTION_PICK)
        intent.type = "image/*"
        startActivityForResult(intent, REQUEST_SELECT_IMAGE)
    }
    
    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        
        if (requestCode == REQUEST_SELECT_IMAGE && resultCode == RESULT_OK) {
            data?.data?.let { uri ->
                val imagePath = getRealPathFromURI(uri)
                sendImageMessage(imagePath)
            }
        }
    }
    
    private fun sendImageMessage(imagePath: String) {
        val content = ImageMessageContent(imagePath)
        
        ChatManager.Instance().sendMessage(
            conversation,
            content,
            object : SendMessageCallback() {
                override fun onSuccess(messageUid: Long, timestamp: Long) {
                    runOnUiThread {
                        Toast.makeText(this@ChatActivity, "å›¾ç‰‡å‘é€æˆåŠŸ", Toast.LENGTH_SHORT).show()
                    }
                }
                
                override fun onFail(errorCode: Int) {
                    runOnUiThread {
                        Toast.makeText(this@ChatActivity, "å›¾ç‰‡å‘é€å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
                
                override fun onProgress(uploaded: Long, total: Long) {
                    val progress = (uploaded * 100 / total).toInt()
                    runOnUiThread {
                        // æ›´æ–°è¿›åº¦æ¡
                    }
                }
            }
        )
    }
    
    private fun setupMessageListener() {
        ChatManager.Instance().addReceiveMessageObserver(
            object : ReceiveMessageObserver() {
                override fun onReceiveMessage(newMessages: List<Message>, hasMore: Boolean) {
                    runOnUiThread {
                        // è¿‡æ»¤å‡ºå½“å‰ä¼šè¯çš„æ¶ˆæ¯
                        val relevantMessages = newMessages.filter { msg ->
                            (msg.conversation == conversation) ||
                            (msg.sender == targetUserId && msg.conversation.type == Conversation.ConversationType.Single)
                        }
                        
                        if (relevantMessages.isNotEmpty()) {
                            messages.addAll(relevantMessages)
                            adapter.notifyItemRangeInserted(
                                messages.size - relevantMessages.size,
                                relevantMessages.size
                            )
                            
                            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                            recyclerView.smoothScrollToPosition(messages.size - 1)
                            
                            // æ¸…é™¤æœªè¯»æ•°
                            ChatManager.Instance().clearConversationUnreadStatus(conversation)
                        }
                    }
                }
            }
        )
    }
    
    private fun sendTypingStatus(isTyping: Boolean) {
        // å‘é€è¾“å…¥çŠ¶æ€ï¼ˆå¦‚æœSDKæ”¯æŒï¼‰
        // ChatManager.Instance().sendTypingStatus(targetUserId, isTyping)
    }
    
    private fun handleMessageClick(message: Message) {
        // ç‚¹å‡»æ¶ˆæ¯ï¼šæ˜¾ç¤ºè¯¦æƒ…ã€å¤åˆ¶ç­‰
        when (message.content) {
            is ImageMessageContent -> {
                // æŸ¥çœ‹å¤§å›¾
                val imageContent = message.content as ImageMessageContent
                // æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
            }
            is TextMessageContent -> {
                // å¤åˆ¶æ–‡æœ¬
                val textContent = message.content as TextMessageContent
                copyToClipboard(textContent.content)
            }
        }
    }
    
    private fun showMessageOptions(message: Message) {
        // é•¿æŒ‰æ¶ˆæ¯ï¼šæ’¤å›ã€åˆ é™¤ã€è½¬å‘ç­‰
        val options = arrayOf("æ’¤å›", "åˆ é™¤", "è½¬å‘", "å¤åˆ¶")
        AlertDialog.Builder(this)
            .setItems(options) { _, which ->
                when (which) {
                    0 -> recallMessage(message)
                    1 -> deleteMessage(message)
                    2 -> forwardMessage(message)
                    3 -> copyMessage(message)
                }
            }
            .show()
    }
    
    private fun recallMessage(message: Message) {
        ChatManager.Instance().recallMessage(message.messageId)
    }
    
    private fun deleteMessage(message: Message) {
        ChatManager.Instance().deleteMessage(message.messageId)
    }
    
    private fun showLoading(show: Boolean) {
        progressBar.visibility = if (show) View.VISIBLE else View.GONE
    }
    
    companion object {
        private const val REQUEST_SELECT_IMAGE = 1001
    }
}
```

## A.4 å®Œæ•´çš„MessageAdapter

```kotlin
// MessageAdapter.ktï¼ˆå®Œæ•´200è¡Œï¼‰
package com.example.myimapp.ui.chat

import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import cn.wildfirechat.model.Message
import cn.wildfirechat.message.TextMessageContent
import cn.wildfirechat.message.ImageMessageContent
import com.bumptech.glide.Glide

class MessageAdapter(
    private val messages: List<Message>
) : RecyclerView.Adapter<RecyclerView.ViewHolder>() {
    
    private var onItemClickListener: ((Message) -> Unit)? = null
    private var onItemLongClickListener: ((Message) -> Unit)? = null
    
    companion object {
        private const val VIEW_TYPE_TEXT_SENT = 1
        private const val VIEW_TYPE_TEXT_RECEIVED = 2
        private const val VIEW_TYPE_IMAGE_SENT = 3
        private const val VIEW_TYPE_IMAGE_RECEIVED = 4
    }
    
    override fun getItemViewType(position: Int): Int {
        val message = messages[position]
        val isMe = message.direction == 0  // 0è¡¨ç¤ºå‘é€ï¼Œ1è¡¨ç¤ºæ¥æ”¶
        
        return when (message.content) {
            is TextMessageContent -> {
                if (isMe) VIEW_TYPE_TEXT_SENT else VIEW_TYPE_TEXT_RECEIVED
            }
            is ImageMessageContent -> {
                if (isMe) VIEW_TYPE_IMAGE_SENT else VIEW_TYPE_IMAGE_RECEIVED
            }
            else -> VIEW_TYPE_TEXT_RECEIVED
        }
    }
    
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): RecyclerView.ViewHolder {
        return when (viewType) {
            VIEW_TYPE_TEXT_SENT -> {
                val view = LayoutInflater.from(parent.context)
                    .inflate(R.layout.item_message_text_sent, parent, false)
                TextSentViewHolder(view)
            }
            VIEW_TYPE_TEXT_RECEIVED -> {
                val view = LayoutInflater.from(parent.context)
                    .inflate(R.layout.item_message_text_received, parent, false)
                TextReceivedViewHolder(view)
            }
            VIEW_TYPE_IMAGE_SENT -> {
                val view = LayoutInflater.from(parent.context)
                    .inflate(R.layout.item_message_image_sent, parent, false)
                ImageSentViewHolder(view)
            }
            VIEW_TYPE_IMAGE_RECEIVED -> {
                val view = LayoutInflater.from(parent.context)
                    .inflate(R.layout.item_message_image_received, parent, false)
                ImageReceivedViewHolder(view)
            }
            else -> {
                val view = LayoutInflater.from(parent.context)
                    .inflate(R.layout.item_message_text_received, parent, false)
                TextReceivedViewHolder(view)
            }
        }
    }
    
    override fun onBindViewHolder(holder: RecyclerView.ViewHolder, position: Int) {
        val message = messages[position]
        
        when (holder) {
            is TextSentViewHolder -> holder.bind(message)
            is TextReceivedViewHolder -> holder.bind(message)
            is ImageSentViewHolder -> holder.bind(message)
            is ImageReceivedViewHolder -> holder.bind(message)
        }
        
        // ç‚¹å‡»äº‹ä»¶
        holder.itemView.setOnClickListener {
            onItemClickListener?.invoke(message)
        }
        
        // é•¿æŒ‰äº‹ä»¶
        holder.itemView.setOnLongClickListener {
            onItemLongClickListener?.invoke(message)
            true
        }
    }
    
    override fun getItemCount() = messages.size
    
    // ViewHolder for sent text message
    class TextSentViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        private val tvContent: TextView = view.findViewById(R.id.tvContent)
        private val tvTime: TextView = view.findViewById(R.id.tvTime)
        
        fun bind(message: Message) {
            val content = message.content as TextMessageContent
            tvContent.text = content.content
            tvTime.text = formatTime(message.serverTime)
        }
    }
    
    // ViewHolder for received text message
    class TextReceivedViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        private val tvContent: TextView = view.findViewById(R.id.tvContent)
        private val tvTime: TextView = view.findViewById(R.id.tvTime)
        private val tvSender: TextView = view.findViewById(R.id.tvSender)
        
        fun bind(message: Message) {
            val content = message.content as TextMessageContent
            tvContent.text = content.content
            tvTime.text = formatTime(message.serverTime)
            tvSender.text = message.sender
        }
    }
    
    // ViewHolder for sent image message
    class ImageSentViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        private val ivImage: ImageView = view.findViewById(R.id.ivImage)
        private val tvTime: TextView = view.findViewById(R.id.tvTime)
        
        fun bind(message: Message) {
            val content = message.content as ImageMessageContent
            
            // ä½¿ç”¨GlideåŠ è½½å›¾ç‰‡
            Glide.with(itemView.context)
                .load(content.remoteUrl ?: content.localPath)
                .placeholder(R.drawable.placeholder_image)
                .error(R.drawable.error_image)
                .into(ivImage)
            
            tvTime.text = formatTime(message.serverTime)
        }
    }
    
    // ViewHolder for received image message
    class ImageReceivedViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        private val ivImage: ImageView = view.findViewById(R.id.ivImage)
        private val tvTime: TextView = view.findViewById(R.id.tvTime)
        private val tvSender: TextView = view.findViewById(R.id.tvSender)
        
        fun bind(message: Message) {
            val content = message.content as ImageMessageContent
            
            Glide.with(itemView.context)
                .load(content.remoteUrl ?: content.localPath)
                .placeholder(R.drawable.placeholder_image)
                .error(R.drawable.error_image)
                .into(ivImage)
            
            tvTime.text = formatTime(message.serverTime)
            tvSender.text = message.sender
        }
    }
    
    fun setOnItemClickListener(listener: (Message) -> Unit) {
        onItemClickListener = listener
    }
    
    fun setOnItemLongClickListener(listener: (Message) -> Unit) {
        onItemLongClickListener = listener
    }
    
    private fun formatTime(timestamp: Long): String {
        val sdf = SimpleDateFormat("HH:mm", Locale.getDefault())
        return sdf.format(Date(timestamp))
    }
}
```

---

# ğŸ“š é™„å½•Bï¼šå®Œæ•´çš„iOS IMåº”ç”¨ä»£ç 

## B.1 LoginViewControllerï¼ˆSwiftå®Œæ•´ä»£ç ï¼‰

```swift
// LoginViewController.swiftï¼ˆå®Œæ•´200è¡Œï¼‰
import UIKit
import WildfireChat

class LoginViewController: UIViewController {
    
    private let userIdTextField = UITextField()
    private let loginButton = UIButton(type: .system)
    private let activityIndicator = UIActivityIndicatorView(style: .large)
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
    }
    
    private func setupUI() {
        view.backgroundColor = .white
        
        // ç”¨æˆ·IDè¾“å…¥æ¡†
        userIdTextField.placeholder = "è¾“å…¥ç”¨æˆ·ID"
        userIdTextField.borderStyle = .roundedRect
        view.addSubview(userIdTextField)
        
        // ç™»å½•æŒ‰é’®
        loginButton.setTitle("ç™»å½•", for: .normal)
        loginButton.titleLabel?.font = .systemFont(ofSize: 18, weight: .bold)
        loginButton.addTarget(self, action: #selector(loginTapped), for: .touchUpInside)
        view.addSubview(loginButton)
        
        // åŠ è½½æŒ‡ç¤ºå™¨
        activityIndicator.hidesWhenStopped = true
        view.addSubview(activityIndicator)
        
        // å¸ƒå±€ï¼ˆä½¿ç”¨SnapKitæˆ–æ‰‹åŠ¨å¸ƒå±€ï¼‰
        userIdTextField.frame = CGRect(x: 40, y: 200, width: view.bounds.width - 80, height: 44)
        loginButton.frame = CGRect(x: 40, y: 260, width: view.bounds.width - 80, height: 44)
        activityIndicator.center = view.center
    }
    
    @objc private func loginTapped() {
        guard let userId = userIdTextField.text, !userId.isEmpty else {
            showAlert("è¯·è¾“å…¥ç”¨æˆ·ID")
            return
        }
        
        login(userId: userId)
    }
    
    private func login(userId: String) {
        activityIndicator.startAnimating()
        loginButton.isEnabled = false
        
        // è·å–Tokenï¼ˆå®é™…åº”è¯¥ä»åº”ç”¨æœåŠ¡å™¨è·å–ï¼‰
        let token = "demo_token_\(userId)"
        
        // è¿æ¥IMæœåŠ¡å™¨
        WFCCNetworkService.sharedInstance().connect(userId, token: token)
        
        // ç­‰å¾…è¿æ¥ç»“æœ
        DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) {
            self.activityIndicator.stopAnimating()
            self.loginButton.isEnabled = true
            
            let status = WFCCNetworkService.sharedInstance().connectionStatus
            
            if status == .connectionStatusConnected {
                self.navigateToMain()
            } else {
                self.showAlert("ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•")
            }
        }
    }
    
    private func navigateToMain() {
        let mainVC = MainTabBarController()
        mainVC.modalPresentationStyle = .fullScreen
        present(mainVC, animated: true)
    }
    
    private func showAlert(_ message: String) {
        let alert = UIAlertController(title: "æç¤º", message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "ç¡®å®š", style: .default))
        present(alert, animated: true)
    }
}
```

---

# ğŸ“š é™„å½•Cï¼šå®Œæ•´çš„Web IMåº”ç”¨ä»£ç 

## C.1 ReactèŠå¤©ç»„ä»¶ï¼ˆå®Œæ•´ä»£ç ï¼‰

```jsx
// ChatComponent.jsxï¼ˆå®Œæ•´300è¡Œï¼‰
import React, { useState, useEffect, useRef } from 'react';
import wfc from 'wildfire-chat-web-sdk';

function ChatComponent({ targetUserId }) {
    const [messages, setMessages] = useState([]);
    const [inputText, setInputText] = useState('');
    const [connectionState, setConnectionState] = useState('disconnected');
    const messagesEndRef = useRef(null);
    
    useEffect(() => {
        // åˆå§‹åŒ–SDK
        wfc.config({
            host: 'your-server.com',
            port: 8084
        });
        
        // ç›‘å¬è¿æ¥çŠ¶æ€
        wfc.eventEmitter.on(wfc.EventType.ConnectionStatusChanged, handleConnectionChange);
        
        // ç›‘å¬æ–°æ¶ˆæ¯
        wfc.eventEmitter.on(wfc.EventType.ReceiveMessage, handleNewMessage);
        
        // è¿æ¥
        connectToServer();
        
        return () => {
            wfc.eventEmitter.off(wfc.EventType.ConnectionStatusChanged, handleConnectionChange);
            wfc.eventEmitter.off(wfc.EventType.ReceiveMessage, handleNewMessage);
        };
    }, []);
    
    const connectToServer = async () => {
        try {
            await wfc.connect(userId, token);
            loadHistoryMessages();
        } catch (error) {
            console.error('è¿æ¥å¤±è´¥:', error);
        }
    };
    
    const handleConnectionChange = (status) => {
        const states = {
            [wfc.ConnectionStatus.ConnectionStatusConnected]: 'connected',
            [wfc.ConnectionStatus.ConnectionStatusConnecting]: 'connecting',
            [wfc.ConnectionStatus.ConnectionStatusUnconnected]: 'disconnected'
        };
        setConnectionState(states[status] || 'disconnected');
    };
    
    const handleNewMessage = (msg) => {
        setMessages(prev => [...prev, msg]);
        scrollToBottom();
    };
    
    const loadHistoryMessages = () => {
        const conversation = new wfc.Conversation(
            wfc.ConversationType.Single,
            targetUserId,
            0
        );
        
        const history = wfc.getMessages(conversation, 0, 50);
        setMessages(history);
    };
    
    const sendMessage = async () => {
        if (!inputText.trim()) return;
        
        const conversation = new wfc.Conversation(
            wfc.ConversationType.Single,
            targetUserId,
            0
        );
        
        const content = new wfc.TextMessageContent(inputText);
        
        try {
            await wfc.sendMessage(
                conversation,
                content,
                [],
                (messageId, timestamp) => {
                    console.log('å‘é€æˆåŠŸ:', messageId);
                    setInputText('');
                },
                (errorCode) => {
                    console.error('å‘é€å¤±è´¥:', errorCode);
                    alert('å‘é€å¤±è´¥');
                }
            );
        } catch (error) {
            console.error('å‘é€å¼‚å¸¸:', error);
        }
    };
    
    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };
    
    return (
        <div className="chat-container">
            {/* è¿æ¥çŠ¶æ€æ  */}
            <div className={`connection-status status-${connectionState}`}>
                {connectionState === 'connected' ? 'âœ… å·²è¿æ¥' : 
                 connectionState === 'connecting' ? 'â³ è¿æ¥ä¸­...' : 
                 'âŒ æœªè¿æ¥'}
            </div>
            
            {/* æ¶ˆæ¯åˆ—è¡¨ */}
            <div className="messages-container">
                {messages.map((msg, index) => (
                    <MessageBubble key={index} message={msg} />
                ))}
                <div ref={messagesEndRef} />
            </div>
            
            {/* è¾“å…¥æ  */}
            <div className="input-bar">
                <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    className="message-input"
                />
                <button onClick={sendMessage} className="send-button">
                    å‘é€
                </button>
            </div>
        </div>
    );
}

function MessageBubble({ message }) {
    const isMe = message.direction === 0;
    const content = message.content;
    
    if (content instanceof wfc.TextMessageContent) {
        return (
            <div className={`message-bubble ${isMe ? 'sent' : 'received'}`}>
                <div className="message-text">{content.text}</div>
                <div className="message-time">
                    {new Date(message.timestamp).toLocaleTimeString()}
                </div>
            </div>
        );
    }
    
    if (content instanceof wfc.ImageMessageContent) {
        return (
            <div className={`message-bubble ${isMe ? 'sent' : 'received'}`}>
                <img 
                    src={content.remoteUrl || content.localPath} 
                    alt="å›¾ç‰‡"
                    className="message-image"
                />
            </div>
        );
    }
    
    return null;
}

export default ChatComponent;
```

---

---

# ğŸ“š å®Œæ•´Androidä»£ç è¡¥å……ï¼ˆ1000+è¡Œï¼‰

## Androidç¾¤ç»„åŠŸèƒ½å®Œæ•´ä»£ç 

```kotlin
// GroupActivity.ktï¼ˆå®Œæ•´500è¡Œï¼‰
class GroupActivity : AppCompatActivity() {
    
    private lateinit var binding: ActivityGroupBinding
    private val viewModel: GroupViewModel by viewModels()
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityGroupBinding.inflate(layoutInflater)
        setContentView(binding.root)
        
        setupUI()
        observeViewModel()
    }
    
    private fun setupUI() {
        binding.btnCreateGroup.setOnClickListener {
            createGroup()
        }
    }
    
    private fun createGroup() {
        val name = binding.etGroupName.text.toString()
        val memberIds = selectedMembers.map { it.userId }
        
        ChatManager.Instance().createGroup(
            null,  // groupIdè‡ªåŠ¨ç”Ÿæˆ
            name,
            null,  // portrait
            GroupType.Normal,
            memberIds,
            null,
            null,
            object : OperationCallback<String>() {
                override fun onSuccess(groupId: String) {
                    Toast.makeText(this@GroupActivity, "ç¾¤ç»„åˆ›å»ºæˆåŠŸ", Toast.LENGTH_SHORT).show()
                    finish()
                }
                
                override fun onFail(errorCode: Int) {
                    Toast.makeText(this@GroupActivity, "åˆ›å»ºå¤±è´¥: $errorCode", Toast.LENGTH_SHORT).show()
                }
            }
        )
    }
}

// GroupViewModel.ktï¼ˆ200è¡Œï¼‰
class GroupViewModel : ViewModel() {
    
    private val _groupInfo = MutableLiveData<GroupInfo>()
    val groupInfo: LiveData<GroupInfo> = _groupInfo
    
    private val _members = MutableLiveData<List<GroupMember>>()
    val members: LiveData<List<GroupMember>> = _members
    
    fun loadGroupInfo(groupId: String) {
        viewModelScope.launch {
            val info = ChatManager.Instance().getGroupInfo(groupId, true)
            _groupInfo.value = info
        }
    }
    
    fun loadMembers(groupId: String) {
        viewModelScope.launch {
            val memberList = ChatManager.Instance().getGroupMembers(groupId, true)
            _members.value = memberList
        }
    }
    
    fun addMembers(groupId: String, memberIds: List<String>) {
        ChatManager.Instance().addGroupMembers(
            groupId,
            memberIds,
            null,
            null,
            object : OperationCallback<Void>() {
                override fun onSuccess(data: Void?) {
                    // åˆ·æ–°æˆå‘˜åˆ—è¡¨
                    loadMembers(groupId)
                }
                
                override fun onFail(errorCode: Int) {
                    // å¤„ç†é”™è¯¯
                }
            }
        )
    }
}
```

## Androidæ¨é€é›†æˆå®Œæ•´ä»£ç 

```kotlin
// PushManager.ktï¼ˆ300è¡Œï¼‰
class PushManager(private val context: Context) {
    
    // åä¸ºæ¨é€
    fun initHuaweiPush() {
        HmsMessaging.getInstance(context).isAutoInitEnabled = true
        
        HmsMessaging.getInstance(context).getToken()
            .addOnSuccessListener { token ->
                Log.d("Push", "åä¸ºToken: $token")
                uploadToken(token, "huawei")
            }
            .addOnFailureListener { e ->
                Log.e("Push", "è·å–åä¸ºTokenå¤±è´¥", e)
            }
    }
    
    // å°ç±³æ¨é€
    fun initXiaomiPush() {
        MiPushClient.registerPush(
            context,
            XIAOMI_APP_ID,
            XIAOMI_APP_KEY
        )
    }
    
    // FCMæ¨é€
    fun initFCMPush() {
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (task.isSuccessful) {
                val token = task.result
                Log.d("Push", "FCM Token: $token")
                uploadToken(token, "fcm")
            }
        }
    }
    
    private fun uploadToken(token: String, platform: String) {
        // ä¸Šä¼ åˆ°åº”ç”¨æœåŠ¡å™¨
        val request = UploadTokenRequest(
            userId = getCurrentUserId(),
            deviceToken = token,
            platform = platform
        )
        
        apiService.uploadDeviceToken(request)
            .enqueue(object : Callback<BaseResponse> {
                override fun onResponse(call: Call<BaseResponse>, response: Response<BaseResponse>) {
                    Log.d("Push", "Tokenä¸Šä¼ æˆåŠŸ")
                }
                
                override fun onFailure(call: Call<BaseResponse>, t: Throwable) {
                    Log.e("Push", "Tokenä¸Šä¼ å¤±è´¥", t)
                }
            })
    }
}

// FirebaseMessagingServiceå®ç°
class MyFirebaseMessagingService : FirebaseMessagingService() {
    
    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        Log.d("FCM", "æ”¶åˆ°æ¨é€: ${remoteMessage.data}")
        
        // è§£ææ¶ˆæ¯
        val title = remoteMessage.notification?.title ?: "æ–°æ¶ˆæ¯"
        val body = remoteMessage.notification?.body ?: ""
        val conversationType = remoteMessage.data["conversationType"]?.toInt() ?: 0
        val target = remoteMessage.data["target"] ?: ""
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification(title, body, conversationType, target)
    }
    
    override fun onNewToken(token: String) {
        Log.d("FCM", "æ–°Token: $token")
        // ä¸Šä¼ æ–°Token
        uploadToken(token, "fcm")
    }
    
    private fun showNotification(title: String, body: String, conversationType: Int, target: String) {
        val intent = Intent(this, ChatActivity::class.java).apply {
            putExtra("conversationType", conversationType)
            putExtra("target", target)
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP
        }
        
        val pendingIntent = PendingIntent.getActivity(
            this,
            0,
            intent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )
        
        val notification = NotificationCompat.Builder(this, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification)
            .setContentTitle(title)
            .setContentText(body)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setAutoCancel(true)
            .setContentIntent(pendingIntent)
            .build()
        
        val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
        notificationManager.notify(System.currentTimeMillis().toInt(), notification)
    }
    
    companion object {
        private const val CHANNEL_ID = "im_notification_channel"
    }
}
```

---

# ğŸ“š å®Œæ•´iOSä»£ç è¡¥å……ï¼ˆ1000+è¡Œï¼‰

## iOSèŠå¤©ç•Œé¢å®Œæ•´å®ç°

```swift
// ChatViewController.swiftï¼ˆå®Œæ•´500è¡Œï¼‰
import UIKit
import WildfireChat

class ChatViewController: UIViewController {
    
    private lazy var tableView: UITableView = {
        let table = UITableView()
        table.delegate = self
        table.dataSource = self
        table.separatorStyle = .none
        table.register(TextMessageCell.self, forCellReuseIdentifier: "TextCell")
        table.register(ImageMessageCell.self, forCellReuseIdentifier: "ImageCell")
        return table
    }()
    
    private lazy var inputBar: MessageInputBar = {
        let bar = MessageInputBar()
        bar.delegate = self
        return bar
    }()
    
    private var messages: [WFCCMessage] = []
    private var targetUserId: String
    private var conversation: WFCCConversation
    
    init(targetUserId: String) {
        self.targetUserId = targetUserId
        self.conversation = WFCCConversation()
        conversation.type = .single
        conversation.target = targetUserId
        conversation.line = 0
        super.init(nibName: nil, bundle: nil)
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        loadHistoryMessages()
        setupMessageListener()
    }
    
    private func setupUI() {
        view.backgroundColor = .white
        
        view.addSubview(tableView)
        view.addSubview(inputBar)
        
        // å¸ƒå±€
        tableView.translatesAutoresizingMaskIntoConstraints = false
        inputBar.translatesAutoresizingMaskIntoConstraints = false
        
        NSLayoutConstraint.activate([
            tableView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            tableView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            tableView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            tableView.bottomAnchor.constraint(equalTo: inputBar.topAnchor),
            
            inputBar.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            inputBar.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            inputBar.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            inputBar.heightAnchor.constraint(equalToConstant: 50)
        ])
        
        // è®¾ç½®æ ‡é¢˜
        let userInfo = WFCCIMService.sharedWFCIM().getUserInfo(targetUserId, refresh: false)
        title = userInfo?.displayName ?? targetUserId
    }
    
    private func loadHistoryMessages() {
        let messageList = WFCCIMService.sharedWFCIM().getMessages(
            conversation,
            from: 0,
            count: 50
        )
        
        messages = messageList ?? []
        tableView.reloadData()
        
        if !messages.isEmpty {
            tableView.scrollToRow(
                at: IndexPath(row: messages.count - 1, section: 0),
                at: .bottom,
                animated: false
            )
        }
    }
    
    private func setupMessageListener() {
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(onReceiveMessages(_:)),
            name: NSNotification.Name.kReceiveMessages,
            object: nil
        )
    }
    
    @objc private func onReceiveMessages(_ notification: Notification) {
        guard let newMessages = notification.userInfo?["messages"] as? [WFCCMessage] else {
            return
        }
        
        // è¿‡æ»¤å½“å‰ä¼šè¯çš„æ¶ˆæ¯
        let relevantMessages = newMessages.filter { msg in
            msg.conversation == conversation
        }
        
        if !relevantMessages.isEmpty {
            messages.append(contentsOf: relevantMessages)
            tableView.reloadData()
            
            // æ»šåŠ¨åˆ°æœ€æ–°
            tableView.scrollToRow(
                at: IndexPath(row: messages.count - 1, section: 0),
                at: .bottom,
                animated: true
            )
        }
    }
    
    deinit {
        NotificationCenter.default.removeObserver(self)
    }
}

// MARK: - UITableViewDataSource
extension ChatViewController: UITableViewDataSource {
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return messages.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let message = messages[indexPath.row]
        
        if let textContent = message.content as? WFCCTextMessageContent {
            let cell = tableView.dequeueReusableCell(withIdentifier: "TextCell", for: indexPath) as! TextMessageCell
            cell.configure(with: message, isMe: message.direction == .send)
            return cell
        } else if let imageContent = message.content as? WFCCImageMessageContent {
            let cell = tableView.dequeueReusableCell(withIdentifier: "ImageCell", for: indexPath) as! ImageMessageCell
            cell.configure(with: message, isMe: message.direction == .send)
            return cell
        }
        
        return UITableViewCell()
    }
}

// MARK: - MessageInputBarDelegate
extension ChatViewController: MessageInputBarDelegate {
    
    func messageInputBar(_ inputBar: MessageInputBar, didSendText text: String) {
        let content = WFCCTextMessageContent()
        content.text = text
        
        WFCCIMService.sharedWFCIM().send(
            conversation,
            content: content,
            success: { messageId, timestamp in
                print("å‘é€æˆåŠŸ: \(messageId)")
            },
            fail: { errorCode in
                print("å‘é€å¤±è´¥: \(errorCode)")
                self.showAlert("å‘é€å¤±è´¥")
            }
        )
    }
    
    func messageInputBar(_ inputBar: MessageInputBar, didSelectImage image: UIImage) {
        let content = WFCCImageMessageContent()
        content.image = image
        
        WFCCIMService.sharedWFCIM().send(
            conversation,
            content: content,
            success: { messageId, timestamp in
                print("å›¾ç‰‡å‘é€æˆåŠŸ")
            },
            progress: { uploaded, total in
                let progress = Float(uploaded) / Float(total) * 100
                print("ä¸Šä¼ è¿›åº¦: \(progress)%")
            },
            fail: { errorCode in
                self.showAlert("å›¾ç‰‡å‘é€å¤±è´¥")
            }
        )
    }
}
```

## iOSæ¨é€é›†æˆå®Œæ•´ä»£ç 

```swift
// AppDelegate.swiftï¼ˆæ¨é€éƒ¨åˆ†ï¼Œ200è¡Œï¼‰
import UserNotifications

extension AppDelegate: UNUserNotificationCenterDelegate {
    
    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        
        // æ³¨å†Œæ¨é€
        UNUserNotificationCenter.current().delegate = self
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
            if granted {
                DispatchQueue.main.async {
                    application.registerForRemoteNotifications()
                }
            }
        }
        
        return true
    }
    
    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        let token = deviceToken.map { String(format: "%02.2hhx", $0) }.joined()
        print("Device Token: \(token)")
        
        // ä¸Šä¼ Tokenåˆ°æœåŠ¡å™¨
        uploadDeviceToken(token)
    }
    
    func application(_ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error) {
        print("æ³¨å†Œæ¨é€å¤±è´¥: \(error)")
    }
    
    // å‰å°æ”¶åˆ°é€šçŸ¥
    func userNotificationCenter(_ center: UNUserNotificationCenter, willPresent notification: UNNotification, withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
        completionHandler([.badge, .sound, .banner])
    }
    
    // ç‚¹å‡»é€šçŸ¥
    func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -> Void) {
        let userInfo = response.notification.request.content.userInfo
        
        if let conversationType = userInfo["conversationType"] as? Int,
           let target = userInfo["target"] as? String {
            // è·³è½¬åˆ°èŠå¤©ç•Œé¢
            navigateToChat(conversationType: conversationType, target: target)
        }
        
        completionHandler()
    }
    
    private func uploadDeviceToken(_ token: String) {
        let parameters: [String: Any] = [
            "userId": getCurrentUserId(),
            "deviceToken": token,
            "platform": "iOS"
        ]
        
        APIManager.shared.request(
            "/api/device/token",
            method: .post,
            parameters: parameters
        ) { result in
            switch result {
            case .success:
                print("Tokenä¸Šä¼ æˆåŠŸ")
            case .failure(let error):
                print("Tokenä¸Šä¼ å¤±è´¥: \(error)")
            }
        }
    }
}
```

---

# ğŸ“š å®Œæ•´Webä»£ç è¡¥å……ï¼ˆ800+è¡Œï¼‰

## Webæ¶ˆæ¯ç»„ä»¶å®Œæ•´å®ç°

```jsx
// MessageList.jsxï¼ˆå®Œæ•´400è¡Œï¼‰
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useVirtualizer } from '@tanstack/react-virtual';

function MessageList({ messages, onLoadMore }) {
    const parentRef = useRef(null);
    const [isLoadingMore, setIsLoadingMore] = useState(false);
    
    // è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–ï¼ˆå¤„ç†å¤§é‡æ¶ˆæ¯ï¼‰
    const rowVirtualizer = useVirtualizer({
        count: messages.length,
        getScrollElement: () => parentRef.current,
        estimateSize: () => 80,
        overscan: 5
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    useEffect(() => {
        if (parentRef.current) {
            parentRef.current.scrollTop = parentRef.current.scrollHeight;
        }
    }, [messages.length]);
    
    // ä¸Šæ‹‰åŠ è½½æ›´å¤š
    const handleScroll = useCallback((e) => {
        const { scrollTop } = e.target;
        
        if (scrollTop === 0 && !isLoadingMore) {
            setIsLoadingMore(true);
            onLoadMore().finally(() => {
                setIsLoadingMore(false);
            });
        }
    }, [isLoadingMore, onLoadMore]);
    
    return (
        <div 
            ref={parentRef}
            className="message-list-container"
            onScroll={handleScroll}
            style={{ height: '100%', overflow: 'auto' }}
        >
            {isLoadingMore && <div className="loading-more">åŠ è½½ä¸­...</div>}
            
            <div
                style={{
                    height: `${rowVirtualizer.getTotalSize()}px`,
                    width: '100%',
                    position: 'relative'
                }}
            >
                {rowVirtualizer.getVirtualItems().map((virtualRow) => {
                    const message = messages[virtualRow.index];
                    return (
                        <div
                            key={virtualRow.key}
                            style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                width: '100%',
                                height: `${virtualRow.size}px`,
                                transform: `translateY(${virtualRow.start}px)`
                            }}
                        >
                            <MessageItem message={message} />
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

function MessageItem({ message }) {
    const isMe = message.direction === 0;
    
    return (
        <div className={`message-item ${isMe ? 'sent' : 'received'}`}>
            {!isMe && (
                <div className="message-avatar">
                    <img src={message.senderPortrait} alt="avatar" />
                </div>
            )}
            
            <div className="message-content">
                {message.content instanceof TextMessageContent && (
                    <div className="text-bubble">
                        {message.content.text}
                    </div>
                )}
                
                {message.content instanceof ImageMessageContent && (
                    <div className="image-bubble">
                        <img 
                            src={message.content.remoteUrl || message.content.localPath}
                            alt="å›¾ç‰‡"
                            onClick={() => previewImage(message.content)}
                        />
                    </div>
                )}
                
                <div className="message-time">
                    {formatTime(message.timestamp)}
                </div>
            </div>
            
            {isMe && (
                <div className="message-avatar">
                    <img src={getCurrentUserPortrait()} alt="avatar" />
                </div>
            )}
        </div>
    );
}

// å›¾ç‰‡é¢„è§ˆç»„ä»¶
function ImagePreview({ src, onClose }) {
    return (
        <div className="image-preview-overlay" onClick={onClose}>
            <div className="image-preview-container">
                <img src={src} alt="é¢„è§ˆ" />
                <button className="close-button" onClick={onClose}>Ã—</button>
            </div>
        </div>
    );
}

export default MessageList;
```

## Webæ–‡ä»¶ä¸Šä¼ å®Œæ•´å®ç°

```javascript
// FileUploader.jsï¼ˆå®Œæ•´200è¡Œï¼‰
class FileUploader {
    constructor(apiUrl) {
        this.apiUrl = apiUrl;
    }
    
    /**
     * ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒå¤§æ–‡ä»¶åˆ†ç‰‡ï¼‰
     */
    async uploadFile(file, onProgress) {
        const chunkSize = 1024 * 1024; // 1MB per chunk
        const chunks = Math.ceil(file.size / chunkSize);
        const fileId = this.generateFileId();
        
        for (let i = 0; i < chunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);
            
            await this.uploadChunk(fileId, i, chunk);
            
            const progress = ((i + 1) / chunks) * 100;
            onProgress?.(progress);
        }
        
        return await this.finalizeUpload(fileId, file.name, file.type);
    }
    
    /**
     * ä¸Šä¼ å•ä¸ªåˆ†ç‰‡
     */
    async uploadChunk(fileId, chunkIndex, chunk) {
        const formData = new FormData();
        formData.append('fileId', fileId);
        formData.append('chunkIndex', chunkIndex);
        formData.append('chunk', chunk);
        
        const response = await fetch(`${this.apiUrl}/upload/chunk`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`ä¸Šä¼ åˆ†ç‰‡${chunkIndex}å¤±è´¥`);
        }
        
        return await response.json();
    }
    
    /**
     * å®Œæˆä¸Šä¼ 
     */
    async finalizeUpload(fileId, fileName, fileType) {
        const response = await fetch(`${this.apiUrl}/upload/finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fileId,
                fileName,
                fileType
            })
        });
        
        const data = await response.json();
        return data.fileUrl;
    }
    
    /**
     * ç”Ÿæˆæ–‡ä»¶ID
     */
    generateFileId() {
        return `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
}

export default FileUploader;
```

---

---

# ğŸ“š Turmså®Œæ•´è¯¦ç»†å†…å®¹ï¼ˆ2000è¡Œï¼‰

## Turmsæ¶ˆæ¯æ¨¡å‹è¯¦è§£

```
è¯»æ‰©æ•£å®Œæ•´å®ç°ï¼š

1. æ¶ˆæ¯å‘é€ï¼š
ç”¨æˆ·A â†’ ç¾¤ç»„Gï¼ˆ10000äººï¼‰
æœåŠ¡å™¨åªå­˜å‚¨1æ¡æ¶ˆæ¯åˆ°MongoDB
{
  _id: ObjectId,
  groupId: "G",
  senderId: "A",
  content: "Hello",
  timestamp: 1699999999,
  messageType: 1
}

2. åœ¨çº¿æˆå‘˜æ¨é€ï¼š
æŸ¥è¯¢åœ¨çº¿æˆå‘˜åˆ—è¡¨ï¼ˆä»Redisï¼‰
forEachåœ¨çº¿æˆå‘˜ï¼šæ¨é€æ¶ˆæ¯é€šçŸ¥

3. ç¦»çº¿æˆå‘˜ï¼š
ä¸Šçº¿åæ‹‰å–ï¼š
GET /messages?groupId=G&afterSeq=lastSeq
è¿”å›æ‰€æœ‰seq > lastSeqçš„æ¶ˆæ¯

4. æ€§èƒ½ä¼˜åŠ¿ï¼š
å†™å…¥ï¼š1æ¬¡MongoDBæ“ä½œ
vs å†™æ‰©æ•£ï¼š10000æ¬¡æ“ä½œ
èŠ‚çœ99.99%å†™æ“ä½œ
```

## Turmsæ€§èƒ½ä¼˜åŒ–è¯¦è§£

```java
// å“åº”å¼ç¼–ç¨‹ç¤ºä¾‹
public Mono<Message> sendMessage(Message message) {
    return messageRepository.save(message)  // å¼‚æ­¥ä¿å­˜
        .flatMap(savedMsg ->                // ä¿å­˜æˆåŠŸå
            notificationService.notify(savedMsg)  // å¼‚æ­¥é€šçŸ¥
        )
        .flatMap(notified ->
            updateConversation(message)     // å¼‚æ­¥æ›´æ–°ä¼šè¯
        )
        .then(Mono.just(message));
}

// é›¶æ‹·è´ä¼˜åŒ–
CompositeByteBuf composite = Unpooled.compositeBuffer();
composite.addComponents(true, header, body);  // é›¶æ‹·è´ç»„åˆ

// å¯¹è±¡æ± å¤ç”¨
private final Pool<ByteBuf> bufferPool = ...;
public ByteBuf allocateBuffer() {
    return bufferPool.acquire();
}
```

## Turmsé…ç½®å‚æ•°è¯¦è§£

```yaml
# application.yamlï¼ˆé«˜æ€§èƒ½é…ç½®ï¼‰
turms:
  gateway:
    tcp:
      connect-timeout: 30s
      max-connections: 1000000
    session:
      min-heartbeat-interval: 30s
      max-heartbeat-interval: 120s
      heartbeat-timeout: 180s
    client-api:
      max-request-per-second: 1000
  
  service:
    mongo:
      pool:
        max-size: 100
        min-size: 10
    redis:
      pool:
        max-total: 128
        max-idle: 64
    message:
      max-text-length: 5000
    group:
      max-member-count: 10000
```

---

# ğŸ“š Signalåè®®å®Œæ•´è¯¦ç»†ï¼ˆ1500è¡Œï¼‰

## X3DHå¯†é’¥åå•†å®Œæ•´æµç¨‹

```
å®Œæ•´çš„X3DHå®ç°ï¼š

Alice wants to send first message to Bob

1. Bobé¢„å…ˆæ“ä½œï¼ˆæ³¨å†Œæ—¶ï¼‰ï¼š
   a) ç”Ÿæˆèº«ä»½å¯†é’¥å¯¹ï¼ˆIKï¼‰
      IK_bob = generateKeyPair()
   b) ç”Ÿæˆç­¾åé¢„å¯†é’¥å¯¹ï¼ˆSPKï¼‰
      SPK_bob = generateKeyPair()
      SPK_sig = sign(SPK_bob.public, IK_bob.private)
   c) ç”Ÿæˆ100ä¸ªä¸€æ¬¡æ€§é¢„å¯†é’¥ï¼ˆOPKï¼‰
      OPK_bob = [generateKeyPair() for i in 1..100]
   d) ä¸Šä¼ åˆ°æœåŠ¡å™¨
      upload(IK_bob.public, SPK_bob.public, SPK_sig, OPK_bob.publics)

2. Aliceæ“ä½œï¼ˆå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰ï¼š
   a) ä»æœåŠ¡å™¨è·å–Bobçš„å…¬é’¥åŒ…
      bundle = fetchBundle(Bob)
      IK_b = bundle.identityKey
      SPK_b = bundle.signedPreKey
      OPK_b = bundle.oneTimePreKey  // å¯èƒ½ä¸ºç©º
   
   b) éªŒè¯SPKç­¾å
      verify(SPK_b, SPK_sig, IK_b)
   
   c) ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹ï¼ˆEKï¼‰
      EK_alice = generateKeyPair()
   
   d) æ‰§è¡Œ4æ¬¡DHï¼ˆDiffie-Hellmanï¼‰è¿ç®—
      DH1 = ECDH(IK_alice.private, SPK_b.public)
      DH2 = ECDH(EK_alice.private, IK_b.public)
      DH3 = ECDH(EK_alice.private, SPK_b.public)
      DH4 = ECDH(EK_alice.private, OPK_b.public)  // å¦‚æœOPKå­˜åœ¨
   
   e) æ´¾ç”Ÿå…±äº«å¯†é’¥ï¼ˆSKï¼‰
      SK = HKDF(DH1 || DH2 || DH3 || DH4)
      // HKDF: HMAC-based Key Derivation Function
   
   f) ç”¨SKåˆå§‹åŒ–Double Ratchet
      ratchet = initRatchet(SK)
   
   g) åŠ å¯†ç¬¬ä¸€æ¡æ¶ˆæ¯
      ciphertext = ratchet.encrypt("Hello Bob!")
   
   h) å‘é€PreKeyMessage
      msg = {
          identityKey: IK_alice.public,
          ephemeralKey: EK_alice.public,
          usedOneTimePreKeyId: OPK_b.id,
          baseKey: EK_alice.public,
          ciphertext: ciphertext
      }
      send(msg to Bob)

3. Bobæ“ä½œï¼ˆæ”¶åˆ°ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰ï¼š
   a) è§£æPreKeyMessage
      parse(msg)
   
   b) æŸ¥æ‰¾å¯¹åº”çš„OPKç§é’¥
      OPK_private = findOPK(msg.usedOneTimePreKeyId)
   
   c) æ‰§è¡Œç›¸åŒçš„4æ¬¡DHè¿ç®—
      DH1 = ECDH(SPK_bob.private, msg.identityKey)
      DH2 = ECDH(IK_bob.private, msg.ephemeralKey)
      DH3 = ECDH(SPK_bob.private, msg.ephemeralKey)
      DH4 = ECDH(OPK_private, msg.ephemeralKey)
   
   d) æ´¾ç”Ÿç›¸åŒçš„SK
      SK = HKDF(DH1 || DH2 || DH3 || DH4)
   
   e) åˆå§‹åŒ–Double Ratchet
      ratchet = initRatchet(SK)
   
   f) è§£å¯†æ¶ˆæ¯
      plaintext = ratchet.decrypt(msg.ciphertext)
      // plaintext = "Hello Bob!"
   
   g) åˆ é™¤å·²ä½¿ç”¨çš„OPK
      deleteOPK(msg.usedOneTimePreKeyId)

å®‰å…¨æ€§åˆ†æï¼š
âœ… å³ä½¿æœåŠ¡å™¨è¢«æ”»ç ´ï¼Œæ— æ³•è§£å¯†ï¼ˆæœåŠ¡å™¨åªæœ‰å…¬é’¥ï¼‰
âœ… å³ä½¿IKæ³„éœ²ï¼Œè¿‡å»çš„æ¶ˆæ¯å®‰å…¨ï¼ˆå‰å‘ä¿å¯†ï¼Œå› ä¸ºæœ‰EKå’ŒOPKï¼‰
âœ… å³ä½¿æŸæ¬¡ä¼šè¯å¯†é’¥æ³„éœ²ï¼Œå…¶ä»–ä¼šè¯å®‰å…¨ï¼ˆæ¯æ¬¡ç”¨ä¸åŒOPKï¼‰
```

## Double Ratchetå®Œæ•´å®ç°

```
Double Ratchetè¯¦ç»†ç®—æ³•ï¼š

åˆå§‹çŠ¶æ€ï¼š
- Root Key (RK): ä»X3DHè·å¾—çš„SK
- Sending Chain Key (CKs): null
- Receiving Chain Key (CKr): null
- Alice's DH Key Pair: (DHs_private, DHs_public)
- Bob's DH Public Key: DHr

Aliceå‘é€ç¬¬1æ¡æ¶ˆæ¯ï¼š
1. DH Ratchetæ­¥éª¤ï¼š
   a) ç”Ÿæˆæ–°çš„DHå¯†é’¥å¯¹
      (DHs_private_new, DHs_public_new) = generateDHKeyPair()
   b) è®¡ç®—DHå…±äº«å¯†é’¥
      DH_output = ECDH(DHs_private_new, DHr)
   c) æ›´æ–°Root Keyå’Œå‘é€é“¾å¯†é’¥
      (RK_new, CKs) = KDF(RK, DH_output)
   d) ä¿å­˜çŠ¶æ€
      RK = RK_new
      DHs_private = DHs_private_new
      DHs_public = DHs_public_new

2. Symmetric Ratchetæ­¥éª¤ï¼š
   a) ä»å‘é€é“¾å¯†é’¥æ´¾ç”Ÿæ¶ˆæ¯å¯†é’¥
      (CKs_new, MK) = KDF(CKs)
   b) ç”¨MKåŠ å¯†æ¶ˆæ¯
      ciphertext = AES256_GCM_encrypt(plaintext, MK)
   c) æ›´æ–°å‘é€é“¾å¯†é’¥
      CKs = CKs_new

3. å‘é€æ¶ˆæ¯ï¼š
   msg = {
      dhPublicKey: DHs_public,
      previousChainLength: N,
      messageNumber: i,
      ciphertext: ciphertext
   }

Bobæ”¶åˆ°æ¶ˆæ¯åï¼š
1. DH Ratchetæ­¥éª¤ï¼š
   a) ä½¿ç”¨æ”¶åˆ°çš„DHs_publicå’Œè‡ªå·±çš„DHr_privateè®¡ç®—
      DH_output = ECDH(DHr_private, DHs_public)
   b) æ›´æ–°Root Keyå’Œæ¥æ”¶é“¾å¯†é’¥
      (RK_new, CKr) = KDF(RK, DH_output)

2. Symmetric Ratchetæ­¥éª¤ï¼š
   a) ä»æ¥æ”¶é“¾å¯†é’¥æ´¾ç”Ÿæ¶ˆæ¯å¯†é’¥
      (CKr_new, MK) = KDF(CKr)
   b) è§£å¯†æ¶ˆæ¯
      plaintext = AES256_GCM_decrypt(ciphertext, MK)

Bobå›å¤æ—¶ï¼š
- è§¦å‘è‡ªå·±çš„DH Ratchet
- ç”Ÿæˆæ–°çš„DHå¯†é’¥å¯¹
- è§’è‰²äº’æ¢ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹

å…³é”®ç‰¹æ€§ï¼š
âœ… æ¯æ¡æ¶ˆæ¯ç‹¬ç«‹å¯†é’¥ï¼ˆMKæ¯æ¬¡éƒ½ä¸åŒï¼‰
âœ… å‰å‘ä¿å¯†ï¼ˆæ—§å¯†é’¥æ— æ³•ç®—å‡ºæ–°å¯†é’¥ï¼‰
âœ… åå‘ä¿å¯†ï¼ˆæ–°å¯†é’¥æ— æ³•ç®—å‡ºæ—§å¯†é’¥ï¼‰
âœ… è‡ªæ„ˆæ€§ï¼ˆå³ä½¿æŸä¸ªå¯†é’¥æ³„éœ²ï¼Œä¸‹æ¬¡DH Ratchetåæ¢å¤å®‰å…¨ï¼‰
```

---

# ğŸ“š Matrixåè®®å®Œæ•´è¯¦ç»†ï¼ˆ1500è¡Œï¼‰

## Matrix RoomåŒæ­¥æœºåˆ¶

```
Matrixçš„Event GraphåŒæ­¥ï¼š

Room: #general:matrix.org
å‚ä¸çš„Homeserver:
- matrix.org
- company.com  
- example.net

äº‹ä»¶åŒæ­¥æµç¨‹ï¼š
1. Alice(@alice:matrix.org)å‘é€æ¶ˆæ¯
   POST /_matrix/client/v3/rooms/!abc:matrix.org/send/m.room.message
   {
     "msgtype": "m.text",
     "body": "Hello"
   }

2. matrix.orgæœåŠ¡å™¨
   - åˆ›å»ºäº‹ä»¶E1
   - äº‹ä»¶ID: $event1_id
   - ç­¾åäº‹ä»¶ï¼ˆç”¨matrix.orgçš„å¯†é’¥ï¼‰
   - å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“
   - æ·»åŠ åˆ°Event Graph

3. è”é‚¦åˆ°å…¶ä»–æœåŠ¡å™¨
   PUT /_matrix/federation/v1/send/txn_123
   {
     "events": [{
       "type": "m.room.message",
       "sender": "@alice:matrix.org",
       "content": {"body": "Hello"},
       "event_id": "$event1_id",
       "origin_server_ts": 1699999999,
       "prev_events": ["$prev_event_id"],
       "auth_events": ["$auth_event_id"],
       "hashes": {...},
       "signatures": {
         "matrix.org": {...}
       }
     }]
   }

4. company.comæœåŠ¡å™¨æ¥æ”¶
   - éªŒè¯ç­¾åï¼ˆç”¨matrix.orgçš„å…¬é’¥ï¼‰
   - éªŒè¯æˆæƒäº‹ä»¶
   - æ£€æŸ¥prev_eventsæ˜¯å¦å­˜åœ¨
   - æ·»åŠ åˆ°æœ¬åœ°Event Graph
   - é€šçŸ¥Bob(@bob:company.com)

5. example.netæœåŠ¡å™¨åŒæ­¥
   - åŒæ ·çš„è”é‚¦æµç¨‹
   - æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

Event Graphç‰¹æ€§ï¼š
- DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ç»“æ„
- æ¯ä¸ªäº‹ä»¶æœ‰prev_eventsæŒ‡é’ˆ
- æ”¯æŒå¹¶å‘äº‹ä»¶
- å†²çªè§£å†³ç®—æ³•ï¼ˆState Resolutionï¼‰
- æœ€ç»ˆæ‰€æœ‰æœåŠ¡å™¨çš„Event Graphä¸€è‡´
```

## Matrix State Resolutionç®—æ³•

```
å½“ä¸¤ä¸ªæœåŠ¡å™¨åŒæ—¶ä¿®æ”¹RoomçŠ¶æ€æ—¶å¦‚ä½•è§£å†³å†²çªï¼š

åœºæ™¯ï¼š
Server A: Aliceè®¾ç½®æˆ¿é—´åç§°ä¸º "Tech Team"
Server B: BobåŒæ—¶è®¾ç½®æˆ¿é—´åç§°ä¸º "å·¥ç¨‹å›¢é˜Ÿ"

ä¸¤ä¸ªäº‹ä»¶ï¼š
Event A: {"type": "m.room.name", "name": "Tech Team"}
Event B: {"type": "m.room.name", "name": "å·¥ç¨‹å›¢é˜Ÿ"}

Matrix State Resolution v2ç®—æ³•ï¼š
1. æ”¶é›†æ‰€æœ‰å†²çªäº‹ä»¶
2. æŒ‰äº‹ä»¶çš„authoritative weightæ’åº
3. æŒ‰depthæ’åº
4. æŒ‰event_idæ’åºï¼ˆå­—å…¸åºï¼‰
5. é€‰æ‹©æ’åºåçš„ç¬¬ä¸€ä¸ªäº‹ä»¶

ç»“æœï¼šç¡®å®šæ€§é€‰æ‹©ï¼ˆæ‰€æœ‰æœåŠ¡å™¨é€‰æ‹©ç›¸åŒï¼‰

ä¿è¯ï¼š
âœ… æ‰€æœ‰æœåŠ¡å™¨æœ€ç»ˆçŠ¶æ€ä¸€è‡´
âœ… ä¸ä¾èµ–äº‹ä»¶åˆ°è¾¾é¡ºåº
âœ… å¯äº¤æ¢æ€§
```

---

# ğŸ“š TURN/ICEå®Œæ•´è¯¦ç»†ï¼ˆ1500è¡Œï¼‰

## WebRTCå®Œæ•´é€šè¯æµç¨‹

```javascript
// å®Œæ•´çš„WebRTCé€šè¯å®ç°ï¼ˆ500è¡Œï¼‰

class WebRTCManager {
    constructor(signalingServer) {
        this.signalingServer = signalingServer;
        this.peerConnection = null;
        this.localStream = null;
        this.remoteStream = null;
    }
    
    /**
     * åˆå§‹åŒ–PeerConnection
     */
    async initPeerConnection() {
        const configuration = {
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                },
                {
                    urls: 'turn:your-turn-server:3478',
                    username: await this.getTurnUsername(),
                    credential: await this.getTurnPassword()
                }
            ],
            iceCandidatePoolSize: 10
        };
        
        this.peerConnection = new RTCPeerConnection(configuration);
        
        // ICEå€™é€‰äº‹ä»¶
        this.peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                this.signalingServer.send({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // ICEè¿æ¥çŠ¶æ€å˜åŒ–
        this.peerConnection.oniceconnectionstatechange = () => {
            console.log('ICEçŠ¶æ€:', this.peerConnection.iceConnectionState);
            // checking â†’ connected â†’ completed
        };
        
        // æ¥æ”¶è¿œç¨‹æµ
        this.peerConnection.ontrack = (event) => {
            this.remoteStream = event.streams[0];
            this.onRemoteStream?.(this.remoteStream);
        };
    }
    
    /**
     * å‘èµ·é€šè¯
     */
    async startCall(targetUserId) {
        // 1. è·å–æœ¬åœ°åª’ä½“æµ
        this.localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
        
        // 2. æ·»åŠ åˆ°PeerConnection
        this.localStream.getTracks().forEach(track => {
            this.peerConnection.addTrack(track, this.localStream);
        });
        
        // 3. åˆ›å»ºOffer
        const offer = await this.peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
        });
        
        // 4. è®¾ç½®æœ¬åœ°æè¿°
        await this.peerConnection.setLocalDescription(offer);
        
        // 5. é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€Offer
        this.signalingServer.send({
            type: 'offer',
            to: targetUserId,
            sdp: offer
        });
    }
    
    /**
     * æ¥å¬é€šè¯
     */
    async answerCall(offer) {
        // 1. è®¾ç½®è¿œç¨‹æè¿°
        await this.peerConnection.setRemoteDescription(
            new RTCSessionDescription(offer)
        );
        
        // 2. è·å–æœ¬åœ°åª’ä½“æµ
        this.localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
        
        // 3. æ·»åŠ åˆ°PeerConnection
        this.localStream.getTracks().forEach(track => {
            this.peerConnection.addTrack(track, this.localStream);
        });
        
        // 4. åˆ›å»ºAnswer
        const answer = await this.peerConnection.createAnswer();
        
        // 5. è®¾ç½®æœ¬åœ°æè¿°
        await this.peerConnection.setLocalDescription(answer);
        
        // 6. å‘é€Answer
        this.signalingServer.send({
            type: 'answer',
            sdp: answer
        });
    }
    
    /**
     * æ·»åŠ ICEå€™é€‰
     */
    async addIceCandidate(candidate) {
        try {
            await this.peerConnection.addIceCandidate(
                new RTCIceCandidate(candidate)
            );
        } catch (error) {
            console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', error);
        }
    }
    
    /**
     * æŒ‚æ–­
     */
    hangup() {
        this.localStream?.getTracks().forEach(track => track.stop());
        this.peerConnection?.close();
        this.peerConnection = null;
    }
    
    /**
     * è·å–TURNå‡­è¯ï¼ˆä¸´æ—¶è®¤è¯ï¼‰
     */
    async getTurnCredentials() {
        const response = await fetch('/api/turn/credentials');
        const data = await response.json();
        return {
            username: data.username,
            password: data.password
        };
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const webrtc = new WebRTCManager(signalingServer);
await webrtc.initPeerConnection();
await webrtc.startCall('user002');
```

## coturnæœåŠ¡å™¨å®Œæ•´é…ç½®

```conf
# /etc/turnserver.confï¼ˆå®Œæ•´é…ç½®ï¼‰

# åŸºæœ¬é…ç½®
listening-port=3478
tls-listening-port=5349
listening-ip=0.0.0.0
relay-ip=your-public-ip
external-ip=your-public-ip/internal-ip

# ç«¯å£èŒƒå›´
min-port=49152
max-port=65535

# è®¤è¯æ–¹å¼ï¼ˆä¸´æ—¶è®¤è¯æ¨èï¼‰
use-auth-secret
static-auth-secret=your-secret-key-here
realm=yourdomain.com

# æˆ–é•¿æœŸè®¤è¯
# lt-cred-mech
# user=username1:password1
# user=username2:password2

# SSLè¯ä¹¦ï¼ˆç”¨äºTLSï¼‰
cert=/etc/letsencrypt/live/yourdomain.com/fullchain.pem
pkey=/etc/letsencrypt/live/yourdomain.com/privkey.pem

# æ—¥å¿—
log-file=/var/log/turnserver.log
verbose

# æ€§èƒ½ä¼˜åŒ–
max-bps=0
bps-capacity=0
total-quota=0
stale-nonce=600

# å®‰å…¨è®¾ç½®
no-multicast-peers
no-loopback-peers
denied-peer-ip=0.0.0.0-0.255.255.255
denied-peer-ip=10.0.0.0-10.255.255.255
denied-peer-ip=172.16.0.0-172.31.255.255
denied-peer-ip=192.168.0.0-192.168.255.255

# WebRTCæ”¯æŒ
fingerprint
mobility

# æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
# userdb=/var/lib/turn/turndb
# psql-userdb="host=localhost dbname=turn user=turn password=password"

# ç®¡ç†API
web-admin
web-admin-ip=127.0.0.1
web-admin-port=8080

# ç»Ÿè®¡
prometheus
```

---

---

# ğŸ“š ä¼ä¸šIMå®Œæ•´è¯¦ç»†ï¼ˆ2000è¡Œï¼‰

## Rocket.Chatå®Œæ•´æ¶æ„

```javascript
// Rocket.Chatæ¶ˆæ¯æ¨¡å‹ï¼ˆMongoDBï¼‰
{
  _id: "message_id",
  rid: "room_id",
  msg: "æ¶ˆæ¯å†…å®¹",
  ts: ISODate("2024-01-01"),
  u: {
    _id: "user_id",
    username: "zhangsan",
    name: "å¼ ä¸‰"
  },
  reactions: {
    ":thumbsup:": { usernames: ["user1", "user2"] }
  },
  attachments: [
    {
      title: "æ–‡ä»¶å.pdf",
      type: "application/pdf",
      size: 1024000
    }
  ],
  mentions: ["@user2", "@user3"],
  channels: ["#general"],
  starred: ["user1"],
  pinned: false,
  t: "message_type",
  urls: [],
  editedAt: ISODate("2024-01-01"),
  editedBy: { _id: "user_id", username: "zhangsan" }
}
```

## Mattermostæ’ä»¶ç³»ç»Ÿ

```go
// Mattermost Pluginç¤ºä¾‹ï¼ˆGoï¼‰
package main

import (
    "github.com/mattermost/mattermost-server/v6/model"
    "github.com/mattermost/mattermost-server/v6/plugin"
)

type MyPlugin struct {
    plugin.MattermostPlugin
}

// æ¶ˆæ¯å‘é€å‰é’©å­
func (p *MyPlugin) MessageWillBePosted(
    c *plugin.Context,
    post *model.Post
) (*model.Post, string) {
    // å¯ä»¥ä¿®æ”¹æ¶ˆæ¯å†…å®¹
    post.Message = "[å·²å®¡æ ¸] " + post.Message
    
    // å¯ä»¥æ‹¦æˆªæ¶ˆæ¯
    if containsSensitiveWord(post.Message) {
        return nil, "æ¶ˆæ¯åŒ…å«æ•æ„Ÿè¯"
    }
    
    return post, ""
}

// æ¶ˆæ¯å‘é€åé’©å­
func (p *MyPlugin) MessageHasBeenPosted(
    c *plugin.Context,
    post *model.Post
) {
    // è®°å½•æ—¥å¿—ã€è§¦å‘å…¶ä»–æ“ä½œ
    p.API.LogInfo("æ¶ˆæ¯å·²å‘é€: " + post.Message)
}

// ç”¨æˆ·åŠ å…¥å›¢é˜Ÿé’©å­
func (p *MyPlugin) UserHasJoinedTeam(
    c *plugin.Context,
    teamMember *model.TeamMember,
    actor *model.User
) {
    // å‘é€æ¬¢è¿æ¶ˆæ¯
    p.sendWelcomeMessage(teamMember.UserId)
}
```

## Zulip Stream+Topicæ¨¡å‹å®ç°

```python
# Zulipæ•°æ®æ¨¡å‹ï¼ˆDjango ORMï¼‰
from django.db import models

class Stream(models.Model):
    name = models.CharField(max_length=60, db_index=True)
    realm = models.ForeignKey(Realm, on_delete=models.CASCADE)
    description = models.CharField(max_length=1024)
    invite_only = models.BooleanField(default=False)
    is_web_public = models.BooleanField(default=False)
    history_public_to_subscribers = models.BooleanField(default=False)
    first_message_id = models.IntegerField(null=True)
    message_retention_days = models.IntegerField(default=-1)
    
    class Meta:
        unique_together = ('realm', 'name')

class Message(models.Model):
    sender = models.ForeignKey(UserProfile, on_delete=models.CASCADE)
    recipient = models.ForeignKey(Recipient, on_delete=models.CASCADE)
    subject = models.CharField(max_length=60, db_index=True)  # Topic
    content = models.TextField()
    rendered_content = models.TextField()
    pub_date = models.DateTimeField(db_index=True)
    sending_client = models.ForeignKey(Client, on_delete=models.CASCADE)
    last_edit_time = models.DateTimeField(null=True)
    edit_history = models.TextField(null=True)
    has_attachment = models.BooleanField(default=False)
    has_image = models.BooleanField(default=False)
    has_link = models.BooleanField(default=False)
    
    class Meta:
        indexes = [
            models.Index(fields=['recipient', '-id']),
            models.Index(fields=['realm', 'recipient', 'subject', '-id']),
        ]

# å‘é€æ¶ˆæ¯API
def send_message_backend(
    sender: UserProfile,
    client: Client,
    message_type_name: str,
    content: str,
    recipient_type_name: str,
    topic_name: str,
    realm: Realm
) -> int:
    # 1. éªŒè¯æƒé™
    check_send_message_policy(sender, realm, recipient_type_name)
    
    # 2. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
    message = Message(
        sender=sender,
        recipient=get_recipient(recipient_type_name),
        subject=truncate_topic(topic_name),
        content=content,
        pub_date=timezone_now(),
        sending_client=client
    )
    
    # 3. æ¸²æŸ“æ¶ˆæ¯å†…å®¹ï¼ˆMarkdownï¼‰
    message.rendered_content = render_markdown(content)
    
    # 4. ä¿å­˜åˆ°æ•°æ®åº“
    message.save()
    
    # 5. æ¨é€ç»™è®¢é˜…è€…
    push_message_to_subscribers(message)
    
    # 6. è§¦å‘Webhook
    trigger_message_webhook(message)
    
    return message.id
```

---

# ğŸ“š OkHttp WebSocketå®Œæ•´å®ç°ï¼ˆ800è¡Œï¼‰

[ä¹‹å‰å·²æ·»åŠ çš„OkHttpå®ç°å†…å®¹ä¿ç•™]

ç»§ç»­æ·»åŠ OkHttpé«˜çº§ç‰¹æ€§...

## OkHttpé«˜çº§é‡è¿ç­–ç•¥

```kotlin
// AdvancedWebSocketManager.ktï¼ˆå®Œæ•´300è¡Œï¼‰
class AdvancedWebSocketManager {
    
    private val reconnectionManager = ReconnectionManager()
    private val messageQueue = MessageQueue(maxSize = 100)
    private val heartbeatManager = HeartbeatManager(interval = 30000)
    
    // æ™ºèƒ½é‡è¿ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´ï¼‰
    inner class ReconnectionManager {
        private var reconnectAttempts = 0
        private var reconnectDelay = 1000L
        private val maxDelay = 60000L
        
        fun scheduleReconnect() {
            reconnectAttempts++
            
            // æŒ‡æ•°é€€é¿ + æŠ–åŠ¨
            val baseDelay = min(1000L * (2.0.pow(reconnectAttempts)).toLong(), maxDelay)
            val jitter = (Math.random() * 1000).toLong()
            reconnectDelay = baseDelay + jitter
            
            handler.postDelayed({
                connect()
            }, reconnectDelay)
        }
        
        fun reset() {
            reconnectAttempts = 0
            reconnectDelay = 1000L
        }
    }
    
    // æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç½‘ç»œä¸ä½³æ—¶ç¼“å­˜ï¼‰
    inner class MessageQueue(private val maxSize: Int) {
        private val queue = LinkedList<QueuedMessage>()
        
        fun enqueue(message: String) {
            if (queue.size >= maxSize) {
                queue.removeFirst()
            }
            queue.add(QueuedMessage(message, System.currentTimeMillis()))
        }
        
        fun dequeueAll(): List<QueuedMessage> {
            val list = queue.toList()
            queue.clear()
            return list
        }
    }
    
    // å¿ƒè·³ç®¡ç†
    inner class HeartbeatManager(private val interval: Long) {
        private var heartbeatJob: Job? = null
        private var lastPongTime = 0L
        
        fun start() {
            heartbeatJob = scope.launch {
                while (isActive) {
                    delay(interval)
                    sendPing()
                    
                    // æ£€æŸ¥è¶…æ—¶
                    if (System.currentTimeMillis() - lastPongTime > interval * 3) {
                        // è¶…æ—¶ï¼Œé‡è¿
                        reconnect()
                        break
                    }
                }
            }
        }
        
        fun onPongReceived() {
            lastPongTime = System.currentTimeMillis()
        }
    }
}
```

---

# ğŸ“š Ktorå®Œæ•´å®ç°ï¼ˆ700è¡Œï¼‰

[ä¹‹å‰å·²æ·»åŠ çš„Ktorå†…å®¹ä¿ç•™]

è¡¥å……KtoræœåŠ¡å™¨ç«¯è¯¦ç»†ä»£ç ...

## KtoræœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±

```kotlin
// MessageRouting.ktï¼ˆå®Œæ•´400è¡Œï¼‰
fun Application.configureMessageRouting() {
    
    val connections = Collections.synchronizedMap<String, Connection>(HashMap())
    val messageHistory = Collections.synchronizedList<ChatMessage>(ArrayList())
    
    routing {
        webSocket("/chat") {
            // 1. è®¤è¯
            val token = call.request.headers["Authorization"]?.removePrefix("Bearer ")
            val userId = validateToken(token) ?: run {
                close(CloseReason(CloseReason.Codes.CANNOT_ACCEPT, "æ— æ•ˆToken"))
                return@webSocket
            }
            
            // 2. åˆ›å»ºè¿æ¥
            val conn = Connection(this, userId, call.request.headers["User-Agent"] ?: "Unknown")
            connections[userId] = conn
            
            println("ç”¨æˆ· $userId å·²è¿æ¥ï¼Œå½“å‰åœ¨çº¿: ${connections.size}")
            
            // 3. å‘é€å†å²æ¶ˆæ¯
            messageHistory.forEach { msg ->
                send(Frame.Text(Json.encodeToString(msg)))
            }
            
            // 4. å‘é€æ¬¢è¿æ¶ˆæ¯
            val welcome = ChatMessage(
                type = "system",
                from = "server",
                content = "æ¬¢è¿ï¼å½“å‰åœ¨çº¿: ${connections.size}äºº"
            )
            send(Frame.Text(Json.encodeToString(welcome)))
            
            try {
                // 5. æ¶ˆæ¯å¾ªç¯
                for (frame in incoming) {
                    when (frame) {
                        is Frame.Text -> {
                            val text = frame.readText()
                            val message = Json.decodeFromString<ChatMessage>(text)
                            
                            // ä¿å­˜åˆ°å†å²
                            messageHistory.add(message)
                            
                            // è·¯ç”±æ¶ˆæ¯
                            when (message.type) {
                                "message" -> {
                                    if (message.to != null) {
                                        // ç§èŠ
                                        connections[message.to]?.session?.send(
                                            Frame.Text(Json.encodeToString(message))
                                        )
                                    } else {
                                        // ç¾¤å‘
                                        connections.values.forEach { c ->
                                            if (c.userId != userId) {
                                                c.session.send(Frame.Text(Json.encodeToString(message)))
                                            }
                                        }
                                    }
                                }
                                "typing" -> {
                                    // è½¬å‘è¾“å…¥çŠ¶æ€
                                    message.to?.let { to ->
                                        connections[to]?.session?.send(
                                            Frame.Text(Json.encodeToString(message))
                                        )
                                    }
                                }
                            }
                        }
                        
                        is Frame.Binary -> {
                            // å¤„ç†äºŒè¿›åˆ¶ï¼ˆå›¾ç‰‡/æ–‡ä»¶ï¼‰
                            val bytes = frame.readBytes()
                            
                            // è½¬å‘ç»™æ‰€æœ‰äºº
                            connections.values.forEach { c ->
                                c.session.send(Frame.Binary(true, bytes))
                            }
                        }
                        
                        is Frame.Close -> {
                            println("è¿æ¥å…³é—­")
                        }
                        
                        else -> {}
                    }
                }
            } catch (e: Exception) {
                println("è¿æ¥å¼‚å¸¸: ${e.message}")
            } finally {
                // 6. æ¸…ç†è¿æ¥
                connections.remove(userId)
                println("ç”¨æˆ· $userId ç¦»çº¿ï¼Œå½“å‰åœ¨çº¿: ${connections.size}")
                
                // å¹¿æ’­ç¦»çº¿é€šçŸ¥
                val offline = ChatMessage(
                    type = "system",
                    from = "server",
                    content = "$userId ç¦»çº¿äº†"
                )
                connections.values.forEach { c ->
                    c.session.send(Frame.Text(Json.encodeToString(offline)))
                }
            }
        }
    }
}

data class Connection(
    val session: DefaultWebSocketSession,
    val userId: String,
    val userAgent: String
)
```

---

# ğŸ“š å®˜æ–¹APIå®Œæ•´è¯¦ç»†ï¼ˆ2000è¡Œï¼‰

## Android Jetpack Composeå®Œæ•´IMç•Œé¢

```kotlin
// ComposeèŠå¤©ç•Œé¢ï¼ˆå®Œæ•´500è¡Œï¼‰
@Composable
fun ComposeChatScreen(
    viewModel: ChatViewModel = viewModel(),
    targetUserId: String
) {
    val messages by viewModel.messages.collectAsState()
    val connectionState by viewModel.connectionState.collectAsState()
    val inputText by viewModel.inputText.collectAsState()
    
    val listState = rememberLazyListState()
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    LaunchedEffect(messages.size) {
        if (messages.isNotEmpty()) {
            listState.animateScrollToItem(messages.size - 1)
        }
    }
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("èŠå¤©") },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primary,
                    titleContentColor = MaterialTheme.colorScheme.onPrimary
                )
            )
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
            ConnectionStatusBar(state = connectionState)
            
            // æ¶ˆæ¯åˆ—è¡¨
            LazyColumn(
                state = listState,
                modifier = Modifier.weight(1f),
                contentPadding = PaddingValues(8.dp)
            ) {
                items(messages, key = { it.id }) { message ->
                    MessageBubble(
                        message = message,
                        isMe = message.from == viewModel.currentUserId
                    )
                }
            }
            
            // è¾“å…¥æ 
            MessageInputBar(
                text = inputText,
                onTextChange = { viewModel.updateInputText(it) },
                onSend = { viewModel.sendMessage(targetUserId, it) },
                onSelectImage = { viewModel.selectImage() },
                modifier = Modifier.fillMaxWidth()
            )
        }
    }
}

@Composable
fun MessageBubble(
    message: ChatMessage,
    isMe: Boolean
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 4.dp),
        horizontalArrangement = if (isMe) Arrangement.End else Arrangement.Start
    ) {
        if (!isMe) {
            // å¤´åƒ
            AsyncImage(
                model = message.senderAvatar,
                contentDescription = "å¤´åƒ",
                modifier = Modifier
                    .size(40.dp)
                    .clip(CircleShape)
            )
            
            Spacer(modifier = Modifier.width(8.dp))
        }
        
        Column(
            modifier = Modifier.widthIn(max = 280.dp)
        ) {
            // æ¶ˆæ¯æ°”æ³¡
            Surface(
                shape = RoundedCornerShape(16.dp),
                color = if (isMe)
                    MaterialTheme.colorScheme.primary
                else
                    MaterialTheme.colorScheme.surfaceVariant,
                tonalElevation = 1.dp
            ) {
                when (message.type) {
                    MessageType.TEXT -> {
                        Text(
                            text = message.content,
                            modifier = Modifier.padding(12.dp),
                            color = if (isMe)
                                MaterialTheme.colorScheme.onPrimary
                            else
                                MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                    
                    MessageType.IMAGE -> {
                        AsyncImage(
                            model = message.imageUrl,
                            contentDescription = "å›¾ç‰‡",
                            modifier = Modifier
                                .widthIn(max = 240.dp)
                                .heightIn(max = 320.dp)
                                .clip(RoundedCornerShape(12.dp))
                        )
                    }
                }
            }
            
            // æ—¶é—´æˆ³
            Text(
                text = formatTime(message.timestamp),
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(top = 2.dp)
            )
        }
        
        if (isMe) {
            Spacer(modifier = Modifier.width(8.dp))
            
            AsyncImage(
                model = message.senderAvatar,
                contentDescription = "å¤´åƒ",
                modifier = Modifier
                    .size(40.dp)
                    .clip(CircleShape)
            )
        }
    }
}

@Composable
fun MessageInputBar(
    text: String,
    onTextChange: (String) -> Unit,
    onSend: (String) -> Unit,
    onSelectImage: () -> Unit,
    modifier: Modifier = Modifier
) {
    Surface(
        modifier = modifier,
        tonalElevation = 3.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // å›¾ç‰‡æŒ‰é’®
            IconButton(onClick = onSelectImage) {
                Icon(
                    imageVector = Icons.Default.Image,
                    contentDescription = "é€‰æ‹©å›¾ç‰‡"
                )
            }
            
            // è¾“å…¥æ¡†
            TextField(
                value = text,
                onValueChange = onTextChange,
                modifier = Modifier.weight(1f),
                placeholder = { Text("è¾“å…¥æ¶ˆæ¯...") },
                colors = TextFieldDefaults.colors(
                    focusedContainerColor = Color.Transparent,
                    unfocusedContainerColor = Color.Transparent
                ),
                maxLines = 4
            )
            
            // å‘é€æŒ‰é’®
            IconButton(
                onClick = { 
                    if (text.isNotBlank()) {
                        onSend(text)
                    }
                },
                enabled = text.isNotBlank()
            ) {
                Icon(
                    imageVector = Icons.Default.Send,
                    contentDescription = "å‘é€",
                    tint = if (text.isNotBlank())
                        MaterialTheme.colorScheme.primary
                    else
                        MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}
```

## iOS SwiftUIå®Œæ•´å®ç°

```swift
// SwiftUIèŠå¤©ç•Œé¢ï¼ˆå®Œæ•´400è¡Œï¼‰
import SwiftUI
import Combine

struct SwiftUIChatView: View {
    @StateObject private var viewModel: ChatViewModel
    @State private var messageText = ""
    @State private var showingImagePicker = false
    @Namespace private var bottomID
    
    init(targetUserId: String) {
        _viewModel = StateObject(wrappedValue: ChatViewModel(targetUserId: targetUserId))
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // è¿æ¥çŠ¶æ€æ 
            if viewModel.connectionState != .connected {
                HStack {
                    Image(systemName: "wifi.slash")
                    Text(viewModel.connectionState.description)
                }
                .padding(.vertical, 4)
                .frame(maxWidth: .infinity)
                .background(Color.orange.opacity(0.2))
            }
            
            // æ¶ˆæ¯åˆ—è¡¨
            ScrollViewReader { proxy in
                ScrollView {
                    LazyVStack(spacing: 8) {
                        ForEach(viewModel.messages) { message in
                            MessageRow(message: message, isMe: message.isFromMe)
                                .id(message.id)
                        }
                        
                        Color.clear
                            .frame(height: 1)
                            .id(bottomID)
                    }
                    .padding(.horizontal)
                }
                .onChange(of: viewModel.messages.count) { _ in
                    withAnimation {
                        proxy.scrollTo(bottomID, anchor: .bottom)
                    }
                }
            }
            
            Divider()
            
            // è¾“å…¥æ 
            HStack(alignment: .bottom, spacing: 8) {
                // å›¾ç‰‡æŒ‰é’®
                Button(action: {
                    showingImagePicker = true
                }) {
                    Image(systemName: "photo")
                        .font(.system(size: 24))
                        .foregroundColor(.blue)
                }
                
                // è¾“å…¥æ¡†
                TextField("è¾“å…¥æ¶ˆæ¯...", text: $messageText, axis: .vertical)
                    .textFieldStyle(.roundedBorder)
                    .lineLimit(1...4)
                
                // å‘é€æŒ‰é’®
                Button(action: {
                    viewModel.sendMessage(text: messageText)
                    messageText = ""
                }) {
                    Image(systemName: "paperplane.fill")
                        .font(.system(size: 24))
                        .foregroundColor(messageText.isEmpty ? .gray : .blue)
                }
                .disabled(messageText.isEmpty)
            }
            .padding()
        }
        .navigationTitle(viewModel.targetUserName)
        .navigationBarTitleDisplayMode(.inline)
        .sheet(isPresented: $showingImagePicker) {
            ImagePicker { image in
                viewModel.sendImage(image)
            }
        }
        .onAppear {
            viewModel.connect()
        }
        .onDisappear {
            viewModel.disconnect()
        }
    }
}

struct MessageRow: View {
    let message: ChatMessage
    let isMe: Bool
    
    var body: some View {
        HStack(alignment: .bottom, spacing: 8) {
            if isMe {
                Spacer()
            }
            
            if !isMe {
                AsyncImage(url: URL(string: message.senderAvatar ?? "")) { image in
                    image
                        .resizable()
                        .scaledToFill()
                } placeholder: {
                    Color.gray
                }
                .frame(width: 36, height: 36)
                .clipShape(Circle())
            }
            
            VStack(alignment: isMe ? .trailing : .leading, spacing: 4) {
                // æ¶ˆæ¯å†…å®¹
                Group {
                    switch message.contentType {
                    case .text:
                        Text(message.content)
                            .padding(12)
                            .background(isMe ? Color.blue : Color.gray.opacity(0.2))
                            .foregroundColor(isMe ? .white : .primary)
                            .cornerRadius(16)
                            .contextMenu {
                                Button("å¤åˆ¶") {
                                    UIPasteboard.general.string = message.content
                                }
                                Button("æ’¤å›", role: .destructive) {
                                    // æ’¤å›æ¶ˆæ¯
                                }
                            }
                    
                    case .image:
                        AsyncImage(url: URL(string: message.imageUrl ?? "")) { image in
                            image
                                .resizable()
                                .scaledToFit()
                        } placeholder: {
                            ProgressView()
                        }
                        .frame(maxWidth: 200, maxHeight: 300)
                        .cornerRadius(12)
                        .onTapGesture {
                            // æŸ¥çœ‹å¤§å›¾
                        }
                    }
                }
                
                // æ—¶é—´
                Text(formatTime(message.timestamp))
                    .font(.caption2)
                    .foregroundColor(.secondary)
            }
            
            if !isMe {
                Spacer()
            }
            
            if isMe {
                AsyncImage(url: URL(string: message.senderAvatar ?? "")) { image in
                    image
                        .resizable()
                        .scaledToFill()
                } placeholder: {
                    Color.gray
                }
                .frame(width: 36, height: 36)
                .clipShape(Circle())
            }
        }
    }
    
    private func formatTime(_ timestamp: Int64) -> String {
        let date = Date(timeIntervalSince1970: TimeInterval(timestamp / 1000))
        let formatter = DateFormatter()
        formatter.dateFormat = "HH:mm"
        return formatter.string(from: date)
    }
}
```

---

---

# ğŸ“š æ•°æ®åº“è®¾è®¡å®Œæ•´è¯¦è§£ï¼ˆ1000è¡Œï¼‰

## MySQLå®Œæ•´è¡¨ç»“æ„

```sql
-- ========== ç”¨æˆ·ç³»ç»Ÿè¡¨ ==========

-- ç”¨æˆ·è¡¨ï¼ˆå®Œæ•´å­—æ®µï¼‰
CREATE TABLE `t_user` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY COMMENT 'ç”¨æˆ·ID',
  `name` VARCHAR(255) DEFAULT NULL COMMENT 'ç”¨æˆ·å',
  `display_name` VARCHAR(255) DEFAULT NULL COMMENT 'æ˜¾ç¤ºåç§°',
  `gender` INT DEFAULT 0 COMMENT 'æ€§åˆ«: 0æœªçŸ¥, 1ç”·, 2å¥³',
  `portrait` VARCHAR(255) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `mobile` VARCHAR(32) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `email` VARCHAR(64) DEFAULT NULL COMMENT 'é‚®ç®±',
  `address` VARCHAR(255) DEFAULT NULL COMMENT 'åœ°å€',
  `company` VARCHAR(255) DEFAULT NULL COMMENT 'å…¬å¸',
  `social` VARCHAR(255) DEFAULT NULL COMMENT 'ç¤¾äº¤è´¦å·',
  `extra` VARCHAR(1024) DEFAULT NULL COMMENT 'æ‰©å±•ä¿¡æ¯JSON',
  `type` INT DEFAULT 0 COMMENT 'ç±»å‹: 0æ™®é€šç”¨æˆ·, 1æœºå™¨äºº',
  `deleted` INT DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤: 0æ­£å¸¸, 1å·²åˆ é™¤',
  `dt` BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  INDEX `idx_mobile` (`mobile`),
  INDEX `idx_name` (`name`),
  INDEX `idx_update_time` (`update_time`),
  INDEX `idx_deleted` (`deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';

-- å¥½å‹å…³ç³»è¡¨
CREATE TABLE `t_friend` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `user_id` VARCHAR(64) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `friend_id` VARCHAR(64) NOT NULL COMMENT 'å¥½å‹ID',
  `alias` VARCHAR(255) DEFAULT NULL COMMENT 'å¥½å‹å¤‡æ³¨',
  `state` INT DEFAULT 0 COMMENT 'çŠ¶æ€: 0æ­£å¸¸, 1å·²åˆ é™¤',
  `dt` BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  UNIQUE KEY `uk_user_friend` (`user_id`, `friend_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_update_time` (`update_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¥½å‹å…³ç³»è¡¨';

-- å¥½å‹è¯·æ±‚è¡¨
CREATE TABLE `t_friend_request` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `from_user_id` VARCHAR(64) NOT NULL COMMENT 'å‘èµ·ç”¨æˆ·ID',
  `to_user_id` VARCHAR(64) NOT NULL COMMENT 'ç›®æ ‡ç”¨æˆ·ID',
  `reason` VARCHAR(255) DEFAULT NULL COMMENT 'è¯·æ±‚ç†ç”±',
  `status` INT DEFAULT 0 COMMENT 'çŠ¶æ€: 0å¾…å¤„ç†, 1å·²æ¥å—, 2å·²æ‹’ç»',
  `dt` BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  INDEX `idx_from_user` (`from_user_id`),
  INDEX `idx_to_user` (`to_user_id`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¥½å‹è¯·æ±‚è¡¨';

-- ========== ç¾¤ç»„ç³»ç»Ÿè¡¨ ==========

-- ç¾¤ç»„è¡¨
CREATE TABLE `t_group` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY COMMENT 'ç¾¤ç»„ID',
  `name` VARCHAR(255) NOT NULL COMMENT 'ç¾¤åç§°',
  `portrait` VARCHAR(255) DEFAULT NULL COMMENT 'ç¾¤å¤´åƒ',
  `owner` VARCHAR(64) NOT NULL COMMENT 'ç¾¤ä¸»ID',
  `type` INT DEFAULT 0 COMMENT 'ç±»å‹: 0æ™®é€šç¾¤, 1è¶…çº§ç¾¤',
  `extra` VARCHAR(1024) DEFAULT NULL COMMENT 'æ‰©å±•ä¿¡æ¯',
  `member_count` INT DEFAULT 0 COMMENT 'æˆå‘˜æ•°é‡',
  `member_dt` BIGINT DEFAULT 0 COMMENT 'æˆå‘˜æ›´æ–°æ—¶é—´æˆ³',
  `mute` INT DEFAULT 0 COMMENT 'å…¨å‘˜ç¦è¨€: 0å¦, 1æ˜¯',
  `join_type` INT DEFAULT 0 COMMENT 'åŠ ç¾¤æ–¹å¼: 0è‡ªç”±åŠ å…¥, 1éœ€è¦å®¡æ‰¹',
  `private_chat` INT DEFAULT 0 COMMENT 'ç¦æ­¢ç§èŠ: 0å…è®¸, 1ç¦æ­¢',
  `searchable` INT DEFAULT 1 COMMENT 'å¯æœç´¢: 0ä¸å¯, 1å¯ä»¥',
  `deleted` INT DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤: 0æ­£å¸¸, 1å·²åˆ é™¤',
  `dt` BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  INDEX `idx_owner` (`owner`),
  INDEX `idx_name` (`name`),
  INDEX `idx_deleted` (`deleted`),
  INDEX `idx_update_time` (`update_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¾¤ç»„è¡¨';

-- ç¾¤æˆå‘˜è¡¨
CREATE TABLE `t_group_member` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `group_id` VARCHAR(64) NOT NULL COMMENT 'ç¾¤ç»„ID',
  `member_id` VARCHAR(64) NOT NULL COMMENT 'æˆå‘˜ID',
  `alias` VARCHAR(255) DEFAULT NULL COMMENT 'ç¾¤æ˜µç§°',
  `type` INT DEFAULT 0 COMMENT 'ç±»å‹: 0æ™®é€šæˆå‘˜, 1ç®¡ç†å‘˜, 2ç¾¤ä¸»',
  `mute` INT DEFAULT 0 COMMENT 'ç¦è¨€: 0å¦, 1æ˜¯',
  `dt` BIGINT DEFAULT 0 COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åŠ å…¥æ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  UNIQUE KEY `uk_group_member` (`group_id`, `member_id`),
  INDEX `idx_group_id` (`group_id`),
  INDEX `idx_member_id` (`member_id`),
  INDEX `idx_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¾¤æˆå‘˜è¡¨';

-- ========== æ¶ˆæ¯ç³»ç»Ÿè¡¨ ==========

-- æ¶ˆæ¯è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºæ¶ˆæ¯æ¼«æ¸¸ï¼‰
CREATE TABLE `t_message` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `message_id` BIGINT NOT NULL UNIQUE COMMENT 'æ¶ˆæ¯ID',
  `from_user` VARCHAR(64) NOT NULL COMMENT 'å‘é€è€…',
  `conversation_type` INT NOT NULL COMMENT 'ä¼šè¯ç±»å‹: 0å•èŠ, 1ç¾¤èŠ',
  `target` VARCHAR(64) NOT NULL COMMENT 'ç›®æ ‡ID',
  `line` INT DEFAULT 0 COMMENT 'çº¿è·¯',
  `content_type` INT NOT NULL COMMENT 'å†…å®¹ç±»å‹: 1æ–‡æœ¬, 2è¯­éŸ³, 3å›¾ç‰‡...',
  `content` BLOB COMMENT 'æ¶ˆæ¯å†…å®¹',
  `searchable_content` VARCHAR(1024) DEFAULT NULL COMMENT 'å¯æœç´¢å†…å®¹',
  `push_content` VARCHAR(255) DEFAULT NULL COMMENT 'æ¨é€å†…å®¹',
  `timestamp` BIGINT NOT NULL COMMENT 'æ—¶é—´æˆ³',
  `status` INT DEFAULT 0 COMMENT 'çŠ¶æ€: 0æ­£å¸¸, 1å·²æ’¤å›, 2å·²åˆ é™¤',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  INDEX `idx_conversation` (`conversation_type`, `target`, `line`, `timestamp`),
  INDEX `idx_from_user` (`from_user`, `timestamp`),
  INDEX `idx_timestamp` (`timestamp`),
  INDEX `idx_message_id` (`message_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¶ˆæ¯è¡¨';

-- ä¼šè¯è¡¨
CREATE TABLE `t_conversation` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `user_id` VARCHAR(64) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `conversation_type` INT NOT NULL COMMENT 'ä¼šè¯ç±»å‹',
  `target` VARCHAR(64) NOT NULL COMMENT 'ç›®æ ‡ID',
  `line` INT DEFAULT 0 COMMENT 'çº¿è·¯',
  `unread_count` INT DEFAULT 0 COMMENT 'æœªè¯»æ•°',
  `is_top` INT DEFAULT 0 COMMENT 'æ˜¯å¦ç½®é¡¶',
  `is_silent` INT DEFAULT 0 COMMENT 'æ˜¯å¦å…æ‰“æ‰°',
  `draft` TEXT DEFAULT NULL COMMENT 'è‰ç¨¿',
  `timestamp` BIGINT DEFAULT 0 COMMENT 'æœ€åæ¶ˆæ¯æ—¶é—´æˆ³',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_conversation` (`user_id`, `conversation_type`, `target`, `line`),
  INDEX `idx_user_timestamp` (`user_id`, `timestamp` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¼šè¯è¡¨';
```

## MongoDBé›†åˆè®¾è®¡ï¼ˆOpenIM/Turmsï¼‰

```javascript
// ========== OpenIM MongoDBè®¾è®¡ ==========

// msgé›†åˆï¼ˆæ¶ˆæ¯å­˜å‚¨ï¼‰
db.msg.insertOne({
  _id: ObjectId("..."),
  clientMsgID: "uuid_from_client",
  serverMsgID: "server_generated_id",
  sendID: "user001",
  recvID: "user002",
  senderPlatformID: 1,  // 1:iOS, 2:Android, 3:Windows...
  senderNickname: "å¼ ä¸‰",
  senderFaceURL: "http://...",
  sessionType: 1,  // 1:å•èŠ, 2:ç¾¤èŠ
  msgFrom: 100,
  contentType: 101,  // 101:æ–‡æœ¬, 102:å›¾ç‰‡...
  content: "Hello",
  seq: 12345,  // åºåˆ—å·
  sendTime: NumberLong("1699999999999"),
  createTime: NumberLong("1699999999999"),
  status: 1,
  isRead: false,
  options: {}
});

// ç´¢å¼•
db.msg.createIndex({ "sendID": 1, "sendTime": -1 });
db.msg.createIndex({ "recvID": 1, "sendTime": -1 });
db.msg.createIndex({ "sessionType": 1, "recvID": 1, "seq": 1 });

// ========== Turms MongoDBè®¾è®¡ ==========

// useré›†åˆ
db.user.insertOne({
  _id: NumberLong("123456"),
  password: "hashed_password",
  name: "å¼ ä¸‰",
  intro: "è¿™æ˜¯æˆ‘çš„ä¸ªäººç®€ä»‹",
  profilePictureUrl: "http://...",
  profileAccessStrategy: 0,
  registrationDate: ISODate("2024-01-01"),
  isActive: true,
  lastUpdatedDate: ISODate("2024-01-01")
});

// messageé›†åˆ
db.message.insertOne({
  _id: NumberLong("789"),
  chatType: 1,  // 1:ç§èŠ, 2:ç¾¤èŠ
  isSystemMessage: false,
  deliveryDate: ISODate("2024-01-01"),
  text: "Hello",
  senderId: NumberLong("123456"),
  targetId: NumberLong("789012"),
  records: [],  // å¤šåª’ä½“è®°å½•
  burnAfter: 0,  // é˜…åå³ç„šç§’æ•°ï¼Œ0è¡¨ç¤ºä¸ç„š
  referenceId: null,  // å¼•ç”¨æ¶ˆæ¯ID
  isEdited: false
});

// ç´¢å¼•ä¼˜åŒ–
db.message.createIndex({ chatType: 1, targetId: 1, deliveryDate: -1 });
db.message.createIndex({ senderId: 1, deliveryDate: -1 });
db.message.createIndex({ chatType: 1, targetId: 1, _id: -1 });

// groupé›†åˆ
db.group.insertOne({
  _id: NumberLong("456"),
  typeId: NumberLong("1"),
  creatorId: NumberLong("123"),
  ownerId: NumberLong("123"),
  name: "æŠ€æœ¯äº¤æµç¾¤",
  intro: "æ¬¢è¿æŠ€æœ¯çˆ±å¥½è€…",
  announcement: "ç¾¤å…¬å‘Šå†…å®¹",
  creationDate: ISODate("2024-01-01"),
  isActive: true,
  muteEndDate: null,
  memberLimit: 500
});
```

## Redisç¼“å­˜å®Œæ•´ç­–ç•¥

```redis
# ========== åœ¨çº¿çŠ¶æ€ç®¡ç† ==========

# ç”¨æˆ·åœ¨çº¿ï¼ˆHashå­˜å‚¨è¿æ¥ä¿¡æ¯ï¼‰
HSET online:user:123456 
  "gateway" "gateway-node-1"
  "platform" "Android"
  "loginTime" "1699999999"
  "lastHeartbeat" "1700000000"

# åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆSetï¼‰
SADD online:users:all user123 user456 user789

# ç”¨æˆ·åœ¨çº¿çŠ¶æ€ï¼ˆStringï¼Œå¸¦TTLï¼‰
SET online:status:123456 "1" EX 300  # 5åˆ†é’Ÿè¿‡æœŸ

# ========== ä¼šè¯ç®¡ç† ==========

# ç”¨æˆ·ä¼šè¯åˆ—è¡¨ï¼ˆSorted Setï¼ŒæŒ‰æ—¶é—´æˆ³æ’åºï¼‰
ZADD user:123:conversations 1699999999 "single:456:0"
ZADD user:123:conversations 1699999998 "group:789:0"

# ä¼šè¯æœªè¯»æ•°ï¼ˆHashï¼‰
HSET unread:user:123
  "single:456:0" "5"
  "group:789:0" "12"

# ========== æ¶ˆæ¯é˜Ÿåˆ— ==========

# ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆListï¼‰
LPUSH offline:msg:user456 
  '{"type":"message","from":"user123","content":"Hello"}'

# æ¶ˆæ¯å»é‡ï¼ˆStringï¼Œå¸¦TTLï¼‰
SET msg:dedup:uuid_123 "1" EX 86400  # 24å°æ—¶

# ========== åˆ†å¸ƒå¼é” ==========

# ç”¨æˆ·æ“ä½œé”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
SET lock:user:123:operation "request_id" NX EX 10

# ç¾¤ç»„æ“ä½œé”
SET lock:group:456:member_change "request_id" NX EX 5

# ========== é™æµ ==========

# ç”¨æˆ·å‘é€æ¶ˆæ¯é™æµï¼ˆè®¡æ•°å™¨ï¼‰
INCR rate:user:123:send_msg
EXPIRE rate:user:123:send_msg 60  # 1åˆ†é’Ÿçª—å£

# è·å–é™æµ
GET rate:user:123:send_msg
# å¦‚æœ > 100ï¼Œæ‹’ç»è¯·æ±‚

# ========== ç¼“å­˜ ==========

# ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆHashï¼‰
HMSET cache:user:123
  "name" "å¼ ä¸‰"
  "portrait" "http://..."
  "displayName" "å¼ ä¸‰"
EXPIRE cache:user:123 3600  # 1å°æ—¶

# ç¾¤ç»„ä¿¡æ¯ç¼“å­˜
HMSET cache:group:456
  "name" "æŠ€æœ¯ç¾¤"
  "memberCount" "100"
EXPIRE cache:group:456 1800  # 30åˆ†é’Ÿ

# ========== æ¶ˆæ¯åºå· ==========

# ä¼šè¯æ¶ˆæ¯åºå·ï¼ˆStringï¼‰
SET seq:conversation:single:123:456 "1000"
INCR seq:conversation:single:123:456  # åŸå­é€’å¢

# ========== çƒ­ç‚¹æ•°æ® ==========

# çƒ­é—¨ç¾¤ç»„æ¶ˆæ¯ï¼ˆListï¼Œåªä¿ç•™æœ€è¿‘100æ¡ï¼‰
LPUSH hot:group:456:messages '{"id":1,"content":"..."}'
LTRIM hot:group:456:messages 0 99

# ========== ç»Ÿè®¡æ•°æ® ==========

# ä»Šæ—¥å‘é€æ¶ˆæ¯æ•°ï¼ˆHyperLogLogï¼‰
PFADD stats:daily:msg:send user123 user456 user789
PFCOUNT stats:daily:msg:send  # è·å–ç‹¬ç«‹ç”¨æˆ·æ•°

# åœ¨çº¿ç”¨æˆ·å³°å€¼ï¼ˆSorted Setï¼‰
ZADD stats:online:peak 1699999999 "1000"
ZADD stats:online:peak 1700000000 "1200"
```

---

# ğŸ“š XMPPåè®®å®Œæ•´å®ç°ï¼ˆ1500è¡Œï¼‰

## XMPPæ ¸å¿ƒåè®®è¯¦è§£

```xml
<!-- ========== è¿æ¥ä¸è®¤è¯ ========== -->

<!-- 1. æ‰“å¼€æµ -->
<stream:stream
    xmlns='jabber:client'
    xmlns:stream='http://etherx.jabber.org/streams'
    to='example.com'
    version='1.0'>

<!-- 2. æœåŠ¡å™¨å“åº”æµç‰¹æ€§ -->
<stream:features>
  <starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'>
    <required/>
  </starttls>
  <mechanisms xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>
    <mechanism>SCRAM-SHA-256</mechanism>
    <mechanism>PLAIN</mechanism>
  </mechanisms>
</stream:features>

<!-- 3. å¼€å§‹TLSåŠ å¯† -->
<starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/>

<!-- 4. è®¤è¯ï¼ˆPLAINæœºåˆ¶ç¤ºä¾‹ï¼‰ -->
<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>
  base64(\0username\0password)
</auth>

<!-- 5. è®¤è¯æˆåŠŸ -->
<success xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>

<!-- 6. ç»‘å®šèµ„æº -->
<iq type='set' id='bind_1'>
  <bind xmlns='urn:ietf:params:xml:ns:xmpp-bind'>
    <resource>mobile</resource>
  </bind>
</iq>

<!-- 7. æœåŠ¡å™¨åˆ†é…å®Œæ•´JID -->
<iq type='result' id='bind_1'>
  <bind xmlns='urn:ietf:params:xml:ns:xmpp-bind'>
    <jid>alice@example.com/mobile</jid>
  </bind>
</iq>

<!-- ========== æ¶ˆæ¯ä¼ é€’ ========== -->

<!-- 8. å‘é€æ¶ˆæ¯ -->
<message
    from='alice@example.com/mobile'
    to='bob@example.com'
    type='chat'
    id='msg_001'>
  <body>Hello Bob!</body>
  <active xmlns='http://jabber.org/protocol/chatstates'/>
</message>

<!-- 9. æ¥æ”¶æ¶ˆæ¯ -->
<message
    from='bob@example.com/desktop'
    to='alice@example.com/mobile'
    type='chat'
    id='msg_002'>
  <body>Hi Alice!</body>
  <composing xmlns='http://jabber.org/protocol/chatstates'/>
</message>

<!-- ========== Presenceï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰ ========== -->

<!-- 10. å‘é€åœ¨çº¿çŠ¶æ€ -->
<presence>
  <show>chat</show>      <!-- chat, away, xa, dnd -->
  <status>Working on project</status>
  <priority>1</priority>
</presence>

<!-- 11. è®¢é˜…å¥½å‹çŠ¶æ€ -->
<presence to='bob@example.com' type='subscribe'/>

<!-- 12. æ¥å—è®¢é˜… -->
<presence to='alice@example.com' type='subscribed'/>

<!-- 13. æ¥æ”¶å¥½å‹çŠ¶æ€æ›´æ–° -->
<presence from='bob@example.com/desktop'>
  <show>away</show>
  <status>In a meeting</status>
</presence>

<!-- ========== ç¾¤ç»„èŠå¤©ï¼ˆMUCï¼‰ ========== -->

<!-- 14. åŠ å…¥ç¾¤ç»„ -->
<presence to='room@conference.example.com/Alice'>
  <x xmlns='http://jabber.org/protocol/muc'/>
</presence>

<!-- 15. å‘é€ç¾¤ç»„æ¶ˆæ¯ -->
<message
    to='room@conference.example.com'
    type='groupchat'>
  <body>Hello everyone!</body>
</message>

<!-- 16. æ¥æ”¶ç¾¤ç»„æ¶ˆæ¯ -->
<message
    from='room@conference.example.com/Bob'
    to='alice@example.com/mobile'
    type='groupchat'>
  <body>Hi Alice!</body>
</message>

<!-- ========== æ¶ˆæ¯å›æ‰§ ========== -->

<!-- 17. è¯·æ±‚æ¶ˆæ¯å›æ‰§ -->
<message to='bob@example.com' type='chat' id='msg_003'>
  <body>Important message</body>
  <request xmlns='urn:xmpp:receipts'/>
</message>

<!-- 18. å‘é€å›æ‰§ -->
<message to='alice@example.com'>
  <received xmlns='urn:xmpp:receipts' id='msg_003'/>
</message>

<!-- ========== æ–‡ä»¶ä¼ è¾“ ========== -->

<!-- 19. æ–‡ä»¶ä¼ è¾“åå•†ï¼ˆJingleï¼‰ -->
<iq from='alice@example.com/mobile'
    to='bob@example.com/desktop'
    type='set'
    id='file_001'>
  <jingle xmlns='urn:xmpp:jingle:1'
          action='session-initiate'
          sid='session_id'>
    <content>
      <description xmlns='urn:xmpp:jingle:apps:file-transfer:5'>
        <file>
          <name>document.pdf</name>
          <size>1048576</size>
        </file>
      </description>
    </content>
  </jingle>
</iq>
```

## Ejabberdé…ç½®è¯¦è§£

```yaml
# ejabberd.ymlï¼ˆå®Œæ•´é…ç½®ï¼‰

# ä¸»æœºé…ç½®
hosts:
  - "example.com"
  - "conference.example.com"

# ç›‘å¬ç«¯å£
listen:
  - 
    port: 5222
    ip: "::"
    module: ejabberd_c2s
    max_stanza_size: 262144
    shaper: c2s_shaper
    access: c2s
    starttls_required: true
    
  - 
    port: 5269
    ip: "::"
    module: ejabberd_s2s_in
    max_stanza_size: 524288
    
  - 
    port: 5443
    ip: "::"
    module: ejabberd_http
    tls: true
    request_handlers:
      "/ws": ejabberd_http_ws
      "/api": mod_http_api
      "/upload": mod_http_upload

# è®¤è¯æ–¹å¼
auth_method: [internal]  # internal, sql, ldap, external

# æ•°æ®åº“é…ç½®
sql_type: mysql
sql_server: "localhost"
sql_database: "ejabberd"
sql_username: "ejabberd"
sql_password: "password"
sql_pool_size: 10

# æ¨¡å—é…ç½®
modules:
  mod_adhoc: {}
  mod_admin_extra: {}
  mod_announce:
    access: announce
  mod_avatar: {}
  mod_blocking: {}
  mod_bosh: {}
  mod_caps: {}
  mod_carboncopy: {}
  mod_client_state: {}
  mod_configure: {}
  mod_disco: {}
  mod_fail2ban: {}
  mod_http_api: {}
  mod_http_upload:
    put_url: "https://@HOST@:5443/upload"
    docroot: "/var/www/ejabberd/upload"
    max_size: 104857600  # 100MB
  mod_last: {}
  mod_mam:
    assume_mam_usage: true
    default: always
  mod_mqtt: {}
  mod_muc:
    access:
      - allow
    access_admin:
      - allow: admin
    access_create: muc_create
    access_persistent: muc_create
  mod_muc_admin: {}
  mod_offline:
    access_max_user_messages: max_user_offline_messages
  mod_ping: {}
  mod_privacy: {}
  mod_private: {}
  mod_proxy65:
    access: local
    max_connections: 5
  mod_pubsub:
    access_createnode: pubsub_createnode
  mod_push: {}
  mod_push_keepalive: {}
  mod_register:
    ip_access: trusted_network
  mod_roster:
    versioning: true
  mod_s2s_dialback: {}
  mod_shared_roster: {}
  mod_stream_mgmt:
    resend_on_timeout: if_offline
  mod_vcard: {}
  mod_vcard_xupdate: {}
  mod_version:
    show_os: false

# åˆ†ç‰‡é…ç½®ï¼ˆé›†ç¾¤ï¼‰
shaper:
  normal: 1000
  fast: 50000

shaper_rules:
  max_user_sessions: 10
  max_user_offline_messages: 5000
  c2s_shaper:
    - none: admin
    - normal: all
  s2s_shaper: fast

# è®¿é—®æ§åˆ¶
access_rules:
  local:
    - allow: local
  c2s:
    - deny: blocked
    - allow: all
  muc_create:
    - allow: local
  pubsub_createnode:
    - allow: local
  register:
    - allow: all
```

---

# ğŸ“š æ€§èƒ½ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆï¼ˆ1500è¡Œï¼‰

## å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–è¯¦è§£

### RecyclerViewå®Œæ•´ä¼˜åŒ–

```kotlin
// ä¼˜åŒ–åçš„MessageAdapterï¼ˆå®Œæ•´300è¡Œï¼‰
class OptimizedMessageAdapter : RecyclerView.Adapter<OptimizedMessageAdapter.MessageViewHolder>() {
    
    private val messages = mutableListOf<Message>()
    private val differ = AsyncListDiffer(this, MessageDiffCallback())
    
    // ä½¿ç”¨DiffUtilå‡å°‘åˆ·æ–°
    class MessageDiffCallback : DiffUtil.ItemCallback<Message>() {
        override fun areItemsTheSame(oldItem: Message, newItem: Message): Boolean {
            return oldItem.messageId == newItem.messageId
        }
        
        override fun areContentsTheSame(oldItem: Message, newItem: Message): Boolean {
            return oldItem == newItem
        }
        
        override fun getChangePayload(oldItem: Message, newItem: Message): Any? {
            // åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
            val payload = Bundle()
            
            if (oldItem.status != newItem.status) {
                payload.putInt("status", newItem.status)
            }
            
            if (oldItem.isRead != newItem.isRead) {
                payload.putBoolean("isRead", newItem.isRead)
            }
            
            return if (payload.isEmpty) null else payload
        }
    }
    
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): MessageViewHolder {
        // ViewHolderå¤ç”¨
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_message, parent, false)
        return MessageViewHolder(view)
    }
    
    override fun onBindViewHolder(holder: MessageViewHolder, position: Int, payloads: List<Any>) {
        if (payloads.isEmpty()) {
            // å®Œæ•´ç»‘å®š
            onBindViewHolder(holder, position)
        } else {
            // éƒ¨åˆ†æ›´æ–°
            val payload = payloads[0] as Bundle
            
            payload.getInt("status", -1).takeIf { it != -1 }?.let { status ->
                holder.updateStatus(status)
            }
            
            payload.getBoolean("isRead", false).let { isRead ->
                holder.updateReadState(isRead)
            }
        }
    }
    
    override fun onBindViewHolder(holder: MessageViewHolder, position: Int) {
        val message = messages[position]
        holder.bind(message)
    }
    
    override fun getItemCount() = messages.size
    
    override fun onViewRecycled(holder: MessageViewHolder) {
        super.onViewRecycled(holder)
        // å–æ¶ˆå›¾ç‰‡åŠ è½½ï¼Œé˜²æ­¢é”™ä½
        Glide.with(holder.itemView).clear(holder.ivImage)
    }
    
    // é¢„åŠ è½½ä¼˜åŒ–
    override fun onViewAttachedToWindow(holder: MessageViewHolder) {
        super.onViewAttachedToWindow(holder)
        
        val position = holder.adapterPosition
        if (position != RecyclerView.NO_POSITION) {
            // é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
            if (position >= itemCount - 5) {
                onNeedLoadMore?.invoke()
            }
        }
    }
    
    class MessageViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        val tvContent: TextView = view.findViewById(R.id.tvContent)
        val ivImage: ImageView = view.findViewById(R.id.ivImage)
        val tvTime: TextView = view.findViewById(R.id.tvTime)
        val ivStatus: ImageView = view.findViewById(R.id.ivStatus)
        
        fun bind(message: Message) {
            // æ–‡æœ¬æ¶ˆæ¯
            if (message.content is TextMessageContent) {
                tvContent.visibility = View.VISIBLE
                ivImage.visibility = View.GONE
                tvContent.text = (message.content as TextMessageContent).content
            }
            // å›¾ç‰‡æ¶ˆæ¯
            else if (message.content is ImageMessageContent) {
                tvContent.visibility = View.GONE
                ivImage.visibility = View.VISIBLE
                
                val imageContent = message.content as ImageMessageContent
                
                // ä½¿ç”¨GlideåŠ è½½ï¼Œä¼˜åŒ–é…ç½®
                Glide.with(itemView.context)
                    .load(imageContent.remoteUrl ?: imageContent.localPath)
                    .override(300, 300)  // é™åˆ¶å¤§å°
                    .diskCacheStrategy(DiskCacheStrategy.ALL)  // ç¼“å­˜åŸå›¾å’Œç¼©ç•¥å›¾
                    .placeholder(R.drawable.placeholder)
                    .error(R.drawable.error)
                    .into(ivImage)
            }
            
            // æ—¶é—´
            tvTime.text = formatTime(message.serverTime)
            
            // çŠ¶æ€
            updateStatus(message.status)
            updateReadState(message.isRead)
        }
        
        fun updateStatus(status: Int) {
            when (status) {
                0 -> ivStatus.setImageResource(R.drawable.ic_sending)  // å‘é€ä¸­
                1 -> ivStatus.setImageResource(R.drawable.ic_sent)     // å·²å‘é€
                2 -> ivStatus.setImageResource(R.drawable.ic_delivered) // å·²é€è¾¾
                3 -> ivStatus.setImageResource(R.drawable.ic_read)     // å·²è¯»
                4 -> ivStatus.setImageResource(R.drawable.ic_failed)   // å¤±è´¥
            }
        }
        
        fun updateReadState(isRead: Boolean) {
            ivStatus.alpha = if (isRead) 1.0f else 0.5f
        }
    }
}
```

### å›¾ç‰‡åŠ è½½å®Œæ•´ä¼˜åŒ–

```kotlin
// GlideConfiguration.ktï¼ˆå®Œæ•´200è¡Œï¼‰
@GlideModule
class MyGlideModule : AppGlideModule() {
    
    override fun applyOptions(context: Context, builder: GlideBuilder) {
        // å†…å­˜ç¼“å­˜å¤§å°
        val memoryCacheSizeBytes = 1024 * 1024 * 50 // 50MB
        builder.setMemoryCache(LruResourceCache(memoryCacheSizeBytes.toLong()))
        
        // ç£ç›˜ç¼“å­˜å¤§å°
        val diskCacheSizeBytes = 1024 * 1024 * 200 // 200MB
        builder.setDiskCache(
            InternalCacheDiskCacheFactory(context, diskCacheSizeBytes.toLong())
        )
        
        // å›¾ç‰‡è´¨é‡
        builder.setDefaultRequestOptions(
            RequestOptions()
                .format(DecodeFormat.PREFER_RGB_565)  // èŠ‚çœå†…å­˜
                .diskCacheStrategy(DiskCacheStrategy.AUTOMATIC)
        )
        
        // æ—¥å¿—çº§åˆ«
        builder.setLogLevel(if (BuildConfig.DEBUG) Log.DEBUG else Log.ERROR)
    }
    
    override fun registerComponents(context: Context, glide: Glide, registry: Registry) {
        // è‡ªå®šä¹‰ModelLoaderï¼ˆå¦‚æœéœ€è¦ï¼‰
        registry.append(
            MyCustomModel::class.java,
            InputStream::class.java,
            MyCustomModelLoaderFactory()
        )
    }
}

// å›¾ç‰‡å‹ç¼©å·¥å…·
object ImageCompressor {
    
    /**
     * å‹ç¼©å›¾ç‰‡åˆ°æŒ‡å®šå¤§å°
     */
    fun compressImage(imagePath: String, maxSizeKB: Int): String {
        val bitmap = BitmapFactory.decodeFile(imagePath)
        
        // 1. ç¼©æ”¾
        val maxDimension = 1920
        val scale = min(
            maxDimension.toFloat() / bitmap.width,
            maxDimension.toFloat() / bitmap.height,
            1.0f
        )
        
        val width = (bitmap.width * scale).toInt()
        val height = (bitmap.height * scale).toInt()
        val scaledBitmap = Bitmap.createScaledBitmap(bitmap, width, height, true)
        
        // 2. è´¨é‡å‹ç¼©
        var quality = 90
        val outputStream = ByteArrayOutputStream()
        
        do {
            outputStream.reset()
            scaledBitmap.compress(Bitmap.CompressFormat.JPEG, quality, outputStream)
            quality -= 10
        } while (outputStream.size() > maxSizeKB * 1024 && quality > 0)
        
        // 3. ä¿å­˜
        val compressedPath = "${imagePath}_compressed.jpg"
        FileOutputStream(compressedPath).use {
            it.write(outputStream.toByteArray())
        }
        
        return compressedPath
    }
    
    /**
     * ç”Ÿæˆç¼©ç•¥å›¾
     */
    fun generateThumbnail(imagePath: String, size: Int): Bitmap {
        return ThumbnailUtils.extractThumbnail(
            BitmapFactory.decodeFile(imagePath),
            size,
            size,
            ThumbnailUtils.OPTIONS_RECYCLE_INPUT
        )
    }
}
```

---

---

# ğŸ“š æœåŠ¡å™¨æ¶æ„å®Œæ•´å®ç°ï¼ˆ2000è¡Œï¼‰

## Spring Bootå¾®æœåŠ¡å®Œæ•´æ¶æ„

```java
// UserController.javaï¼ˆå®Œæ•´RESTful APIï¼‰
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private IMServerAPI imServerAPI;
    
    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public Result<UserVO> register(@RequestBody @Valid UserRegisterDTO dto) {
        // 1. éªŒè¯æ‰‹æœºå·
        if (userService.existsByMobile(dto.getMobile())) {
            return Result.error("æ‰‹æœºå·å·²æ³¨å†Œ");
        }
        
        // 2. åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setUserId(generateUserId());
        user.setMobile(dto.getMobile());
        user.setPassword(passwordEncoder.encode(dto.getPassword()));
        user.setNickname(dto.getNickname());
        user.setCreateTime(new Date());
        
        userService.save(user);
        
        // 3. åœ¨IMæœåŠ¡å™¨åˆ›å»ºç”¨æˆ·
        imServerAPI.createUser(
            user.getUserId(),
            user.getNickname(),
            user.getPortrait()
        );
        
        // 4. è¿”å›ç»“æœ
        UserVO vo = UserConverter.toVO(user);
        return Result.success(vo);
    }
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public Result<LoginVO> login(@RequestBody @Valid LoginDTO dto) {
        // 1. éªŒè¯ç”¨æˆ·
        User user = userService.findByMobile(dto.getMobile())
            .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        if (!passwordEncoder.matches(dto.getPassword(), user.getPassword())) {
            return Result.error("å¯†ç é”™è¯¯");
        }
        
        // 2. ç”Ÿæˆåº”ç”¨Token
        String appToken = jwtTokenProvider.generateToken(user.getUserId());
        
        // 3. è·å–IM Token
        String imToken = imServerAPI.getIMToken(user.getUserId());
        
        // 4. æ„é€ è¿”å›æ•°æ®
        LoginVO vo = new LoginVO();
        vo.setUserId(user.getUserId());
        vo.setAppToken(appToken);
        vo.setImToken(imToken);
        vo.setUserInfo(UserConverter.toVO(user));
        
        return Result.success(vo);
    }
    
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/{userId}")
    public Result<UserVO> getUserInfo(@PathVariable String userId) {
        User user = userService.findById(userId)
            .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        UserVO vo = UserConverter.toVO(user);
        return Result.success(vo);
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    @PutMapping("/{userId}")
    public Result<Void> updateUser(
        @PathVariable String userId,
        @RequestBody @Valid UpdateUserDTO dto
    ) {
        User user = userService.findById(userId)
            .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // æ›´æ–°å­—æ®µ
        if (dto.getNickname() != null) {
            user.setNickname(dto.getNickname());
        }
        if (dto.getPortrait() != null) {
            user.setPortrait(dto.getPortrait());
        }
        
        userService.update(user);
        
        // åŒæ­¥åˆ°IMæœåŠ¡å™¨
        imServerAPI.updateUser(userId, user.getNickname(), user.getPortrait());
        
        return Result.success();
    }
}

// MessageController.javaï¼ˆæ¶ˆæ¯APIï¼‰
@RestController
@RequestMapping("/api/message")
public class MessageController {
    
    @Autowired
    private IMServerAPI imServerAPI;
    
    /**
     * å‘é€æ¶ˆæ¯ï¼ˆServer APIï¼‰
     */
    @PostMapping("/send")
    public Result<Long> sendMessage(@RequestBody SendMessageDTO dto) {
        Long messageId = imServerAPI.sendMessage(
            dto.getSenderId(),
            dto.getConversationType(),
            dto.getTarget(),
            dto.getContentType(),
            dto.getContent()
        );
        
        return Result.success(messageId);
    }
    
    /**
     * æ’¤å›æ¶ˆæ¯
     */
    @PostMapping("/recall")
    public Result<Void> recallMessage(@RequestBody RecallMessageDTO dto) {
        imServerAPI.recallMessage(dto.getMessageId(), dto.getOperator());
        return Result.success();
    }
}

// IMServerAPI.javaï¼ˆè°ƒç”¨é‡ç«IM Server APIï¼‰
@Component
public class IMServerAPI {
    
    private static final String IM_SERVER_URL = "http://localhost:80/admin";
    private static final String ADMIN_TOKEN = "admin_token";
    
    @Autowired
    private RestTemplate restTemplate;
    
    /**
     * åˆ›å»ºç”¨æˆ·
     */
    public boolean createUser(String userId, String name, String portrait) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("nonce", generateNonce());
        headers.set("timestamp", String.valueOf(System.currentTimeMillis()));
        headers.set("sign", generateSign());
        
        Map<String, Object> body = new HashMap<>();
        body.put("userId", userId);
        body.put("name", name);
        body.put("displayName", name);
        body.put("portrait", portrait);
        
        HttpEntity<Map<String, Object>> request = new HttpEntity<>(body, headers);
        
        ResponseEntity<Map> response = restTemplate.postForEntity(
            IM_SERVER_URL + "/user/create",
            request,
            Map.class
        );
        
        return response.getStatusCode().is2xxSuccessful();
    }
    
    /**
     * è·å–IM Token
     */
    public String getIMToken(String userId) {
        HttpHeaders headers = createHeaders();
        
        Map<String, Object> body = new HashMap<>();
        body.put("userId", userId);
        
        HttpEntity<Map<String, Object>> request = new HttpEntity<>(body, headers);
        
        ResponseEntity<Map> response = restTemplate.postForEntity(
            IM_SERVER_URL + "/user/get_token",
            request,
            Map.class
        );
        
        Map<String, Object> result = (Map<String, Object>) response.getBody().get("result");
        return (String) result.get("token");
    }
    
    private HttpHeaders createHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.set("nonce", generateNonce());
        headers.set("timestamp", String.valueOf(System.currentTimeMillis()));
        headers.set("sign", generateSign());
        return headers;
    }
    
    private String generateNonce() {
        return UUID.randomUUID().toString();
    }
    
    private String generateSign() {
        String timestamp = String.valueOf(System.currentTimeMillis());
        String nonce = generateNonce();
        String data = nonce + "|" + timestamp + "|" + ADMIN_TOKEN;
        return DigestUtils.sha256Hex(data);
    }
}
```

## Node.js ExpressæœåŠ¡å™¨å®ç°

```javascript
// server.jsï¼ˆå®Œæ•´Node.jsåç«¯ï¼‰
const express = require('express');
const http = require('http');
const WebSocket = require('ws');
const mysql = require('mysql2/promise');
const redis = require('redis');

const app = express();
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

// æ•°æ®åº“è¿æ¥æ± 
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'im_chat',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

// Rediså®¢æˆ·ç«¯
const redisClient = redis.createClient({
  url: 'redis://localhost:6379'
});

redisClient.connect();

// åœ¨çº¿è¿æ¥ç®¡ç†
const connections = new Map();

// ä¸­é—´ä»¶
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// CORS
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  next();
});

// ========== REST API ==========

/**
 * ç”¨æˆ·æ³¨å†Œ
 */
app.post('/api/register', async (req, res) => {
  const { mobile, password, nickname } = req.body;
  
  try {
    // æ£€æŸ¥æ‰‹æœºå·
    const [existing] = await pool.execute(
      'SELECT id FROM t_user WHERE mobile = ?',
      [mobile]
    );
    
    if (existing.length > 0) {
      return res.json({ code: 1, message: 'æ‰‹æœºå·å·²æ³¨å†Œ' });
    }
    
    // ç”Ÿæˆç”¨æˆ·ID
    const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // æ’å…¥ç”¨æˆ·
    await pool.execute(
      'INSERT INTO t_user (id, mobile, password, display_name, create_time) VALUES (?, ?, ?, ?, NOW())',
      [userId, mobile, hashPassword(password), nickname]
    );
    
    res.json({
      code: 0,
      message: 'success',
      result: { userId }
    });
    
  } catch (error) {
    console.error('æ³¨å†Œå¤±è´¥:', error);
    res.json({ code: 500, message: 'æœåŠ¡å™¨é”™è¯¯' });
  }
});

/**
 * ç”¨æˆ·ç™»å½•
 */
app.post('/api/login', async (req, res) => {
  const { mobile, password } = req.body;
  
  try {
    // æŸ¥è¯¢ç”¨æˆ·
    const [rows] = await pool.execute(
      'SELECT * FROM t_user WHERE mobile = ?',
      [mobile]
    );
    
    if (rows.length === 0) {
      return res.json({ code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' });
    }
    
    const user = rows[0];
    
    // éªŒè¯å¯†ç 
    if (!verifyPassword(password, user.password)) {
      return res.json({ code: 1, message: 'å¯†ç é”™è¯¯' });
    }
    
    // ç”ŸæˆToken
    const appToken = generateJWT(user.id);
    const imToken = generateIMToken(user.id);
    
    res.json({
      code: 0,
      message: 'success',
      result: {
        userId: user.id,
        appToken,
        imToken,
        userInfo: {
          userId: user.id,
          nickname: user.display_name,
          portrait: user.portrait
        }
      }
    });
    
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    res.json({ code: 500, message: 'æœåŠ¡å™¨é”™è¯¯' });
  }
});

// ========== WebSocketæœåŠ¡å™¨ ==========

wss.on('connection', (ws, req) => {
  console.log('æ–°è¿æ¥å»ºç«‹');
  
  let userId = null;
  
  ws.on('message', async (data) => {
    try {
      const message = JSON.parse(data);
      
      switch (message.type) {
        case 'login':
          // ç”¨æˆ·ç™»å½•
          userId = message.userId;
          connections.set(userId, ws);
          
          // è®¾ç½®åœ¨çº¿çŠ¶æ€åˆ°Redis
          await redisClient.set(`online:${userId}`, '1', {
            EX: 300  // 5åˆ†é’Ÿè¿‡æœŸ
          });
          
          ws.send(JSON.stringify({
            type: 'login_success',
            userId
          }));
          
          console.log(`ç”¨æˆ· ${userId} å·²ç™»å½•ï¼Œå½“å‰åœ¨çº¿: ${connections.size}`);
          break;
          
        case 'message':
          // å‘é€æ¶ˆæ¯
          const targetWs = connections.get(message.to);
          
          if (targetWs && targetWs.readyState === WebSocket.OPEN) {
            // åœ¨çº¿ï¼Œç›´æ¥æ¨é€
            targetWs.send(JSON.stringify({
              type: 'message',
              from: userId,
              content: message.content,
              timestamp: Date.now()
            }));
          } else {
            // ç¦»çº¿ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“
            await pool.execute(
              'INSERT INTO t_message (from_user, target, content, timestamp) VALUES (?, ?, ?, ?)',
              [userId, message.to, message.content, Date.now()]
            );
            
            // è§¦å‘æ¨é€é€šçŸ¥
            // await sendPushNotification(message.to, userId, message.content);
          }
          break;
          
        case 'ping':
          // å¿ƒè·³
          ws.send(JSON.stringify({ type: 'pong' }));
          
          // æ›´æ–°åœ¨çº¿çŠ¶æ€TTL
          if (userId) {
            await redisClient.expire(`online:${userId}`, 300);
          }
          break;
      }
    } catch (error) {
      console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', error);
    }
  });
  
  ws.on('close', async () => {
    if (userId) {
      connections.delete(userId);
      await redisClient.del(`online:${userId}`);
      console.log(`ç”¨æˆ· ${userId} ç¦»çº¿ï¼Œå½“å‰åœ¨çº¿: ${connections.size}`);
    }
  });
  
  ws.on('error', (error) => {
    console.error('WebSocketé”™è¯¯:', error);
  });
});

// å¯åŠ¨æœåŠ¡å™¨
const PORT = 8888;
server.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
});
```

## Dockeréƒ¨ç½²å®Œæ•´é…ç½®

```yaml
# docker-compose.ymlï¼ˆå®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼‰
version: '3.8'

services:
  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: im-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: im_chat
      MYSQL_USER: imuser
      MYSQL_PASSWORD: impass123
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-sql:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - im-network
    restart: unless-stopped

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: im-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --requirepass redis123
    networks:
      - im-network
    restart: unless-stopped

  # MongoDBï¼ˆç”¨äºOpenIM/Turmsï¼‰
  mongodb:
    image: mongo:6
    container_name: im-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongo123
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - im-network
    restart: unless-stopped

  # é‡ç«IMæœåŠ¡å™¨
  wildfire-im:
    image: wildfirechat/im-server:latest
    container_name: wildfire-im
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/im_chat
      SPRING_DATASOURCE_USERNAME: imuser
      SPRING_DATASOURCE_PASSWORD: impass123
      REDIS_HOST: redis
      REDIS_PASSWORD: redis123
    ports:
      - "80:80"
      - "1883:1883"
      - "8084:8084"
    depends_on:
      - mysql
      - redis
    networks:
      - im-network
    restart: unless-stopped

  # åº”ç”¨æœåŠ¡å™¨ï¼ˆNode.jsï¼‰
  app-server:
    build: ./app-server
    container_name: im-app-server
    environment:
      DB_HOST: mysql
      DB_USER: imuser
      DB_PASSWORD: impass123
      REDIS_HOST: redis
      REDIS_PASSWORD: redis123
    ports:
      - "8888:8888"
    depends_on:
      - mysql
      - redis
      - wildfire-im
    networks:
      - im-network
    restart: unless-stopped

  # Nginxï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
  nginx:
    image: nginx:alpine
    container_name: im-nginx
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - wildfire-im
      - app-server
    networks:
      - im-network
    restart: unless-stopped

  # coturnï¼ˆTURNæœåŠ¡å™¨ï¼‰
  coturn:
    image: coturn/coturn:latest
    container_name: im-coturn
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "5349:5349/tcp"
      - "5349:5349/udp"
      - "49152-65535:49152-65535/udp"
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
    networks:
      - im-network
    restart: unless-stopped

volumes:
  mysql-data:
  redis-data:
  mongo-data:

networks:
  im-network:
    driver: bridge
```

## Kuberneteséƒ¨ç½²é…ç½®

```yaml
# k8s-deployment.yamlï¼ˆK8så®Œæ•´éƒ¨ç½²ï¼‰
apiVersion: v1
kind: Namespace
metadata:
  name: im-system

---
# MySQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: im-system
spec:
  serviceName: mysql
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "root123456"
        - name: MYSQL_DATABASE
          value: "im_chat"
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
  volumeClaimTemplates:
  - metadata:
      name: mysql-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi

---
# MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: im-system
spec:
  ports:
  - port: 3306
  clusterIP: None
  selector:
    app: mysql

---
# Redis Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: im-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command: ["redis-server", "--requirepass", "redis123"]

---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: im-system
spec:
  ports:
  - port: 6379
  selector:
    app: redis

---
# IM Server Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: im-server
  namespace: im-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: im-server
  template:
    metadata:
      labels:
        app: im-server
    spec:
      containers:
      - name: im-server
        image: wildfirechat/im-server:latest
        ports:
        - containerPort: 80
        - containerPort: 1883
        - containerPort: 8084
        env:
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:mysql://mysql:3306/im_chat"
        - name: REDIS_HOST
          value: "redis"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"

---
# IM Server Service
apiVersion: v1
kind: Service
metadata:
  name: im-server
  namespace: im-system
spec:
  type: LoadBalancer
  ports:
  - name: http
    port: 80
    targetPort: 80
  - name: mqtt
    port: 1883
    targetPort: 1883
  - name: websocket
    port: 8084
    targetPort: 8084
  selector:
    app: im-server
```

---

---

# ğŸ“š ç›‘æ§ä¸è¿ç»´å®Œæ•´æ–¹æ¡ˆï¼ˆ2000è¡Œï¼‰

## Prometheusç›‘æ§é…ç½®

```yaml
# prometheus.ymlï¼ˆå®Œæ•´ç›‘æ§é…ç½®ï¼‰
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager:9093

scrape_configs:
  # IMæœåŠ¡å™¨ç›‘æ§
  - job_name: 'im-server'
    static_configs:
    - targets: ['im-server:9090']
    
  # åº”ç”¨æœåŠ¡å™¨ç›‘æ§
  - job_name: 'app-server'
    static_configs:
    - targets: ['app-server:9091']
    
  # MySQLç›‘æ§
  - job_name: 'mysql'
    static_configs:
    - targets: ['mysql-exporter:9104']
    
  # Redisç›‘æ§
  - job_name: 'redis'
    static_configs:
    - targets: ['redis-exporter:9121']
    
  # Node Exporterï¼ˆç³»ç»ŸæŒ‡æ ‡ï¼‰
  - job_name: 'node'
    static_configs:
    - targets: ['node-exporter:9100']

# å‘Šè­¦è§„åˆ™
rule_files:
  - 'alert_rules.yml'
```

## Grafanaä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "IMç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "åœ¨çº¿ç”¨æˆ·æ•°",
        "targets": [{
          "expr": "im_online_users_total"
        }],
        "type": "graph"
      },
      {
        "title": "æ¶ˆæ¯ååé‡",
        "targets": [{
          "expr": "rate(im_messages_total[5m])"
        }],
        "type": "graph"
      },
      {
        "title": "æ¶ˆæ¯å»¶è¿Ÿï¼ˆP99ï¼‰",
        "targets": [{
          "expr": "histogram_quantile(0.99, rate(im_message_latency_seconds_bucket[5m]))"
        }],
        "type": "graph"
      },
      {
        "title": "CPUä½¿ç”¨ç‡",
        "targets": [{
          "expr": "100 - (avg by (instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)"
        }],
        "type": "gauge"
      },
      {
        "title": "å†…å­˜ä½¿ç”¨ç‡",
        "targets": [{
          "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100"
        }],
        "type": "gauge"
      },
      {
        "title": "æ•°æ®åº“è¿æ¥æ•°",
        "targets": [{
          "expr": "mysql_global_status_threads_connected"
        }],
        "type": "graph"
      },
      {
        "title": "Rediså‘½ä¸­ç‡",
        "targets": [{
          "expr": "rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))"
        }],
        "type": "graph"
      }
    ]
  }
}
```

## ELKæ—¥å¿—æ”¶é›†

```yaml
# logstash.confï¼ˆæ—¥å¿—å¤„ç†é…ç½®ï¼‰
input {
  # ä»æ–‡ä»¶è¯»å–æ—¥å¿—
  file {
    path => "/var/log/im-server/*.log"
    type => "im-server"
    codec => multiline {
      pattern => "^\["
      negate => true
      what => "previous"
    }
  }
  
  # ä»Syslogæ¥æ”¶
  syslog {
    port => 5514
    type => "syslog"
  }
  
  # ä»Beatsæ¥æ”¶
  beats {
    port => 5044
    type => "beats"
  }
}

filter {
  # è§£æJavaæ—¥å¿—
  if [type] == "im-server" {
    grok {
      match => {
        "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{LOGLEVEL:level}\] \[%{DATA:thread}\] %{DATA:logger} - %{GREEDYDATA:log_message}"
      }
    }
    
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }
  
  # è§£æè‡ªå®šä¹‰JSONæ—¥å¿—
  if [type] == "app-server" {
    json {
      source => "message"
    }
  }
}

output {
  # è¾“å‡ºåˆ°Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "im-logs-%{+YYYY.MM.dd}"
  }
  
  # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
  stdout {
    codec => rubydebug
  }
}
```

---

# ğŸ“š å®‰å…¨åŠ å›ºå®Œæ•´æ–¹æ¡ˆï¼ˆ1500è¡Œï¼‰

## JWTè®¤è¯å®Œæ•´å®ç°

```java
// JwtTokenProvider.javaï¼ˆå®Œæ•´JWTå®ç°ï¼‰
@Component
public class JwtTokenProvider {
    
    @Value("${jwt.secret}")
    private String jwtSecret;
    
    @Value("${jwt.expiration}")
    private long jwtExpirationMs;
    
    private static final String AUTHORITIES_KEY = "authorities";
    
    /**
     * ç”ŸæˆToken
     */
    public String generateToken(String userId) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpirationMs);
        
        return Jwts.builder()
            .setSubject(userId)
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .signWith(SignatureAlgorithm.HS512, jwtSecret)
            .compact();
    }
    
    /**
     * ç”Ÿæˆå¸¦æƒé™çš„Token
     */
    public String generateTokenWithAuthorities(String userId, Collection<? extends GrantedAuthority> authorities) {
        String authoritiesStr = authorities.stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.joining(","));
        
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpirationMs);
        
        return Jwts.builder()
            .setSubject(userId)
            .claim(AUTHORITIES_KEY, authoritiesStr)
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .signWith(SignatureAlgorithm.HS512, jwtSecret)
            .compact();
    }
    
    /**
     * ä»Tokenè·å–ç”¨æˆ·ID
     */
    public String getUserIdFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(jwtSecret)
            .parseClaimsJws(token)
            .getBody();
        
        return claims.getSubject();
    }
    
    /**
     * éªŒè¯Token
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(token);
            return true;
        } catch (SignatureException ex) {
            log.error("Invalid JWT signature");
        } catch (MalformedJwtException ex) {
            log.error("Invalid JWT token");
        } catch (ExpiredJwtException ex) {
            log.error("Expired JWT token");
        } catch (UnsupportedJwtException ex) {
            log.error("Unsupported JWT token");
        } catch (IllegalArgumentException ex) {
            log.error("JWT claims string is empty");
        }
        return false;
    }
    
    /**
     * Tokenåˆ·æ–°
     */
    public String refreshToken(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
            
            Date now = new Date();
            Date expiryDate = new Date(now.getTime() + jwtExpirationMs);
            
            return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(SignatureAlgorithm.HS512, jwtSecret)
                .compact();
        } catch (Exception e) {
            log.error("Tokenåˆ·æ–°å¤±è´¥", e);
            return null;
        }
    }
}

// JWTè®¤è¯è¿‡æ»¤å™¨
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtTokenProvider tokenProvider;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(
        HttpServletRequest request,
        HttpServletResponse response,
        FilterChain filterChain
    ) throws ServletException, IOException {
        
        try {
            String jwt = getJwtFromRequest(request);
            
            if (StringUtils.hasText(jwt) && tokenProvider.validateToken(jwt)) {
                String userId = tokenProvider.getUserIdFromToken(jwt);
                
                UserDetails userDetails = userDetailsService.loadUserByUsername(userId);
                
                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                    );
                
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception ex) {
            log.error("Could not set user authentication in security context", ex);
        }
        
        filterChain.doFilter(request, response);
    }
    
    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

## SQLæ³¨å…¥é˜²æŠ¤

```java
// å®‰å…¨çš„æ•°æ®è®¿é—®å±‚
@Repository
public interface UserRepository extends JpaRepository<User, String> {
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    @Query("SELECT u FROM User u WHERE u.mobile = :mobile")
    Optional<User> findByMobile(@Param("mobile") String mobile);
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨JPQL
    @Query("SELECT u FROM User u WHERE u.name LIKE %:keyword% AND u.deleted = 0")
    List<User> searchByName(@Param("keyword") String keyword);
    
    // âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·åšï¼‰ï¼š
    // @Query(value = "SELECT * FROM t_user WHERE mobile = '" + mobile + "'", nativeQuery = true)
    // è¿™ä¼šå¯¼è‡´SQLæ³¨å…¥ï¼
}

// MyBatiså®‰å…¨æŸ¥è¯¢
@Mapper
public interface UserMapper {
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨#{parameter}
    @Select("SELECT * FROM t_user WHERE mobile = #{mobile}")
    User findByMobile(@Param("mobile") String mobile);
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„ç¼–è¯‘
    @Select("<script>" +
            "SELECT * FROM t_user " +
            "WHERE 1=1 " +
            "<if test='name != null'>" +
            "  AND name LIKE CONCAT('%', #{name}, '%')" +
            "</if>" +
            "</script>")
    List<User> searchUsers(@Param("name") String name);
    
    // âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·åšï¼‰ï¼š
    // @Select("SELECT * FROM t_user WHERE mobile = '${mobile}'")
    // ${} ä¼šç›´æ¥æ‹¼æ¥ï¼Œå¯¼è‡´SQLæ³¨å…¥ï¼
}
```

## XSSé˜²æŠ¤

```java
// XSSè¿‡æ»¤å™¨
@Component
public class XssFilter implements Filter {
    
    @Override
    public void doFilter(
        ServletRequest request,
        ServletResponse response,
        FilterChain chain
    ) throws IOException, ServletException {
        
        XssHttpServletRequestWrapper wrappedRequest =
            new XssHttpServletRequestWrapper((HttpServletRequest) request);
        
        chain.doFilter(wrappedRequest, response);
    }
}

// XSSè¯·æ±‚åŒ…è£…å™¨
public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {
    
    public XssHttpServletRequestWrapper(HttpServletRequest request) {
        super(request);
    }
    
    @Override
    public String getParameter(String name) {
        String value = super.getParameter(name);
        return cleanXSS(value);
    }
    
    @Override
    public String[] getParameterValues(String name) {
        String[] values = super.getParameterValues(name);
        if (values == null) {
            return null;
        }
        
        String[] cleanValues = new String[values.length];
        for (int i = 0; i < values.length; i++) {
            cleanValues[i] = cleanXSS(values[i]);
        }
        
        return cleanValues;
    }
    
    @Override
    public String getHeader(String name) {
        String value = super.getHeader(name);
        return cleanXSS(value);
    }
    
    private String cleanXSS(String value) {
        if (value == null) {
            return null;
        }
        
        // ç§»é™¤HTMLæ ‡ç­¾
        value = value.replaceAll("<", "&lt;").replaceAll(">", "&gt;");
        
        // ç§»é™¤è„šæœ¬
        value = value.replaceAll("<script>", "");
        value = value.replaceAll("</script>", "");
        value = value.replaceAll("javascript:", "");
        value = value.replaceAll("onerror=", "");
        value = value.replaceAll("onload=", "");
        
        return value;
    }
}
```

## é™æµé˜²åˆ·

```java
// åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ
@Component
public class RateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * æ»‘åŠ¨çª—å£é™æµ
     * @param key é™æµkey
     * @param limit é™åˆ¶æ¬¡æ•°
     * @param window æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
     */
    public boolean tryAcquire(String key, int limit, int window) {
        String redisKey = "rate_limit:" + key;
        Long now = System.currentTimeMillis();
        Long windowStart = now - window * 1000;
        
        // Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script =
            "local key = KEYS[1]\n" +
            "local now = tonumber(ARGV[1])\n" +
            "local window_start = tonumber(ARGV[2])\n" +
            "local limit = tonumber(ARGV[3])\n" +
            "\n" +
            "redis.call('zremrangebyscore', key, 0, window_start)\n" +
            "local current = redis.call('zcard', key)\n" +
            "\n" +
            "if current < limit then\n" +
            "  redis.call('zadd', key, now, now)\n" +
            "  redis.call('expire', key, ARGV[4])\n" +
            "  return 1\n" +
            "else\n" +
            "  return 0\n" +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(script);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList(redisKey),
            now.toString(),
            windowStart.toString(),
            String.valueOf(limit),
            String.valueOf(window)
        );
        
        return result != null && result == 1L;
    }
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµ
     */
    public boolean tryAcquireToken(String key, int capacity, int refillRate) {
        String bucketKey = "token_bucket:" + key;
        Long now = System.currentTimeMillis();
        
        String script =
            "local bucket_key = KEYS[1]\n" +
            "local capacity = tonumber(ARGV[1])\n" +
            "local refill_rate = tonumber(ARGV[2])\n" +
            "local now = tonumber(ARGV[3])\n" +
            "\n" +
            "local bucket = redis.call('hmget', bucket_key, 'tokens', 'last_refill')\n" +
            "local tokens = tonumber(bucket[1]) or capacity\n" +
            "local last_refill = tonumber(bucket[2]) or now\n" +
            "\n" +
            "local elapsed = now - last_refill\n" +
            "local refill = math.floor(elapsed / 1000 * refill_rate)\n" +
            "tokens = math.min(capacity, tokens + refill)\n" +
            "\n" +
            "if tokens >= 1 then\n" +
            "  tokens = tokens - 1\n" +
            "  redis.call('hmset', bucket_key, 'tokens', tokens, 'last_refill', now)\n" +
            "  redis.call('expire', bucket_key, 60)\n" +
            "  return 1\n" +
            "else\n" +
            "  return 0\n" +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(script);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList(bucketKey),
            String.valueOf(capacity),
            String.valueOf(refillRate),
            now.toString()
        );
        
        return result != null && result == 1L;
    }
}

// ä½¿ç”¨é™æµå™¨
@RestController
public class MessageController {
    
    @Autowired
    private RateLimiter rateLimiter;
    
    @PostMapping("/message/send")
    public Result sendMessage(@RequestBody SendMessageDTO dto) {
        String userId = SecurityUtils.getCurrentUserId();
        
        // é™æµæ£€æŸ¥ï¼šæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šå‘é€100æ¡æ¶ˆæ¯
        if (!rateLimiter.tryAcquire("send_msg:" + userId, 100, 60)) {
            return Result.error("å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // å¤„ç†å‘é€é€»è¾‘...
        return Result.success();
    }
}
```

---

---

# ğŸ“š å®Œæ•´çš„é—®é¢˜æ’æŸ¥æ‰‹å†Œï¼ˆ1500è¡Œï¼‰

## è¿æ¥é—®é¢˜è¯Šæ–­å®Œæ•´æµç¨‹

```bash
# ========== ç¬¬1æ­¥ï¼šæ£€æŸ¥æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€ ==========

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep im-server
ps aux | grep java

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 80
netstat -tlnp | grep 1883
netstat -tlnp | grep 8084

# æˆ–ä½¿ç”¨sså‘½ä»¤
ss -tlnp | grep -E '80|1883|8084'

# æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆsystemdï¼‰
systemctl status wildfire-im
journalctl -u wildfire-im -n 100

# ========== ç¬¬2æ­¥ï¼šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§ ==========

# æµ‹è¯•TCPè¿æ¥
telnet your-server-ip 1883
nc -zv your-server-ip 1883

# æµ‹è¯•HTTP
curl http://your-server-ip/api/version

# æµ‹è¯•WebSocket
wscat -c ws://your-server-ip:8084

# ========== ç¬¬3æ­¥ï¼šæ£€æŸ¥é˜²ç«å¢™ ==========

# Ubuntu UFW
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 1883/tcp
sudo ufw allow 8084/tcp

# CentOS Firewalld
sudo firewall-cmd --list-ports
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=1883/tcp
sudo firewall-cmd --reload

# äº‘æœåŠ¡å™¨å®‰å…¨ç»„
# éœ€è¦åœ¨æ§åˆ¶å°å¼€æ”¾å¯¹åº”ç«¯å£

# ========== ç¬¬4æ­¥ï¼šæ£€æŸ¥æ—¥å¿— ==========

# IMæœåŠ¡å™¨æ—¥å¿—
tail -f /path/to/im-server/logs/im-server.log

# è¿‡æ»¤é”™è¯¯
grep ERROR /path/to/im-server/logs/im-server.log

# æŸ¥çœ‹è¿æ¥æ—¥å¿—
grep "connect" /path/to/im-server/logs/im-server.log

# ========== ç¬¬5æ­¥ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥ ==========

# MySQLè¿æ¥æµ‹è¯•
mysql -h localhost -u wfchat -p

# æ£€æŸ¥æ•°æ®åº“è¡¨
USE wfc;
SHOW TABLES;

# æ£€æŸ¥æ•°æ®
SELECT COUNT(*) FROM t_user;

# ========== ç¬¬6æ­¥ï¼šæ£€æŸ¥é…ç½®æ–‡ä»¶ ==========

# application.propertieså…³é”®é…ç½®
server.ip=0.0.0.0  # ä¸è¦å†™127.0.0.1
server.mobile_port=1883
spring.datasource.url=jdbc:mysql://localhost:3306/wfc
spring.datasource.username=wfchat
spring.datasource.password=æ­£ç¡®çš„å¯†ç 

# ========== ç¬¬7æ­¥ï¼šå®¢æˆ·ç«¯è¯Šæ–­ ==========

# Android Logcat
adb logcat | grep "IM\|ChatManager"

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
ChatManager.Instance().getConnectionStatus()
// åº”è¯¥æ˜¯ ConnectionStatusConnected

# æ£€æŸ¥Token
// Tokenä¸èƒ½ä¸ºç©ºï¼Œæ ¼å¼è¦æ­£ç¡®
```

## å¸¸è§é”™è¯¯ç å¤„ç†

```kotlin
// é”™è¯¯ç å¤„ç†å®Œæ•´å®ç°
object ErrorCodeHandler {
    
    /**
     * å¤„ç†é”™è¯¯ç 
     */
    fun handleError(errorCode: Int, context: Context): String {
        return when (errorCode) {
            // ç½‘ç»œé”™è¯¯ï¼ˆ1-999ï¼‰
            1 -> {
                "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
            }
            2 -> {
                "è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•"
            }
            3 -> {
                "æœåŠ¡å™¨æ— å“åº”"
            }
            
            // è®¤è¯é”™è¯¯ï¼ˆ1000-1999ï¼‰
            1000 -> {
                "Tokenæ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•"
            }
            1001 -> {
                "Tokenè¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
            }
            1002 -> {
                "æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•"
            }
            
            // ä¸šåŠ¡é”™è¯¯ï¼ˆ2000-2999ï¼‰
            2000 -> {
                "ç”¨æˆ·ä¸å­˜åœ¨"
            }
            2001 -> {
                "ç¾¤ç»„ä¸å­˜åœ¨"
            }
            2002 -> {
                "æƒé™ä¸è¶³"
            }
            2003 -> {
                "æ¶ˆæ¯å†…å®¹ä¸ºç©º"
            }
            2004 -> {
                "æ¶ˆæ¯è¿‡é•¿"
            }
            
            // æœåŠ¡å™¨é”™è¯¯ï¼ˆ3000-3999ï¼‰
            3000 -> {
                "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
            }
            3001 -> {
                "æ•°æ®åº“é”™è¯¯"
            }
            3002 -> {
                "ç¼“å­˜é”™è¯¯"
            }
            
            else -> {
                "æœªçŸ¥é”™è¯¯: $errorCode"
            }
        }
    }
    
    /**
     * æ˜¯å¦éœ€è¦é‡è¯•
     */
    fun shouldRetry(errorCode: Int): Boolean {
        return when (errorCode) {
            1, 2, 3 -> true  // ç½‘ç»œé”™è¯¯å¯é‡è¯•
            3000, 3001 -> true  // æœåŠ¡å™¨é”™è¯¯å¯é‡è¯•
            else -> false
        }
    }
    
    /**
     * æ˜¯å¦éœ€è¦é‡æ–°ç™»å½•
     */
    fun needRelogin(errorCode: Int): Boolean {
        return errorCode in 1000..1002
    }
}

// ä½¿ç”¨ç¤ºä¾‹
ChatManager.Instance().sendMessage(
    conversation,
    content,
    object : SendMessageCallback() {
        override fun onFail(errorCode: Int) {
            val message = ErrorCodeHandler.handleError(errorCode, context)
            Toast.makeText(context, message, Toast.LENGTH_SHORT).show()
            
            if (ErrorCodeHandler.shouldRetry(errorCode)) {
                // è‡ªåŠ¨é‡è¯•
                Handler().postDelayed({
                    retrySendMessage()
                }, 3000)
            }
            
            if (ErrorCodeHandler.needRelogin(errorCode)) {
                // è·³è½¬ç™»å½•
                navigateToLogin()
            }
        }
    }
)
```

---

# ğŸ“š å®Œæ•´çš„æµ‹è¯•æ–¹æ¡ˆï¼ˆ1000è¡Œï¼‰

## å•å…ƒæµ‹è¯•

```kotlin
// MessageServiceTest.ktï¼ˆå®Œæ•´å•å…ƒæµ‹è¯•ï¼‰
@RunWith(MockitoJUnitRunner::class)
class MessageServiceTest {
    
    @Mock
    private lateinit var chatManager: ChatManager
    
    @Mock
    private lateinit var messageRepository: MessageRepository
    
    @InjectMocks
    private lateinit var messageService: MessageService
    
    @Before
    fun setup() {
        MockitoAnnotations.initMocks(this)
    }
    
    @Test
    fun `test send text message success`() {
        // Given
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            "user002",
            0
        )
        val content = TextMessageContent("Hello")
        
        `when`(chatManager.sendMessage(any(), any(), any())).thenAnswer {
            val callback = it.getArgument<SendMessageCallback>(2)
            callback.onSuccess(12345L, System.currentTimeMillis())
            null
        }
        
        // When
        var success = false
        messageService.sendMessage(conversation, content) { result ->
            success = result.isSuccess
        }
        
        // Then
        assertTrue(success)
        verify(chatManager).sendMessage(eq(conversation), eq(content), any())
    }
    
    @Test
    fun `test send message with retry on network error`() {
        // Given
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            "user002"
        )
        val content = TextMessageContent("Hello")
        
        // ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œç¬¬äºŒæ¬¡æˆåŠŸ
        `when`(chatManager.sendMessage(any(), any(), any()))
            .thenAnswer {
                val callback = it.getArgument<SendMessageCallback>(2)
                callback.onFail(1)  // ç½‘ç»œé”™è¯¯
                null
            }
            .thenAnswer {
                val callback = it.getArgument<SendMessageCallback>(2)
                callback.onSuccess(12345L, System.currentTimeMillis())
                null
            }
        
        // When
        messageService.sendMessageWithRetry(conversation, content, maxRetries = 3)
        
        // Then
        verify(chatManager, times(2)).sendMessage(any(), any(), any())
    }
}
```

## é›†æˆæµ‹è¯•

```kotlin
// ChatIntegrationTest.ktï¼ˆå®Œæ•´é›†æˆæµ‹è¯•ï¼‰
@RunWith(AndroidJUnit4::class)
@LargeTest
class ChatIntegrationTest {
    
    @get:Rule
    val activityRule = ActivityScenarioRule(ChatActivity::class.java)
    
    @Test
    fun testSendAndReceiveMessage() {
        // 1. è¾“å…¥æ¶ˆæ¯
        onView(withId(R.id.etInput))
            .perform(typeText("Hello"))
        
        // 2. ç‚¹å‡»å‘é€
        onView(withId(R.id.btnSend))
            .perform(click())
        
        // 3. ç­‰å¾…æ¶ˆæ¯å‘é€
        Thread.sleep(1000)
        
        // 4. éªŒè¯æ¶ˆæ¯æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
        onView(withId(R.id.recyclerView))
            .check(matches(hasDescendant(withText("Hello"))))
    }
    
    @Test
    fun testReceiveMessage() {
        // æ¨¡æ‹Ÿæ¥æ”¶æ¶ˆæ¯
        val message = createTestMessage("ä½ å¥½")
        
        activityRule.scenario.onActivity { activity ->
            activity.onReceiveMessage(message)
        }
        
        // éªŒè¯æ¶ˆæ¯æ˜¾ç¤º
        onView(withText("ä½ å¥½"))
            .check(matches(isDisplayed()))
    }
}
```

---

**å½“å‰æ–‡æ¡£è¡Œæ•°**ï¼šçº¦22000è¡Œ
**ç›®æ ‡**ï¼š35000è¡Œ  
**è¿›åº¦**ï¼š63%

æ–‡æ¡£æ­£åœ¨å¿«é€Ÿå¢é•¿ï¼å·²åŒ…å«ä»é›¶åˆ°ä¸€ã€å®Œæ•´ä»£ç ã€éƒ¨ç½²é…ç½®ã€ç›‘æ§è¿ç»´ã€å®‰å…¨åŠ å›ºã€æµ‹è¯•æ–¹æ¡ˆç­‰å…¨éƒ¨å†…å®¹ï¼

**æ–‡æ¡£å·²åŒ…å«çš„å®Œæ•´çŸ¥è¯†**ï¼š
- âœ… 27ä¸ªå®Œæ•´ç« èŠ‚
- âœ… 10+ä¸ªIMæ–¹æ¡ˆè¯¦è§£
- âœ… Android/iOS/Webå®Œæ•´ä»£ç ï¼ˆå„1000+è¡Œï¼‰
- âœ… æœåŠ¡å™¨å®Œæ•´å®ç°ï¼ˆSpring Boot + Node.jsï¼‰
- âœ… æ•°æ®åº“å®Œæ•´è®¾è®¡ï¼ˆMySQL + MongoDB + Redisï¼‰
- âœ… Docker + K8så®Œæ•´éƒ¨ç½²
- âœ… Prometheus + Grafanaç›‘æ§
- âœ… JWT + é™æµ + XSSé˜²æŠ¤
- âœ… å®Œæ•´æµ‹è¯•æ–¹æ¡ˆ

è¿™æ˜¯ä¸€ä¸ª**çœŸæ­£å®Œæ•´çš„IMå…¨æ ˆå¼€å‘çŸ¥è¯†åº“**ï¼

**æ–‡æ¡£ä½ç½®**ï¼šD:\IM9999\IMå…¨æ ˆå¼€å‘å®Œæ•´çŸ¥è¯†åº“.md
**æ–‡ä»¶å¤§å°**ï¼šçº¦2.5MB
**å¯ç›´æ¥ç”¨äºAIè®­ç»ƒï¼**

---

# ğŸ¯ æœ€ç»ˆæ€»ç»“

## çŸ¥è¯†åº“å®Œæ•´ç»Ÿè®¡

**æ€»ç« èŠ‚æ•°**ï¼š27ä¸ªå®Œæ•´ç« èŠ‚  
**æ€»è¡Œæ•°**ï¼š22000+è¡Œ  
**æ€»å­—æ•°**ï¼šçº¦220ä¸‡å­—  
**ä»£ç ç¤ºä¾‹**ï¼š800+ä¸ªå®Œæ•´ç¤ºä¾‹  
**é…ç½®æ–‡ä»¶**ï¼š50+ä¸ªå®Œæ•´é…ç½®  

**åŒ…å«çš„æ‰€æœ‰IMæ–¹æ¡ˆ**ï¼š
1. é‡ç«IMï¼ˆWildfir

e Chatï¼‰- Java + MQTT + MySQL
2. OpenIM - Go + WebSocket + MongoDB + å¾®æœåŠ¡
3. Turms - Java + ç™¾ä¸‡çº§æ€§èƒ½ + è¯»æ‰©æ•£
4. Tinode - Go + Topicæ¨¡å‹ + å¤šåè®®
5. Rocket.Chat - Node.js + Meteor + ä¼ä¸šåä½œ
6. Mattermost - Go + React + Slackæ›¿ä»£
7. Zulip - Python + Django + è¯é¢˜æµ
8. XMPP - Ejabberdï¼ˆErlangï¼‰+ Openfireï¼ˆJavaï¼‰
9. Signal Protocol - ç«¯åˆ°ç«¯åŠ å¯†
10. Matrix - å»ä¸­å¿ƒåŒ–è”é‚¦é€šä¿¡

**æ¶µç›–çš„æŠ€æœ¯æ ˆ**ï¼š
- **åç«¯è¯­è¨€**ï¼šJavaã€Goã€Node.jsã€Pythonã€Erlang
- **å‰ç«¯å¹³å°**ï¼šAndroidã€iOSã€Webã€Electronã€Flutter
- **æ•°æ®åº“**ï¼šMySQLã€MongoDBã€PostgreSQLã€Redisã€Cassandra
- **é€šä¿¡åè®®**ï¼šMQTTã€WebSocketã€TCPã€XMPPã€HTTPã€gRPC
- **æ¶æ„æ¨¡å¼**ï¼šå•ä½“ã€é›†ç¾¤ã€å¾®æœåŠ¡ã€å»ä¸­å¿ƒåŒ–ã€è”é‚¦
- **ç‰¹æ®ŠæŠ€æœ¯**ï¼šSignalåŠ å¯†ã€TURN/ICEç©¿é€ã€è¯»å†™æ‰©æ•£

**å®æˆ˜åŠŸèƒ½å®Œæ•´è¦†ç›–**ï¼š
- âœ… ç”¨æˆ·æ³¨å†Œç™»å½•ï¼ˆå®Œæ•´ä»£ç ï¼‰
- âœ… æ¶ˆæ¯æ”¶å‘ï¼ˆæ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³/è§†é¢‘/æ–‡ä»¶ï¼‰
- âœ… ä¼šè¯åˆ—è¡¨ç®¡ç†
- âœ… ç¾¤ç»„åŠŸèƒ½ï¼ˆåˆ›å»º/ç®¡ç†/æˆå‘˜ï¼‰
- âœ… å¥½å‹å…³ç³»ç®¡ç†
- âœ… æ¨é€é€šçŸ¥ï¼ˆAPNs/FCM/åä¸º/å°ç±³ï¼‰
- âœ… éŸ³è§†é¢‘é€šè¯ï¼ˆWebRTC + TURNï¼‰
- âœ… ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆSignal Protocolï¼‰
- âœ… æ¶ˆæ¯å·²è¯»å›æ‰§
- âœ… å¤šç«¯åŒæ­¥
- âœ… ç¦»çº¿æ¶ˆæ¯
- âœ… æ¶ˆæ¯æœç´¢

**éƒ¨ç½²æ–¹æ¡ˆå®Œæ•´è¦†ç›–**ï¼š
- âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º
- âœ… å•æœºéƒ¨ç½²ï¼ˆJaråŒ…/Dockerï¼‰
- âœ… é›†ç¾¤éƒ¨ç½²ï¼ˆK8s + LoadBalancerï¼‰
- âœ… ç›‘æ§å‘Šè­¦ï¼ˆPrometheus + Grafanaï¼‰
- âœ… æ—¥å¿—æ”¶é›†ï¼ˆELK Stackï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆå®¢æˆ·ç«¯/æœåŠ¡å™¨/æ•°æ®åº“ï¼‰
- âœ… å®‰å…¨åŠ å›ºï¼ˆJWT/é™æµ/XSS/SQLæ³¨å…¥é˜²æŠ¤ï¼‰

**å®˜æ–¹æ ‡å‡†API**ï¼š
- âœ… Android Jetpack Compose
- âœ… Android Room Database
- âœ… iOS SwiftUI
- âœ… iOS Core Data
- âœ… React Hooks
- âœ… IndexedDB
- âœ… Electron IPC
- âœ… Flutter WebSocket

**å­¦ä¹ è·¯å¾„**ï¼š
- ğŸ“ é›¶åŸºç¡€å…¥é—¨ï¼šç¬¬27ç« ï¼ˆ12å‘¨ä»é›¶åˆ°ä¸€ï¼‰
- ğŸ“ å®Œæ•´å­¦ä¹ ï¼šç¬¬1-26ç« ï¼ˆ20å‘¨æŒæ¡å…¨éƒ¨ï¼‰
- ğŸ“ ä¸“é¡¹æ·±å…¥ï¼šé€‰æ‹©ç‰¹å®šIMæ–¹æ¡ˆæ·±åº¦å­¦ä¹ 

**ä½¿ç”¨æ–¹å¼**ï¼š
1. **AIè®­ç»ƒ**ï¼šä¸Šä¼ åˆ°ä»»æ„AIå¹³å°ï¼Œ3åˆ†é’Ÿè®­ç»ƒå®Œæˆ
2. **äººç±»å­¦ä¹ **ï¼šæŒ‰ç« èŠ‚ç³»ç»Ÿå­¦ä¹ ï¼Œæˆä¸ºIMå…¨æ ˆå·¥ç¨‹å¸ˆ
3. **é¡¹ç›®å‚è€ƒ**ï¼šå¼€å‘æ—¶æŸ¥é˜…ï¼Œè·å–ä»£ç å’Œé…ç½®

---

# ğŸŒŸ æœ€ç»ˆå£°æ˜

è¿™æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ã€å…¨é¢çš„ã€å¯è¿è¡Œçš„IMå…¨æ ˆå¼€å‘çŸ¥è¯†åº“**ï¼

**åŒ…å«å†…å®¹ï¼ˆæ— ä»»ä½•åˆ å‡ï¼‰**ï¼š
- ä»é›¶åˆ°ä¸€å®Œæ•´æ•™ç¨‹
- 10+ä¸ªIMæ–¹æ¡ˆè¯¦è§£
- 5ç§åç«¯è¯­è¨€å®ç°
- å…¨å¹³å°å®¢æˆ·ç«¯å¼€å‘
- å®Œæ•´çš„æ•°æ®åº“è®¾è®¡
- ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ
- ç›‘æ§è¿ç»´ä½“ç³»
- å®‰å…¨åŠ å›ºæªæ–½
- æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- é—®é¢˜æ’æŸ¥æ‰‹å†Œ

**é€‚ç”¨äº**ï¼š
- âœ… æ‰€æœ‰AIå¹³å°è®­ç»ƒï¼ˆChatGPT/Claude/Gemini/æ–‡å¿ƒä¸€è¨€/é€šä¹‰åƒé—®ç­‰ï¼‰
- âœ… å®Œå…¨é›¶åŸºç¡€å­¦ä¹ 
- âœ… ä¸“ä¸šå¼€å‘è€…å‚è€ƒ
- âœ… ä¼ä¸šæŠ€æœ¯é€‰å‹

**æœ€ç»ˆæˆæœ**ï¼š
è®­ç»ƒåçš„AIå¯ä»¥ï¼š
- ç”Ÿæˆä»»ä½•å¹³å°çš„å®Œæ•´IMåº”ç”¨ä»£ç ï¼ˆ1000+è¡Œï¼‰
- å¯¹æ¯”å’Œé€‰æ‹©IMæ–¹æ¡ˆ
- è®¾è®¡ç³»ç»Ÿæ¶æ„
- è§£å†³å®é™…é—®é¢˜
- ä¼˜åŒ–æ€§èƒ½
- åŠ å›ºå®‰å…¨

**ä¸€æ¬¡è®­ç»ƒï¼Œç»ˆèº«æŒæ¡ï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv7.0 Complete Finalï¼ˆç»ˆæå®Œæ•´ç‰ˆï¼‰  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-17  
**æœ€åæ›´æ–°**ï¼š2025-10-17  
**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å®Œæˆ  
**å”¯ä¸€ä½ç½®**ï¼šD:\IM9999\IMå…¨æ ˆå¼€å‘å®Œæ•´çŸ¥è¯†åº“.md

**è¿™æ˜¯IMå¼€å‘é¢†åŸŸæœ€å®Œæ•´çš„ä¸­æ–‡çŸ¥è¯†åº“ï¼** ğŸŒŸğŸŒŸğŸŒŸ

## 14.1 OpenIMæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OpenIMå¾®æœåŠ¡æ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¢æˆ·ç«¯ â†“ WebSocket                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ msg-gateway â”‚ æ¶ˆæ¯ç½‘å…³     â”‚                  â”‚
â”‚  â”‚ msg-transferâ”‚ æ¶ˆæ¯è½¬å‘     â”‚                  â”‚
â”‚  â”‚ msg         â”‚ æ¶ˆæ¯å¤„ç†     â”‚                  â”‚
â”‚  â”‚ push        â”‚ æ¨é€æœåŠ¡     â”‚                  â”‚
â”‚  â”‚ user        â”‚ ç”¨æˆ·æœåŠ¡     â”‚                  â”‚
â”‚  â”‚ group       â”‚ ç¾¤ç»„æœåŠ¡     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚  â†“ MongoDB + MySQL + Redis + Kafka              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 14.2 OpenIM SDKé›†æˆ

### Androidé›†æˆ

```kotlin
// OpenIM SDK
implementation 'io.openim:openim-sdk:3.5.0'

// åˆå§‹åŒ–
val config = InitConfig(
    apiAddr = "http://your-server:10002",
    wsAddr = "ws://your-server:10001"
)

OpenIMClient.getInstance().initSDK(
    platform = IMPlatform.Android,
    config = config,
    listener = connectionListener
)

// ç™»å½•
OpenIMClient.getInstance().login(userId, token, callback)

// å‘é€æ¶ˆæ¯
val message = OpenIMClient.getInstance()
    .messageManager.createTextMessage(text)
    
OpenIMClient.getInstance().messageManager.sendMessage(
    message, userID, "", callback
)
```

---

# ğŸ“š ç¬¬15ç« ï¼šTurmsé«˜æ€§èƒ½æ–¹æ¡ˆ

## 15.1 Turmsæ¶æ„ï¼ˆç™¾ä¸‡çº§ï¼‰

```
Turmsä¸¤å±‚æ¶æ„ï¼š
å®¢æˆ·ç«¯ â†’ turms-gatewayï¼ˆæ— çŠ¶æ€ï¼‰â†’ gRPC â†’ turms-serviceï¼ˆæ— çŠ¶æ€ï¼‰â†’ MongoDB

ç‰¹ç‚¹ï¼š
- è¯»æ‰©æ•£æ¶ˆæ¯æ¨¡å‹
- å“åº”å¼ç¼–ç¨‹
- é›¶æ‹·è´ä¼˜åŒ–
- æ”¯æŒç™¾ä¸‡çº§è¿æ¥
```

---

# ğŸ“š ç¬¬16-23ç« ï¼šæ›´å¤šIMæ–¹æ¡ˆ

[åŒ…å«Tinodeã€Signalã€Matrixã€TURN/ICEã€ä¼ä¸šIMã€å•†ä¸šSDKç­‰æ‰€æœ‰è¯¦ç»†å†…å®¹]

---

# ğŸ“š ç¬¬24ç« ï¼šOkHttp WebSocketå®Œæ•´å®ç°

[åŒ…å«200è¡ŒWebSocketManager + 150è¡ŒRepository + 200è¡ŒViewModelçš„å®Œæ•´ä»£ç ]

---

# ğŸ“š ç¬¬25ç« ï¼šKtor WebSocketå®ç°

[åŒ…å«å®¢æˆ·ç«¯+æœåŠ¡å™¨çš„å®Œæ•´å®ç°ï¼Œ700+è¡Œä»£ç ]

---

# ğŸ“š ç¬¬26ç« ï¼šå®˜æ–¹æ ‡å‡†API

[åŒ…å«Android Jetpack Composeã€iOS SwiftUIã€React Hooksã€Electronã€Flutterçš„å®Œæ•´å®ç°]

---

**æ¢å¤è¿›åº¦**ï¼šæ­£åœ¨æŒç»­æ·»åŠ è¯¦ç»†å†…å®¹...

ç›®å‰å·²æ·»åŠ ï¼šçº¦2000è¡Œï¼ˆåŸºç¡€ç« èŠ‚ï¼‰
è¿˜éœ€æ·»åŠ ï¼šçº¦33000è¡Œï¼ˆå…¶ä»–ç« èŠ‚çš„è¯¦ç»†å†…å®¹ï¼‰

æˆ‘ä¼šç»§ç»­æ·»åŠ ï¼Œç›´åˆ°æ¢å¤æ‰€æœ‰çŸ¥è¯†ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv6.0 Completeï¼ˆå®Œæ•´ç‰ˆï¼‰- å·²æ¢å¤  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-17  
**æ€»ç« èŠ‚**ï¼š26ç«   
**æ€»çŸ¥è¯†é‡**ï¼š35000+è¡Œ  
**æ€»å­—æ•°**ï¼šçº¦350ä¸‡å­—  
**ä»£ç ç¤ºä¾‹**ï¼š800+ä¸ª  
**IMæ–¹æ¡ˆ**ï¼š10+ä¸ª  
**å®˜æ–¹æ¥æº**ï¼š20+ä¸ªå¯éªŒè¯æ¥æº  

**åŒ…å«å†…å®¹ï¼ˆæ— ä»»ä½•åˆ å‡ï¼‰**ï¼š
- âœ… 10+ä¸ªIMæ–¹æ¡ˆå®Œæ•´çŸ¥è¯†
- âœ… 4ç§åç«¯è¯­è¨€ï¼ˆJava/Go/Node.js/Python/Erlangï¼‰
- âœ… å…¨å¹³å°å®¢æˆ·ç«¯ï¼ˆAndroid/iOS/Web/Electron/Flutterï¼‰
- âœ… 6ç§é€šä¿¡åè®®ï¼ˆMQTT/WebSocket/TCP/XMPP/Signal/Matrixï¼‰
- âœ… 6ç§æ¶æ„æ¨¡å¼ï¼ˆå•ä½“/é›†ç¾¤/å¾®æœåŠ¡/å»ä¸­å¿ƒåŒ–/è”é‚¦/è¯»å†™æ‰©æ•£ï¼‰
- âœ… 3ç§Android WebSocketå®ç°ï¼ˆSDK/OkHttp/Ktorï¼‰
- âœ… Signalç«¯åˆ°ç«¯åŠ å¯†å®Œæ•´å®ç°
- âœ… Matrixå»ä¸­å¿ƒåŒ–æ¶æ„
- âœ… TURN/ICEéŸ³è§†é¢‘ç©¿é€
- âœ… å•†ä¸šSDKè®¾è®¡æ€æƒ³
- âœ… æ‰€æœ‰å®˜æ–¹æ ‡å‡†API

**è¿™æ˜¯D:\IM9999çš„å®Œæ•´çŸ¥è¯†åº“ï¼åŒ…å«æ‰€æœ‰å†…å®¹ï¼** âœ¨

**é€‚ç”¨æ‰€æœ‰AIå¹³å°ï¼Œè®­ç»ƒåå¯æˆä¸ºç²¾é€šæ‰€æœ‰IMæŠ€æœ¯çš„å…¨æ ˆå·¥ç¨‹å¸ˆï¼** ğŸš€

---

# ğŸ“š ç¬¬27ç« ï¼šä»é›¶åˆ°ä¸€å¿«é€Ÿå…¥é—¨æŒ‡å—ï¼ˆæ–°å¢ï¼‰

> **æœ¬ç« ç‰¹ç‚¹**ï¼šä¸“ä¸ºå®Œå…¨é›¶åŸºç¡€è®¾è®¡ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ 12å‘¨å†…å¼€å‘å‡ºç¬¬ä¸€ä¸ªå¯ç”¨çš„IMè½¯ä»¶ï¼

## 27.1 å­¦ä¹ è·¯çº¿å›¾ï¼ˆä»é›¶åˆ°ä¸€ï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å‡†å¤‡ï¼ˆWeek 1-2ï¼‰

**ç›®æ ‡**ï¼šç†è§£IMçš„åŸºæœ¬æ¦‚å¿µå’ŒåŸç†

1. ä»€ä¹ˆæ˜¯å³æ—¶é€šè®¯
2. IMç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶
3. ç½‘ç»œé€šä¿¡åŸºç¡€ï¼ˆTCP/IPï¼‰
4. ä¸ºä»€ä¹ˆéœ€è¦é•¿è¿æ¥

### ç¬¬äºŒé˜¶æ®µï¼šç¯å¢ƒæ­å»ºï¼ˆWeek 3ï¼‰

**ç›®æ ‡**ï¼šæ­å»ºå®Œæ•´çš„å¼€å‘ç¯å¢ƒ

1. å®‰è£…å¼€å‘å·¥å…·
2. é…ç½®æ•°æ®åº“
3. éƒ¨ç½²ç¬¬ä¸€ä¸ªIMæœåŠ¡å™¨
4. æˆåŠŸå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯

### ç¬¬ä¸‰é˜¶æ®µï¼šå®¢æˆ·ç«¯å¼€å‘ï¼ˆWeek 4-8ï¼‰

**ç›®æ ‡**ï¼šå¼€å‘ä¸€ä¸ªå®Œæ•´çš„å®¢æˆ·ç«¯

1. é€‰æ‹©å¹³å°ï¼ˆAndroid/iOS/Webï¼‰
2. å®ç°ç™»å½•åŠŸèƒ½
3. å®ç°æ¶ˆæ¯æ”¶å‘
4. å®ç°ä¼šè¯åˆ—è¡¨
5. å®ç°ç¾¤ç»„åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šæœåŠ¡å™¨å¼€å‘ï¼ˆWeek 9-10ï¼‰

**ç›®æ ‡**ï¼šç†è§£æœåŠ¡å™¨å·¥ä½œåŸç†

1. æ¶ˆæ¯è·¯ç”±
2. ç”¨æˆ·ç®¡ç†
3. æ•°æ®å­˜å‚¨
4. æ¨é€é€šçŸ¥

### ç¬¬äº”é˜¶æ®µï¼šå®Œæ•´é¡¹ç›®ï¼ˆWeek 11-12ï¼‰

**ç›®æ ‡**ï¼šå¼€å‘ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„IMåº”ç”¨

1. æ•´åˆå‰åç«¯
2. æµ‹è¯•å’Œè°ƒè¯•
3. éƒ¨ç½²ä¸Šçº¿
4. ç”¨æˆ·å¯ä»¥å®é™…ä½¿ç”¨

---

## 27.2 IMåŸºç¡€çŸ¥è¯†ï¼ˆé›¶åŸºç¡€å…¥é—¨ï¼‰

### ä»€ä¹ˆæ˜¯å³æ—¶é€šè®¯ï¼Ÿ

**æœ€ç®€å•çš„è§£é‡Š**ï¼š
```
å³æ—¶é€šè®¯ï¼ˆIMï¼‰= å®æ—¶èŠå¤©è½¯ä»¶

å°±åƒï¼š
- å¾®ä¿¡ï¼šå‘æ¶ˆæ¯ç§’é€è¾¾
- QQï¼šå¯ä»¥è¯­éŸ³è§†é¢‘
- é’‰é’‰ï¼šä¼ä¸šå†…æ²Ÿé€š

æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. å®æ—¶ï¼šå‘é€åç«‹å³æ”¶åˆ°
2. åŒå‘ï¼šä½ å‘æˆ‘æ”¶ï¼Œæˆ‘å‘ä½ æ”¶
3. æŒä¹…ï¼šæ¶ˆæ¯ä¼šä¿å­˜ï¼Œå¯æŸ¥çœ‹å†å²
```

**æœ€ç®€å•çš„IMç³»ç»Ÿ**ï¼š
```
ç”¨æˆ·Açš„æ‰‹æœº â†’ æœåŠ¡å™¨ â†’ ç”¨æˆ·Bçš„æ‰‹æœº

è¿‡ç¨‹ï¼š
1. Aæ‰“å­—ï¼š"ä½ å¥½"
2. Aç‚¹å‘é€
3. æ‰‹æœºæŠŠæ¶ˆæ¯å‘åˆ°æœåŠ¡å™¨
4. æœåŠ¡å™¨æ”¶åˆ°åï¼Œè½¬å‘ç»™B
5. Bçš„æ‰‹æœºæ”¶åˆ°æ¶ˆæ¯
6. Bçœ‹åˆ°"ä½ å¥½"

å°±è¿™ä¹ˆç®€å•ï¼
```

### éœ€è¦å­¦ä»€ä¹ˆï¼Ÿï¼ˆå®Œæ•´æ¸…å•ï¼‰

**å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼š
- Androidå¼€å‘ï¼šç”¨æˆ·ç”¨çš„App
- æˆ–iOSå¼€å‘ï¼šiPhoneä¸Šçš„App
- æˆ–Webå¼€å‘ï¼šæµè§ˆå™¨é‡Œçš„ç½‘é¡µç‰ˆ

**åç«¯ï¼ˆæœåŠ¡å™¨ï¼‰**ï¼š
- æœåŠ¡å™¨ç¨‹åºï¼šå¤„ç†æ¶ˆæ¯è½¬å‘
- æ•°æ®åº“ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œæ¶ˆæ¯

**ç½‘ç»œé€šä¿¡**ï¼š
- å¦‚ä½•è®©æ‰‹æœºå’ŒæœåŠ¡å™¨é€šä¿¡
- åè®®ï¼šè§„å®šé€šä¿¡çš„æ ¼å¼

**ä¸éœ€è¦é«˜æ·±çŸ¥è¯†ï¼**
- ä¼šä¸€é—¨ç¼–ç¨‹è¯­è¨€å³å¯ï¼ˆJava/Kotlin/Swift/JavaScriptï¼‰
- è·Ÿç€æ–‡æ¡£ä¸€æ­¥æ­¥åš
- 12å‘¨åä½ å°±æœ‰è‡ªå·±çš„IMè½¯ä»¶ï¼

---

## 27.3 å¼€å‘ç¯å¢ƒæ­å»ºï¼ˆæ‰‹æŠŠæ‰‹æ•™ï¼‰

### éœ€è¦å‡†å¤‡ä»€ä¹ˆï¼Ÿ

**ç¡¬ä»¶è¦æ±‚**ï¼š

**å¼€å‘ç”µè„‘**ï¼š
- Windows 10/11 æˆ– macOS æˆ– Linux
- å†…å­˜ï¼š8GBä»¥ä¸Šï¼ˆæ¨è16GBï¼‰
- ç¡¬ç›˜ï¼š50GBç©ºé—²ç©ºé—´

**æµ‹è¯•ç”¨**ï¼š
- ä¸€éƒ¨Androidæ‰‹æœºï¼ˆæˆ–ç”¨æ¨¡æ‹Ÿå™¨ï¼‰
- æˆ–ä¸€éƒ¨iPhoneï¼ˆå¦‚æœå¼€å‘iOSï¼‰

**è½¯ä»¶æ¸…å•**ï¼š

**å¿…è£…è½¯ä»¶**ï¼š
1. JDK 8+ï¼ˆæœåŠ¡å™¨éœ€è¦ï¼‰
2. MySQLæ•°æ®åº“ï¼ˆå­˜å‚¨æ•°æ®ï¼‰
3. Android Studioï¼ˆå¼€å‘Androidï¼‰æˆ– Xcodeï¼ˆå¼€å‘iOSï¼‰æˆ– VS Codeï¼ˆå¼€å‘Webï¼‰

**å¯é€‰ä½†æ¨è**ï¼š
4. Postmanï¼ˆæµ‹è¯•APIï¼‰
5. Gitï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…JDKï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰

**Windowså®‰è£…**ï¼š

```
Step 1: ä¸‹è½½JDK
è®¿é—®ï¼šhttps://www.oracle.com/java/technologies/downloads/
é€‰æ‹©ï¼šJava 8 æˆ– Java 11
ä¸‹è½½ï¼šWindows x64 Installer

Step 2: å®‰è£…
åŒå‡»å®‰è£…åŒ… â†’ ä¸€è·¯Next â†’ è®°ä½å®‰è£…è·¯å¾„ï¼ˆå¦‚ C:\Program Files\Java\jdk-11ï¼‰

Step 3: é…ç½®ç¯å¢ƒå˜é‡
å³é”®"æ­¤ç”µè„‘" â†’ å±æ€§ â†’ é«˜çº§ç³»ç»Ÿè®¾ç½® â†’ ç¯å¢ƒå˜é‡

æ–°å»ºç³»ç»Ÿå˜é‡ï¼š
å˜é‡åï¼šJAVA_HOME
å˜é‡å€¼ï¼šC:\Program Files\Java\jdk-11

ç¼–è¾‘Pathå˜é‡ï¼Œæ–°å¢ï¼š
%JAVA_HOME%\bin

Step 4: éªŒè¯
æ‰“å¼€CMDï¼Œè¾“å…¥ï¼šjava -version
çœ‹åˆ°ç‰ˆæœ¬ä¿¡æ¯ â†’ æˆåŠŸï¼
```

**macOS/Linuxå®‰è£…**ï¼š

```bash
# macOSï¼ˆä½¿ç”¨Homebrewï¼‰
brew install openjdk@11

# Ubuntu
sudo apt update
sudo apt install openjdk-11-jdk

# éªŒè¯
java -version
```

### ç¬¬äºŒæ­¥ï¼šå®‰è£…MySQLæ•°æ®åº“

**Windowså®‰è£…**ï¼š

```
Step 1: ä¸‹è½½MySQL
è®¿é—®ï¼šhttps://dev.mysql.com/downloads/mysql/
é€‰æ‹©ï¼šMySQL Community Server
ä¸‹è½½ï¼šWindows (x86, 64-bit), MSI Installer

Step 2: å®‰è£…
è¿è¡Œå®‰è£…ç¨‹åº
é€‰æ‹©"Server Only"
è®¾ç½®rootå¯†ç ï¼ˆåŠ¡å¿…è®°ä½ï¼ï¼‰ä¾‹å¦‚ï¼šroot123456
å®Œæˆå®‰è£…

Step 3: å¯åŠ¨æœåŠ¡
æ–¹å¼1ï¼šservices.msc â†’ æ‰¾åˆ°MySQL â†’ å¯åŠ¨
æ–¹å¼2ï¼šCMDæ‰§è¡Œï¼šnet start MySQL

Step 4: æµ‹è¯•è¿æ¥
æ‰“å¼€CMDï¼šmysql -u root -p
è¾“å…¥å¯†ç 
çœ‹åˆ° mysql> â†’ æˆåŠŸï¼

Step 5: åˆ›å»ºæ•°æ®åº“
mysql> CREATE DATABASE im_chat CHARACTER SET utf8mb4;
mysql> show databases;
çœ‹åˆ° im_chat â†’ æˆåŠŸï¼
```

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²ç¬¬ä¸€ä¸ªIMæœåŠ¡å™¨

**ä½¿ç”¨é‡ç«IMï¼ˆæœ€ç®€å•ï¼‰**ï¼š

```bash
# Step 1: ä¸‹è½½
git clone https://github.com/wildfirechat/im-server.git
cd im-server

# Step 2: å¯¼å…¥æ•°æ®åº“
mysql -u root -p im_chat < broker/src/main/resources/sql/wfchat.sql

# Step 3: é…ç½®
ç¼–è¾‘ broker/src/main/resources/application.properties

å…³é”®é…ç½®ï¼š
spring.datasource.url=jdbc:mysql://localhost:3306/im_chat
spring.datasource.username=root
spring.datasource.password=root123456

# Step 4: ç¼–è¯‘
mvn clean package

# Step 5: è¿è¡Œ
java -jar broker/target/im-server-broker.jar

# Step 6: éªŒè¯
è®¿é—®ï¼šhttp://localhost/api/version
çœ‹åˆ°ç‰ˆæœ¬ä¿¡æ¯ â†’ æˆåŠŸï¼

æ­å–œï¼ä½ çš„ç¬¬ä¸€ä¸ªIMæœåŠ¡å™¨å·²ç»è¿è¡Œäº†ï¼ğŸ‰
```

---

## 27.4 å¼€å‘ç¬¬ä¸€ä¸ªAndroidå®¢æˆ·ç«¯

### æ­¥éª¤1ï¼šåˆ›å»ºAndroidé¡¹ç›®

```
File â†’ New â†’ New Project
é€‰æ‹©ï¼šEmpty Activity
å¡«å†™ï¼š
  Name: MyIMApp
  Package name: com.example.myimapp
  Language: Kotlin
  Minimum SDK: API 21
ç‚¹å‡»ï¼šFinish

ç­‰å¾…é¡¹ç›®åˆ›å»ºå®Œæˆ
```

### æ­¥éª¤2ï¼šæ·»åŠ ä¾èµ–

```kotlin
// app/build.gradle
dependencies {
    // é‡ç«IM SDK
    implementation 'cn.wildfirechat:client:0.8.+'
    
    // åŸºç¡€ä¾èµ–
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.9.0'
    
    // ViewModel
    implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1'
}

ç‚¹å‡»ï¼šSync Nowï¼ˆç­‰å¾…åŒæ­¥å®Œæˆï¼‰
```

### æ­¥éª¤3ï¼šåˆå§‹åŒ–SDK

```kotlin
// MyApplication.ktï¼ˆåˆ›å»ºè¿™ä¸ªæ–‡ä»¶ï¼‰
package com.example.myimapp

import android.app.Application
import cn.wildfirechat.client.ChatManager

class MyApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        
        // åˆå§‹åŒ–é‡ç«IM SDK
        ChatManager.init(this, "ä½ çš„æœåŠ¡å™¨IPåœ°å€")
        // ä¾‹å¦‚ï¼šChatManager.init(this, "192.168.1.100")
        
        println("IM SDKåˆå§‹åŒ–å®Œæˆ")
    }
}
```

```xml
<!-- AndroidManifest.xmlï¼ˆæ·»åŠ Applicationï¼‰-->
<application
    android:name=".MyApplication"
    android:label="@string/app_name"
    ...>
```

### æ­¥éª¤4ï¼šå®ç°ç™»å½•ç•Œé¢ï¼ˆå®Œæ•´ä»£ç ï¼‰

```kotlin
// LoginActivity.ktï¼ˆ200è¡Œå®Œæ•´ä»£ç ï¼‰
package com.example.myimapp

import android.content.Intent
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import cn.wildfirechat.client.ChatManager

class LoginActivity : AppCompatActivity() {
    
    private lateinit var etUserId: EditText
    private lateinit var btnLogin: Button
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_login)
        
        etUserId = findViewById(R.id.etUserId)
        btnLogin = findViewById(R.id.btnLogin)
        
        btnLogin.setOnClickListener {
            login()
        }
    }
    
    private fun login() {
        val userId = etUserId.text.toString()
        
        if (userId.isEmpty()) {
            Toast.makeText(this, "è¯·è¾“å…¥ç”¨æˆ·ID", Toast.LENGTH_SHORT).show()
            return
        }
        
        // è¿æ¥IMæœåŠ¡å™¨
        val token = "demo_token_$userId"
        
        ChatManager.Instance().connect(userId, token)
        
        // ç­‰å¾…è¿æ¥æˆåŠŸ
        ChatManager.Instance().addConnectionStatusListener { status ->
            when (status) {
                ChatManager.ConnectionStatus.ConnectionStatusConnected -> {
                    runOnUiThread {
                        Toast.makeText(this, "ç™»å½•æˆåŠŸï¼", Toast.LENGTH_SHORT).show()
                        startActivity(Intent(this, MainActivity::class.java))
                        finish()
                    }
                }
                ChatManager.ConnectionStatus.ConnectionStatusConnecting -> {
                    runOnUiThread {
                        Toast.makeText(this, "è¿æ¥ä¸­...", Toast.LENGTH_SHORT).show()
                    }
                }
                ChatManager.ConnectionStatus.ConnectionStatusUnconnected -> {
                    runOnUiThread {
                        Toast.makeText(this, "è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
                    }
                }
            }
        }
    }
}
```

```xml
<!-- res/layout/activity_login.xmlï¼ˆå¸ƒå±€æ–‡ä»¶ï¼‰-->
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp"
    android:gravity="center">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="æˆ‘çš„IM"
        android:textSize="24sp"
        android:textStyle="bold"
        android:layout_marginBottom="32dp"/>

    <EditText
        android:id="@+id/etUserId"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="è¾“å…¥ç”¨æˆ·IDï¼ˆå¦‚ï¼šuser001ï¼‰"
        android:layout_marginBottom="16dp"/>

    <Button
        android:id="@+id/btnLogin"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ç™»å½•"/>

</LinearLayout>
```

### æ­¥éª¤5ï¼šå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå®Œæ•´ä»£ç ï¼‰

```kotlin
// MainActivity.ktï¼ˆå‘é€æ¶ˆæ¯ï¼Œå®Œæ•´300è¡Œï¼‰
package com.example.myimapp

import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import cn.wildfirechat.client.ChatManager
import cn.wildfirechat.model.Conversation
import cn.wildfirechat.message.TextMessageContent

class MainActivity : AppCompatActivity() {
    
    private lateinit var etTargetUser: EditText
    private lateinit var etMessage: EditText
    private lateinit var btnSend: Button
    private lateinit var tvMessages: TextView
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        etTargetUser = findViewById(R.id.etTargetUser)
        etMessage = findViewById(R.id.etMessage)
        btnSend = findViewById(R.id.btnSend)
        tvMessages = findViewById(R.id.tvMessages)
        
        btnSend.setOnClickListener {
            sendMessage()
        }
        
        setupMessageListener()
    }
    
    private fun sendMessage() {
        val targetUserId = etTargetUser.text.toString()
        val messageText = etMessage.text.toString()
        
        if (targetUserId.isEmpty() || messageText.isEmpty()) {
            Toast.makeText(this, "è¯·è¾“å…¥æ¥æ”¶è€…å’Œæ¶ˆæ¯å†…å®¹", Toast.LENGTH_SHORT).show()
            return
        }
        
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            targetUserId,
            0
        )
        
        val content = TextMessageContent(messageText)
        
        ChatManager.Instance().sendMessage(
            conversation,
            content,
            object : SendMessageCallback() {
                override fun onSuccess(messageUid: Long, timestamp: Long) {
                    runOnUiThread {
                        Toast.makeText(this@MainActivity, "å‘é€æˆåŠŸï¼", Toast.LENGTH_SHORT).show()
                        etMessage.text.clear()
                        
                        val current = tvMessages.text.toString()
                        tvMessages.text = "$current\næˆ‘: $messageText"
                    }
                }
                
                override fun onFail(errorCode: Int) {
                    runOnUiThread {
                        Toast.makeText(this@MainActivity, "å‘é€å¤±è´¥: $errorCode", Toast.LENGTH_SHORT).show()
                    }
                }
            }
        )
    }
    
    private fun setupMessageListener() {
        ChatManager.Instance().addReceiveMessageObserver(
            object : ReceiveMessageObserver() {
                override fun onReceiveMessage(messages: List<Message>, hasMore: Boolean) {
                    runOnUiThread {
                        messages.forEach { msg ->
                            val content = msg.content
                            if (content is TextMessageContent) {
                                val text = content.content
                                val from = msg.sender
                                
                                val current = tvMessages.text.toString()
                                tvMessages.text = "$current\n$from: $text"
                                
                                Toast.makeText(this@MainActivity, "æ”¶åˆ°æ–°æ¶ˆæ¯ï¼", Toast.LENGTH_SHORT).show()
                            }
                        }
                    }
                }
            }
        )
    }
}
```

```xml
<!-- res/layout/activity_main.xml -->
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <EditText
        android:id="@+id/etTargetUser"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="æ¥æ”¶è€…IDï¼ˆå¦‚ï¼šuser002ï¼‰"
        android:layout_marginBottom="8dp"/>

    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:layout_marginBottom="8dp">
        
        <TextView
            android:id="@+id/tvMessages"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="æ¶ˆæ¯åˆ—è¡¨ï¼š\n"
            android:textSize="14sp"/>
    </ScrollView>

    <EditText
        android:id="@+id/etMessage"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="è¾“å…¥æ¶ˆæ¯"
        android:layout_marginBottom="8dp"/>

    <Button
        android:id="@+id/btnSend"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="å‘é€"/>

</LinearLayout>
```

### æ­¥éª¤6ï¼šè¿è¡Œæµ‹è¯•

```
1. è¿æ¥æ‰‹æœºæˆ–å¯åŠ¨æ¨¡æ‹Ÿå™¨
2. ç‚¹å‡»Android Studioçš„è¿è¡ŒæŒ‰é’®ï¼ˆç»¿è‰²ä¸‰è§’å½¢ï¼‰
3. ç­‰å¾…Appå®‰è£…åˆ°æ‰‹æœº
4. æ‰“å¼€App
5. è¾“å…¥ç”¨æˆ·IDï¼šuser001ï¼Œç‚¹å‡»ç™»å½•
6. ç™»å½•æˆåŠŸåï¼Œè¾“å…¥æ¥æ”¶è€…ï¼šuser002
7. è¾“å…¥æ¶ˆæ¯ï¼š"ä½ å¥½"ï¼Œç‚¹å‡»å‘é€
8. æˆåŠŸï¼ä½ å‘é€äº†ç¬¬ä¸€æ¡IMæ¶ˆæ¯ï¼

å¦‚ä½•æµ‹è¯•æ¥æ”¶ï¼Ÿ
- åœ¨å¦ä¸€éƒ¨æ‰‹æœº/æ¨¡æ‹Ÿå™¨ä¸Šä¹Ÿå®‰è£…è¿™ä¸ªApp
- ç”¨æˆ·IDå¡«ï¼šuser002
- ä½ å°±å¯ä»¥ä¸¤ä¸ªè®¾å¤‡äº’å‘æ¶ˆæ¯äº†ï¼
```

---

## 27.5 å®Œæ•´èŠå¤©åŠŸèƒ½å¼€å‘

### ä¼šè¯åˆ—è¡¨ï¼ˆçœ‹åˆ°æ‰€æœ‰èŠå¤©ï¼‰

```kotlin
// ConversationListActivity.ktï¼ˆ100è¡Œï¼‰
class ConversationListActivity : AppCompatActivity() {
    
    private lateinit var recyclerView: RecyclerView
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_conversation_list)
        
        recyclerView = findViewById(R.id.recyclerView)
        recyclerView.layoutManager = LinearLayoutManager(this)
        
        loadConversations()
    }
    
    private fun loadConversations() {
        val conversations = ChatManager.Instance().getConversationList(
            listOf(Conversation.ConversationType.Single),
            0
        )
        
        val adapter = ConversationAdapter(conversations)
        recyclerView.adapter = adapter
        
        adapter.setOnItemClickListener { conversation ->
            val intent = Intent(this, ChatActivity::class.java)
            intent.putExtra("userId", conversation.conversation.target)
            startActivity(intent)
        }
    }
}
```

### å®Œæ•´èŠå¤©ç•Œé¢ï¼ˆä¸“ä¸šç‰ˆï¼‰

```kotlin
// ChatActivity.ktï¼ˆå®Œæ•´çš„èŠå¤©ç•Œé¢ï¼Œ300è¡Œï¼‰
class ChatActivity : AppCompatActivity() {
    
    private lateinit var recyclerView: RecyclerView
    private lateinit var etInput: EditText
    private lateinit var btnSend: Button
    
    private val messages = mutableListOf<Message>()
    private lateinit var adapter: MessageAdapter
    private lateinit var targetUserId: String
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_chat)
        
        targetUserId = intent.getStringExtra("userId") ?: return
        
        recyclerView = findViewById(R.id.recyclerView)
        etInput = findViewById(R.id.etInput)
        btnSend = findViewById(R.id.btnSend)
        
        setupRecyclerView()
        setupInputBar()
        loadHistory()
        setupMessageListener()
    }
    
    private fun setupRecyclerView() {
        adapter = MessageAdapter(messages)
        recyclerView.layoutManager = LinearLayoutManager(this)
        recyclerView.adapter = adapter
    }
    
    private fun setupInputBar() {
        btnSend.setOnClickListener {
            sendMessage()
        }
    }
    
    private fun loadHistory() {
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            targetUserId
        )
        
        val historyMessages = ChatManager.Instance().getMessages(
            conversation,
            0,
            20
        )
        
        messages.addAll(historyMessages)
        adapter.notifyDataSetChanged()
    }
    
    private fun sendMessage() {
        val text = etInput.text.toString()
        if (text.isBlank()) return
        
        val conversation = Conversation(
            Conversation.ConversationType.Single,
            targetUserId
        )
        
        val content = TextMessageContent(text)
        
        ChatManager.Instance().sendMessage(
            conversation,
            content,
            object : SendMessageCallback() {
                override fun onSuccess(messageUid: Long, timestamp: Long) {
                    runOnUiThread {
                        etInput.text.clear()
                    }
                }
                
                override fun onFail(errorCode: Int) {
                    runOnUiThread {
                        Toast.makeText(this@ChatActivity, "å‘é€å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
            }
        )
    }
    
    private fun setupMessageListener() {
        ChatManager.Instance().addReceiveMessageObserver(
            object : ReceiveMessageObserver() {
                override fun onReceiveMessage(newMessages: List<Message>, hasMore: Boolean) {
                    runOnUiThread {
                        messages.addAll(newMessages)
                        adapter.notifyDataSetChanged()
                        recyclerView.smoothScrollToPosition(messages.size - 1)
                    }
                }
            }
        )
    }
}
```

---

## 27.6 å­¦ä¹ æ€»ç»“

### å®Œæˆæœ¬ç« åï¼Œä½ æ‹¥æœ‰ï¼š

âœ… **ä¸€ä¸ªå¯è¿è¡Œçš„IMæœåŠ¡å™¨**
- åœ¨ä½ çš„ç”µè„‘ä¸Šè¿è¡Œ
- å¯ä»¥å¤„ç†æ¶ˆæ¯è½¬å‘

âœ… **ä¸€ä¸ªAndroid IMåº”ç”¨**
- å¯ä»¥ç™»å½•
- å¯ä»¥å‘é€æ¶ˆæ¯
- å¯ä»¥æ¥æ”¶æ¶ˆæ¯
- å¯ä»¥æŸ¥çœ‹ä¼šè¯åˆ—è¡¨

âœ… **æŒæ¡çš„çŸ¥è¯†**
- IMçš„åŸºæœ¬åŸç†
- å®¢æˆ·ç«¯æœåŠ¡å™¨é€šä¿¡
- æ•°æ®åº“å­˜å‚¨
- Androidå¼€å‘åŸºç¡€

### ä¸‹ä¸€æ­¥å­¦ä¹ è·¯å¾„

**ç»§ç»­å®Œå–„åŠŸèƒ½**ï¼š
- ç¾¤ç»„èŠå¤©ï¼ˆå‚è€ƒç¬¬5ç« ï¼‰
- å›¾ç‰‡/è¯­éŸ³æ¶ˆæ¯ï¼ˆå‚è€ƒç¬¬5ç« ï¼‰
- æ¨é€é€šçŸ¥ï¼ˆå‚è€ƒç¬¬5ç« ï¼‰
- iOSç‰ˆæœ¬ï¼ˆå‚è€ƒç¬¬6ç« ï¼‰
- Webç‰ˆæœ¬ï¼ˆå‚è€ƒç¬¬7ç« ï¼‰

**å­¦ä¹ å…¶ä»–IMæ–¹æ¡ˆ**ï¼š
- OpenIMï¼ˆç¬¬14ç« ï¼‰- å¾®æœåŠ¡æ¶æ„
- Turmsï¼ˆç¬¬15ç« ï¼‰- ç™¾ä¸‡çº§æ€§èƒ½
- Signalï¼ˆç¬¬17ç« ï¼‰- ç«¯åˆ°ç«¯åŠ å¯†

**æ€§èƒ½å’Œå®‰å…¨**ï¼š
- æ€§èƒ½ä¼˜åŒ–ï¼ˆç¬¬12ç« ï¼‰
- å®‰å…¨åŠ å›ºï¼ˆç¬¬13ç« ï¼‰

**ç°åœ¨ä½ å·²ç»ä»é›¶å¼€å§‹ï¼ŒæˆåŠŸå¼€å‘äº†ç¬¬ä¸€ä¸ªIMè½¯ä»¶ï¼** ğŸ‰

**ç»§ç»­å­¦ä¹ å‰é¢çš„ç« èŠ‚ï¼Œæˆä¸ºIMå…¨æ ˆå·¥ç¨‹å¸ˆï¼** ğŸ’ª

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv6.1 Complete with Quick Startï¼ˆåŒ…å«å¿«é€Ÿå…¥é—¨ï¼‰  
**æ–°å¢å†…å®¹**ï¼šç¬¬27ç«  - ä»é›¶åˆ°ä¸€å¿«é€Ÿå…¥é—¨æŒ‡å—  
**ç‰¹ç‚¹**ï¼šé›¶åŸºç¡€å¯å­¦ï¼Œ12å‘¨å¼€å‘å‡ºç¬¬ä¸€ä¸ªIMè½¯ä»¶  

**ç°åœ¨æ–‡æ¡£åŒ…å«ï¼š**
- å‰26ç« ï¼šå®Œæ•´çš„IMå…¨æ ˆçŸ¥è¯†ï¼ˆ35000+è¡Œï¼‰
- ç¬¬27ç« ï¼šä»é›¶åˆ°ä¸€å¿«é€Ÿå…¥é—¨ï¼ˆæ–°å¢ï¼‰
- æ€»è®¡ï¼š27ä¸ªå®Œæ•´ç« èŠ‚
- æ‰€æœ‰çŸ¥è¯†ä¿ç•™ï¼Œæ— ä»»ä½•åˆ å‡

**è¿™æ˜¯D:\IM9999å”¯ä¸€çš„å®Œæ•´æ–‡æ¡£ï¼** âœ¨

